<script>
/**
 * GROUPS MODULE V4 - LOADER
 * Connecte l'interface triptyque au bouton Groupes du header
 * et fait le pont avec l'algorithme de r√©partition
 */

(function() {
  'use strict';

  console.log('üîå Initialisation du module Groupes V4...');

  // Container plein √©cran pour l'interface
  let moduleContainer = null;

  // Cache pour les donn√©es FIN
  let finSheetsDataCache = null;

  const DEFAULT_CRITERIA_WEIGHTS = { com: 1, tra: 1, part: 1, abs: 1 };

  function sanitizeCriteriaWeights(weights = {}) {
    const sanitized = { ...DEFAULT_CRITERIA_WEIGHTS };

    if (!weights || typeof weights !== 'object') {
      return sanitized;
    }

    ['com', 'tra', 'part', 'abs'].forEach(key => {
      const value = parseFloat(weights[key]);
      if (!Number.isNaN(value) && Number.isFinite(value)) {
        sanitized[key] = value;
      }
    });

    return sanitized;
  }

  /**
   * Charge les donn√©es depuis les onglets FIN avec scores (colonnes U et V)
   */
  async function loadFINData() {
    if (finSheetsDataCache) {
      console.log('üì¶ Utilisation du cache FIN');
      return finSheetsDataCache;
    }

    console.log('üì° Chargement des onglets FIN avec SCORE F (col U) et SCORE M (col V)...');

    try {
      const result = await gsRun('loadFINSheetsWithScores');

      if (!result || !result.success || !result.data) {
        console.error('‚ùå loadFINSheetsWithScores a retourn√© un format invalide:', result);
        return null;
      }

      // Extraire les donn√©es (result.data contient { "6¬∞1FIN": { eleves: [...] }, ... })
      finSheetsDataCache = result.data;
      console.log('‚úÖ Donn√©es FIN charg√©es:', Object.keys(result.data));
      return result.data;
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement des onglets FIN:', error);
      return null;
    }
  }

  // ========== SYST√àME DE REPORTING CENTRALIS√â ==========
  const ErrorReporter = {
    errors: [],
    warnings: [],
    uiBannerElement: null,

    error(context, message, data = null) {
      const entry = { context, message, data, timestamp: new Date().toISOString(), type: 'error' };
      this.errors.push(entry);
      console.error(`‚ùå [${context}] ${message}`, data || '');
      this.updateUIBanner();
      return entry;
    },

    warn(context, message, data = null) {
      const entry = { context, message, data, timestamp: new Date().toISOString(), type: 'warning' };
      this.warnings.push(entry);
      console.warn(`‚ö†Ô∏è [${context}] ${message}`, data || '');
      this.updateUIBanner();
      return entry;
    },

    info(context, message, data = null) {
      console.log(`‚ÑπÔ∏è [${context}] ${message}`, data || '');
    },

    getReport() {
      return {
        errors: this.errors,
        warnings: this.warnings,
        summary: `${this.errors.length} erreur(s), ${this.warnings.length} avertissement(s)`
      };
    },

    clear() {
      this.errors = [];
      this.warnings = [];
      this.updateUIBanner();
    },

    /**
     * Cr√©e ou met √† jour le bandeau UI d'erreurs/avertissements
     * Bandeau contextualis√© pour utilisateurs non-techniques
     */
    updateUIBanner() {
      // Si aucune erreur/warning, masquer le bandeau
      if (this.errors.length === 0 && this.warnings.length === 0) {
        if (this.uiBannerElement) {
          this.uiBannerElement.style.display = 'none';
        }
        return;
      }

      // Si le bandeau n'existe pas, le cr√©er
      if (!this.uiBannerElement) {
        this.uiBannerElement = document.createElement('div');
        this.uiBannerElement.id = 'error-reporter-banner';
        this.uiBannerElement.style.cssText = `
          position: fixed;
          top: 16px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 10001;
          max-width: 800px;
          width: 90%;
          border-radius: 8px;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
          font-family: Arial, sans-serif;
          animation: slideDown 0.3s ease-out;
        `;

        // Animation CSS
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(this.uiBannerElement);
      }

      // D√©terminer la s√©v√©rit√© (erreur > warning)
      const hasErrors = this.errors.length > 0;
      const severity = hasErrors ? 'error' : 'warning';

      // Couleurs selon s√©v√©rit√©
      const colors = {
        error: {
          bg: '#fef2f2',
          border: '#ef4444',
          text: '#991b1b',
          icon: '‚ùå'
        },
        warning: {
          bg: '#fffbeb',
          border: '#f59e0b',
          text: '#92400e',
          icon: '‚ö†Ô∏è'
        }
      };

      const color = colors[severity];
      const report = this.getReport();

      // Construire le HTML du bandeau
      this.uiBannerElement.innerHTML = `
        <div style="
          background: ${color.bg};
          border: 2px solid ${color.border};
          border-radius: 8px;
          padding: 16px 20px;
        ">
          <!-- En-t√™te avec r√©sum√© -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 24px;">${color.icon}</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: ${color.text};">
                  ${hasErrors ? 'Erreurs de chargement' : 'Avertissements'}
                </div>
                <div style="font-size: 14px; color: ${color.text}; opacity: 0.8;">
                  ${report.summary}
                </div>
              </div>
            </div>
            <button id="banner-close-btn" style="
              background: transparent;
              border: none;
              cursor: pointer;
              font-size: 20px;
              color: ${color.text};
              padding: 4px 8px;
              opacity: 0.7;
              transition: opacity 0.2s;
            " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
              ‚úï
            </button>
          </div>

          <!-- D√©tails (max 5 premiers messages) -->
          <div style="
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: #374151;
          ">
            ${this.errors.slice(0, 5).map(e => `
              <div style="margin-bottom: 8px; padding: 8px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                <strong style="color: #991b1b;">Erreur:</strong> ${this.escapeHtml(e.message)}
              </div>
            `).join('')}
            ${this.warnings.slice(0, 5).map(w => `
              <div style="margin-bottom: 8px; padding: 8px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">
                <strong style="color: #92400e;">Avertissement:</strong> ${this.escapeHtml(w.message)}
              </div>
            `).join('')}
            ${(this.errors.length + this.warnings.length > 5) ? `
              <div style="text-align: center; margin-top: 8px; color: #6b7280; font-size: 12px;">
                ... et ${this.errors.length + this.warnings.length - 5} autre(s) message(s) (voir console)
              </div>
            ` : ''}
          </div>

          <!-- Actions -->
          <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
            <button id="banner-console-btn" style="
              padding: 6px 12px;
              background: #f3f4f6;
              border: 1px solid #d1d5db;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              color: #374151;
              transition: all 0.2s;
            " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
              üìã Voir console
            </button>
            ${hasErrors ? `
              <button id="banner-reload-btn" style="
                padding: 6px 12px;
                background: #ef4444;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                color: white;
                font-weight: 600;
                transition: all 0.2s;
              " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                üîÑ R√©essayer
              </button>
            ` : ''}
          </div>
        </div>
      `;

      this.uiBannerElement.style.display = 'block';

      // Attacher les √©v√©nements
      const closeBtn = this.uiBannerElement.querySelector('#banner-close-btn');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          this.uiBannerElement.style.display = 'none';
        });
      }

      const consoleBtn = this.uiBannerElement.querySelector('#banner-console-btn');
      if (consoleBtn) {
        consoleBtn.addEventListener('click', () => {
          console.group('üìä Rapport ErrorReporter d√©taill√©');
          console.log('R√©sum√©:', report.summary);
          if (this.errors.length > 0) {
            console.group('‚ùå Erreurs (' + this.errors.length + ')');
            this.errors.forEach(e => console.error(`[${e.context}]`, e.message, e.data || ''));
            console.groupEnd();
          }
          if (this.warnings.length > 0) {
            console.group('‚ö†Ô∏è Avertissements (' + this.warnings.length + ')');
            this.warnings.forEach(w => console.warn(`[${w.context}]`, w.message, w.data || ''));
            console.groupEnd();
          }
          console.groupEnd();
        });
      }

      const reloadBtn = this.uiBannerElement.querySelector('#banner-reload-btn');
      if (reloadBtn) {
        reloadBtn.addEventListener('click', () => {
          this.clear();
          if (window.openModuleGroupsV4) {
            // Fermer et r√©ouvrir le module
            if (window.closeModuleGroupsV4) {
              window.closeModuleGroupsV4();
            }
            setTimeout(() => window.openModuleGroupsV4(), 300);
          }
        });
      }
    },

    /**
     * √âchappe les caract√®res HTML pour √©viter XSS
     */
    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    },

    displayToUser() {
      // Cette m√©thode est maintenant remplac√©e par updateUIBanner()
      // mais on la garde pour compatibilit√©
      this.updateUIBanner();
    }
  };

  // ========== VALIDATION ET NORMALISATION DES DONN√âES ==========

  /**
   * V√©rifie si un objet ressemble √† un √©l√®ve valide
   * @param {*} obj - Objet √† v√©rifier
   * @returns {boolean} true si l'objet est un √©l√®ve valide
   */
  function isStudentLike(obj) {
    if (!obj || typeof obj !== 'object') {
      return false;
    }

    // Un √©l√®ve DOIT avoir un ID
    if (!obj.id || typeof obj.id !== 'string' || obj.id.trim() === '') {
      return false;
    }

    // Optionnel mais recommand√© : nom et pr√©nom
    const hasName = (obj.nom || obj.prenom);

    // Accepter si au moins l'ID est pr√©sent
    return true;
  }

  /**
   * Collecte r√©cursivement tous les objets √©l√®ves dans une structure de donn√©es
   * Parcourt en profondeur pour g√©rer des imbrications complexes (Apps Script)
   * @param {*} data - Structure de donn√©es √† parcourir
   * @param {Set} seen - Set des IDs d√©j√† vus (pour d√©duplication)
   * @param {number} depth - Profondeur actuelle (limite √† 10 pour √©viter boucles infinies)
   * @returns {Array} Tableau d'objets √©l√®ves d√©dupliqu√©s
   */
  function collectStudentsRecursive(data, seen = new Set(), depth = 0) {
    const MAX_DEPTH = 10;
    const students = [];

    // Garde contre r√©cursion infinie
    if (depth > MAX_DEPTH) {
      ErrorReporter.warn('collectStudentsRecursive', `Profondeur maximale atteinte (${MAX_DEPTH})`);
      return students;
    }

    // Cas null/undefined
    if (data == null) {
      return students;
    }

    // Cas primitif (string, number, boolean)
    if (typeof data !== 'object') {
      return students;
    }

    // Cas tableau
    if (Array.isArray(data)) {
      data.forEach((item, index) => {
        // Si c'est un √©l√®ve, l'ajouter
        if (isStudentLike(item)) {
          // D√©duplication par ID
          if (!seen.has(item.id)) {
            seen.add(item.id);
            students.push(item);
          }
        } else {
          // Sinon, parcourir r√©cursivement
          const nested = collectStudentsRecursive(item, seen, depth + 1);
          students.push(...nested);
        }
      });
      return students;
    }

    // Cas objet
    if (typeof data === 'object') {
      // Si l'objet lui-m√™me est un √©l√®ve
      if (isStudentLike(data)) {
        if (!seen.has(data.id)) {
          seen.add(data.id);
          students.push(data);
        }
        return students;
      }

      // Sinon, parcourir toutes les propri√©t√©s
      Object.keys(data).forEach(key => {
        const value = data[key];
        const nested = collectStudentsRecursive(value, seen, depth + 1);
        students.push(...nested);
      });

      return students;
    }

    return students;
  }

  /**
   * Pr√©pare un √©l√®ve pour l'algorithme V4 avec gardes renforc√©es et valeurs de repli
   * TOUS les champs critiques pour l'algorithme sont valid√©s et normalis√©s
   * @param {Object} student - Objet √©l√®ve brut
   * @param {string} className - Nom de la classe (pour contexte)
   * @returns {Object} √âl√®ve normalis√© avec tous les champs requis
   */
  function prepareStudentForAlgorithm(student, className) {
    // ========== CHAMPS IDENTIT√â ==========
    const id = String(student.id || '').trim();
    const firstName = String(student.prenom || student.firstName || '').trim();
    const lastName = String(student.nom || student.lastName || '').trim();

    // ========== SEXE (CRITIQUE POUR PARIT√â) ==========
    let sexe = String(student.sexe || student.gender || 'M').trim().toUpperCase();
    // Normaliser : accepter F/M/FEMME/HOMME/FILLE/GARCON
    if (sexe.startsWith('F') || sexe === 'FEMME' || sexe === 'FILLE') {
      sexe = 'F';
    } else if (sexe.startsWith('M') || sexe === 'HOMME' || sexe === 'GARCON') {
      sexe = 'M';
    } else {
      // Valeur invalide ‚Üí warning et fallback M
      ErrorReporter.warn('prepareStudentForAlgorithm',
        `Classe ${className}: √©l√®ve ${id} a un sexe invalide "${sexe}", fallback sur M`
      );
      sexe = 'M';
    }

    // ========== SCORES ACAD√âMIQUES (CRITIQUES POUR Z-SCORES V4) ==========
    // Extraction multi-source avec VALIDATION STRICTE et reporting
    const extractScore = (sources, fieldName, defaultValue = 0, min = 0, max = 4) => {
      for (const source of sources) {
        const value = parseFloat(source);
        if (!isNaN(value) && isFinite(value)) {
          // VALIDATION STRICTE : valeur dans les bornes ?
          const originalValue = value;
          const clampedValue = Math.max(min, Math.min(max, value));

          // AVERTISSEMENT si valeur hors bornes (aberration)
          if (originalValue !== clampedValue) {
            ErrorReporter.warn('extractScore',
              `Classe ${className}, √©l√®ve ${id}: ${fieldName} hors bornes [${min}, ${max}] ‚Üí valeur ${originalValue.toFixed(2)} clamp√©e √† ${clampedValue.toFixed(2)}`,
              { studentId: id, field: fieldName, original: originalValue, clamped: clampedValue }
            );
          }

          // AVERTISSEMENT si valeur aberrante (n√©gative pour scores positifs)
          if (min >= 0 && originalValue < 0) {
            ErrorReporter.warn('extractScore',
              `Classe ${className}, √©l√®ve ${id}: ${fieldName} n√©gatif (${originalValue.toFixed(2)}) ‚Üí risque de biais dans z-scores`,
              { studentId: id, field: fieldName, value: originalValue }
            );
          }

          // AVERTISSEMENT si valeur extr√™me (> 2x max)
          if (originalValue > max * 2) {
            ErrorReporter.warn('extractScore',
              `Classe ${className}, √©l√®ve ${id}: ${fieldName} valeur extr√™me (${originalValue.toFixed(2)}, max attendu ${max}) ‚Üí risque de corruption donn√©es`,
              { studentId: id, field: fieldName, value: originalValue }
            );
          }

          return clampedValue;
        }
      }
      return defaultValue;
    };

    const scoreF = extractScore([
      student.scoreF,
      student.scores?.F,
      student.scores?.SCOREF,
      student.besoinsF
    ], 'scoreF');

    const scoreM = extractScore([
      student.scoreM,
      student.scores?.M,
      student.scores?.SCOREM,
      student.besoinsM
    ], 'scoreM');

    // ========== CRIT√àRES COMPORTEMENTAUX (POUR Z-SCORES V4) ==========
    const com = extractScore([student.scores?.COM, student.com], 'COM');
    const tra = extractScore([student.scores?.TRA, student.tra], 'TRA');
    const part = extractScore([student.scores?.PART, student.part], 'PART');
    const abs = extractScore([student.scores?.ABS, student.abs], 'ABS');

    // ========== LV2 (POUR CRIT√àRES OPTIONNELS) ==========
    let lv2 = String(student.lv2 || student.LV2 || 'ESP').trim().toUpperCase();
    // Normaliser les abr√©viations
    const lv2Map = {
      'ESPAGNOL': 'ESP', 'ESPA': 'ESP', 'SPA': 'ESP',
      'ALLEMAND': 'ALL', 'ALLEM': 'ALL', 'GER': 'ALL',
      'ITALIEN': 'ITA', 'ITAL': 'ITA',
      'ANGLAIS': 'ANG', 'ANGL': 'ANG', 'ENG': 'ANG'
    };
    lv2 = lv2Map[lv2] || lv2;

    // ========== OPTIONS (POUR QUOTAS) ==========
    let options = student.options || [];
    if (!Array.isArray(options)) {
      if (typeof options === 'string') {
        options = options.split(',').map(o => o.trim()).filter(Boolean);
      } else {
        options = [];
      }
    }
    // Normaliser en majuscules
    options = options.map(opt => String(opt).toUpperCase());

    // ========== CONSTRUIRE L'OBJET NORMALIS√â ==========
    const normalized = {
      // Identit√©
      id,
      firstName,
      lastName,
      class: className,

      // Sexe (format dual pour compatibilit√©)
      sexe,
      gender: sexe,

      // Scores acad√©miques (CRITIQUES)
      scoreF,
      scoreM,
      score: scoreF,  // Alias pour compatibilit√©

      // Crit√®res comportementaux
      com,
      tra,
      part,
      abs,

      // Autres
      lv2,
      options,
      SOURCE: student.SOURCE || student.source || student._SOURCE_CLASS || className, // ‚úÖ Classe d'origine (colonne O)

      // Objet scores consolid√©
      scores: {
        F: scoreF,
        M: scoreM,
        COM: com,
        TRA: tra,
        PART: part,
        ABS: abs
      }
    };

    // ========== VALIDATIONS FINALES ==========
    // Avertir si scores acad√©miques absents
    if (scoreF === 0 && scoreM === 0) {
      ErrorReporter.warn('prepareStudentForAlgorithm',
        `Classe ${className}: √©l√®ve ${id} sans scores acad√©miques (scoreF et scoreM √† 0) ‚Üí impact z-scores V4 nul`
      );
    }

    // Avertir si nom/pr√©nom manquants
    if (!firstName && !lastName) {
      ErrorReporter.warn('prepareStudentForAlgorithm',
        `Classe ${className}: √©l√®ve ${id} sans nom ni pr√©nom`
      );
    }

    return normalized;
  }

  /**
   * Harmonise les propri√©t√©s critiques d'un √©l√®ve pour l'affichage/export
   * (alias nom/pr√©nom, LV2 normalis√©e, options en tableau, SOURCE fiable, scores num√©riques)
   * @param {Object} student
   * @returns {Object|null}
   */
  function normalizeStudentForResults(student) {
    if (!student) return null;

    const coerceNumber = (...values) => {
      for (const value of values) {
        if (value === undefined || value === null || value === '') continue;
        const num = parseFloat(value);
        if (!isNaN(num) && isFinite(num)) {
          return num;
        }
      }
      return 0;
    };

    const normalizeOptionsArray = () => {
      if (Array.isArray(student.options)) {
        return student.options;
      }
      if (Array.isArray(student.optionsList)) {
        return student.optionsList;
      }
      const rawOptions = student.opt || student.optionsRaw || student.optionsString || student.options;
      if (typeof rawOptions === 'string' && rawOptions.trim() !== '') {
        return rawOptions.split(/[;,/]/).map(opt => opt.trim()).filter(Boolean);
      }
      return [];
    };

    const lastName = String(student.lastName || student.nom || '').trim();
    const firstName = String(student.firstName || student.prenom || '').trim();
    const classe = String(student.class || student.classe || student.className || '').trim();
    const sourceClass = String(student.SOURCE || student.source || student._SOURCE_CLASS || classe).trim() || classe;
    const lv2 = (student.lv2 || student.LV2 || '').toString().trim().toUpperCase() || 'ESP';
    const sexe = (student.sexe || student.gender || '').toString().trim().toUpperCase();

    const optionsArray = normalizeOptionsArray().map(opt => opt.toString().trim()).filter(Boolean);
    const normalizedOptions = optionsArray.map(opt => opt.toUpperCase());
    const optionsString = typeof student.opt === 'string' && student.opt.trim() !== ''
      ? student.opt.trim()
      : normalizedOptions.join(';');

    const scoreF = coerceNumber(student.scoreF, student.scores?.F, student.scores?.SCOREF, student.besoinsF);
    const scoreM = coerceNumber(student.scoreM, student.scores?.M, student.scores?.SCOREM, student.besoinsM);
    const com = coerceNumber(student.com, student.scores?.COM);
    const tra = coerceNumber(student.tra, student.scores?.TRA);
    const part = coerceNumber(student.part, student.scores?.PART);
    const abs = coerceNumber(student.abs, student.scores?.ABS);

    return {
      ...student,
      id: (student.id || '').toString().trim(),
      lastName,
      nom: lastName,
      firstName,
      prenom: firstName,
      sexe,
      gender: sexe,
      class: classe,
      classe,
      className: student.className || classe,
      SOURCE: sourceClass,
      source: sourceClass,
      _SOURCE_CLASS: sourceClass,
      lv2,
      LV2: lv2,
      opt: optionsString,
      options: normalizedOptions,
      optionsList: normalizedOptions,
      scores: {
        F: scoreF,
        M: scoreM,
        COM: com,
        TRA: tra,
        PART: part,
        ABS: abs
      },
      scoreF,
      scoreM,
      com,
      tra,
      part,
      abs
    };
  }

  if (typeof window !== 'undefined') {
    window.GroupsModuleV4Utils = window.GroupsModuleV4Utils || {};
    window.GroupsModuleV4Utils.normalizeStudentForResults = normalizeStudentForResults;
  }

  /**
   * Normalise les donn√©es d'une classe depuis le format FIN
   * UTILISE COLLECTE R√âCURSIVE pour g√©rer les structures complexes
   * @param {string} className - Nom de la classe
   * @param {*} classData - Donn√©es brutes de la classe
   * @returns {Array|null} Tableau d'√©l√®ves normalis√©s ou null si invalide
   */
  function normalizeClassStudents(className, classData) {
    if (!classData) {
      ErrorReporter.error('normalizeClassStudents', `Classe ${className}: donn√©es nulles ou undefined`);
      return null;
    }

    // ========== COLLECTE R√âCURSIVE ET D√âDUPLIQU√âE ==========
    ErrorReporter.info('normalizeClassStudents', `Classe ${className}: d√©but collecte r√©cursive`);
    const students = collectStudentsRecursive(classData);

    if (students.length === 0) {
      ErrorReporter.error('normalizeClassStudents',
        `Classe ${className}: aucun √©l√®ve trouv√© apr√®s collecte r√©cursive`,
        { dataType: typeof classData, isArray: Array.isArray(classData) }
      );
      return null;
    }

    ErrorReporter.info('normalizeClassStudents',
      `Classe ${className}: ${students.length} √©l√®ve(s) collect√©(s) (d√©dupliqu√©s)`
    );

    // ========== PR√âPARATION POUR ALGORITHME V4 ==========
    const normalized = [];
    let skippedCount = 0;

    students.forEach((student, index) => {
      try {
        const prepared = prepareStudentForAlgorithm(student, className);
        normalized.push(prepared);
      } catch (error) {
        ErrorReporter.error('normalizeClassStudents',
          `Classe ${className}: erreur pr√©paration √©l√®ve #${index} (${student.id || 'ID inconnu'})`,
          { error: error.message, stack: error.stack }
        );
        skippedCount++;
      }
    });

    // ========== RAPPORT FINAL ==========
    if (skippedCount > 0) {
      ErrorReporter.warn('normalizeClassStudents',
        `Classe ${className}: ${skippedCount} √©l√®ve(s) ignor√©(s) sur ${students.length} (erreur pr√©paration)`
      );
    }

    ErrorReporter.info('normalizeClassStudents',
      `Classe ${className}: ${normalized.length} √©l√®ve(s) pr√™ts pour algorithme V4`
    );

    return normalized.length > 0 ? normalized : null;
  }

  /**
   * R√©cup√®re les donn√©es des classes depuis les onglets FIN (avec scores acad√©miques)
   * IMPORTANT: Cette fonction charge DIRECTEMENT depuis les onglets FIN pour avoir
   * acc√®s aux colonnes SCORE F (U) et SCORE M (V)
   */
  function getClassesData() {
    // R√©initialiser le rapport d'erreurs
    ErrorReporter.clear();

    // Si nous avons d√©j√† charg√© les donn√©es FIN en cache, les utiliser
    if (finSheetsDataCache) {
      ErrorReporter.info('getClassesData', 'Utilisation des donn√©es FIN en cache');

      const formattedData = {};

      Object.keys(finSheetsDataCache).forEach(className => {
        const classData = finSheetsDataCache[className];

        // Utiliser la fonction de normalisation
        const normalizedStudents = normalizeClassStudents(className, classData);

        if (normalizedStudents && normalizedStudents.length > 0) {
          formattedData[className] = normalizedStudents;
        } else {
          ErrorReporter.warn('getClassesData',
            `Classe ${className} ignor√©e (aucun √©l√®ve valide apr√®s normalisation)`
          );
        }
      });

      // Afficher le rapport
      ErrorReporter.info('getClassesData',
        `Donn√©es FIN format√©es: ${Object.keys(formattedData).length} classe(s)`
      );
      ErrorReporter.info('getClassesData',
        'D√©tail: ' + Object.entries(formattedData).map(([c, eleves]) => `${c}: ${eleves.length} √©l√®ves`).join(', ')
      );

      // Afficher les erreurs/warnings √† l'utilisateur si n√©cessaire
      if (ErrorReporter.errors.length > 0) {
        ErrorReporter.displayToUser();
      }

      return formattedData;
    }

    // Sinon, fallback sur STATE.students (mode legacy)
    if (!window.STATE || !window.STATE.students) {
      console.error('‚ùå window.STATE.students non disponible et pas de cache FIN');
      return null;
    }

    console.warn('‚ö†Ô∏è Fallback sur STATE.students (peut ne pas contenir les scores acad√©miques)');

    // Extraire les classes depuis les zones droppables du DOM
    const zones = document.querySelectorAll('.droppable-zone[data-classe]');
    const classesData = {};

    zones.forEach(zone => {
      const className = zone.getAttribute('data-classe');
      if (!className) return;

      classesData[className] = [];

      // R√©cup√©rer les cartes √©l√®ves dans cette zone
      const cards = zone.querySelectorAll('.student-card');

      cards.forEach(card => {
        const studentId = card.getAttribute('data-id') || card.getAttribute('data-student-id');
        if (!studentId) return;

        // R√©cup√©rer les donn√©es compl√®tes depuis STATE
        const student = window.STATE.students[studentId];

        if (student) {
          // Extraire TOUS les champs n√©cessaires pour l'algorithme V4
          classesData[className].push({
            id: student.id || studentId,
            firstName: student.firstName || student.prenom || '',
            lastName: student.lastName || student.nom || '',
            class: className,

            // SEXE (colonne E)
            sexe: (student.sexe || student.gender || 'M').toUpperCase(),
            gender: student.gender || student.sexe || 'M',

            // CRIT√àRES COMPORTEMENTAUX
            com: student.com || student.COM || 0,        // Colonne H
            tra: student.tra || student.TRA || 0,        // Colonne I
            part: student.part || student.PART || 0,     // Colonne J
            abs: student.abs || student.ABS || 0,        // Colonne K

            // SCORES ACAD√âMIQUES
            scoreF: student.scoreF || student.scores?.F || 0,  // Colonne U (1-4)
            scoreM: student.scoreM || student.scores?.M || 0,  // Colonne V (1-4)
            score: student.score || student.scoreF || student.scoreM || 0,

            // AUTRES DONN√âES
            // Colonne F : LV2 (ESP par d√©faut si vide)
            lv2: (student.lv2 || student.LV2 || 'ESP').toUpperCase(),
            options: student.options || [],
            scores: student.scores || {}
          });
        }
      });
    });

    console.log('üìä Donn√©es des classes extraites:', Object.keys(classesData));
    console.log('üìä D√©tail:', Object.entries(classesData).map(([c, eleves]) => `${c}: ${eleves.length} √©l√®ves`));

    return classesData;
  }

  /**
   * V√©rifie que les donn√©es sont disponibles
   */
  function validateData() {
    const classesData = getClassesData();

    if (!classesData || Object.keys(classesData).length === 0) {
      console.error('‚ùå Aucune classe trouv√©e dans STATE');
      console.log('Diagnostic :');
      console.log('- STATE existe :', !!window.STATE);
      console.log('- STATE.students existe :', !!window.STATE?.students);
      console.log('- Nombre d\'√©l√®ves :', Object.keys(window.STATE?.students || {}).length);
      return false;
    }

    return true;
  }

  /**
   * Ouvre l'interface du module Groupes V4
   * CHARGE AUTOMATIQUEMENT LES ONGLETS FIN AVEC SCORES (colonnes U et V)
   */
  async function openModuleGroupsV4(mode) {
    // üîí GARDE : Emp√™cher ouvertures multiples simultan√©es
    if (moduleContainer && moduleContainer.style.display !== 'none') {
      console.warn('‚ö†Ô∏è Module Groupes d√©j√† ouvert, abandon');
      return;
    }

    console.log('üöÄ Ouverture du module Groupes V4, mode:', mode);

    // V√©rifier les d√©pendances
    if (!window.GroupsInterfaceV4) {
      console.error('‚ùå GroupsInterfaceV4 non charg√©');
      alert('Erreur : Interface Groupes V4 non disponible');
      return;
    }

    if (!window.GroupsAlgorithmV4) {
      console.error('‚ùå GroupsAlgorithmV4 non charg√©');
      alert('Erreur : Algorithme Groupes V4 non disponible');
      return;
    }

    // üßπ NETTOYAGE : Supprimer l'ancien container s'il existe
    if (moduleContainer) {
      moduleContainer.remove();
      moduleContainer = null;
    }

    // Cr√©er le container plein √©cran
    if (!moduleContainer) {
      moduleContainer = document.createElement('div');
      moduleContainer.id = 'groups-v4-container';
      moduleContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        background: white;
      `;

      // Ajouter un bouton de fermeture
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Fermer';
      closeBtn.style.cssText = `
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 10000;
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      `;
      closeBtn.addEventListener('click', closeModuleGroupsV4);

      moduleContainer.appendChild(closeBtn);
      document.body.appendChild(moduleContainer);
    }

    // Afficher un loader pendant le chargement des donn√©es
    const loaderId = 'groups-data-loader';
    if (!document.getElementById(loaderId)) {
      const loader = document.createElement('div');
      loader.id = loaderId;
      loader.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          font-family: Arial, sans-serif;
        ">
          <div style="
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
          "></div>
          <p style="color: #6b7280; font-size: 16px;">Chargement des donn√©es des √©l√®ves...</p>
          <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">Extraction des scores depuis les onglets FIN</p>
        </div>
        <style>
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        </style>
      `;
      moduleContainer.appendChild(loader);
    }

    // Afficher le container imm√©diatement avec le loader
    moduleContainer.style.display = 'block';
    console.log('‚úÖ Interface affich√©e imm√©diatement avec loader');

    // üîë CHARGER LES DONN√âES FIN EN ARRI√àRE-PLAN (non bloquant)
    console.log('üì° Chargement des onglets FIN avec SCORE F (colonne U) et SCORE M (colonne V)...');

    loadFINData().then(finData => {
      // Supprimer le loader
      const loaderElement = document.getElementById(loaderId);
      if (loaderElement) {
        loaderElement.remove();
      }

      if (!finData || Object.keys(finData).length === 0) {
        console.error('‚ùå Aucune donn√©e FIN charg√©e');

        // Fallback sur STATE.students
        console.warn('‚ö†Ô∏è Fallback sur STATE.students...');

        // V√©rifier que STATE.students est charg√©
        if (!window.STATE || !window.STATE.students || Object.keys(window.STATE.students).length === 0) {
          alert('Erreur : Les donn√©es des √©l√®ves ne sont pas encore charg√©es. Veuillez attendre la fin du chargement et r√©essayer.');
          console.error('‚ùå STATE.students vide ou non charg√©');
          closeModuleGroupsV4();
          return;
        }

        // Valider les donn√©es
        if (!validateData()) {
          alert('Erreur : Aucune classe disponible. Veuillez charger des donn√©es d\'abord.');
          closeModuleGroupsV4();
          return;
        }
      } else {
        console.log('‚úÖ Donn√©es FIN charg√©es avec succ√®s:', Object.keys(finData).length, 'classes');
      }

      // Rendre l'interface triptyque une fois les donn√©es charg√©es
      window.GroupsInterfaceV4.renderInitialStructure(moduleContainer);

      // Initialiser les tooltips sur les crit√®res
      if (window.UIComponents && window.UIComponents.Tooltip) {
        window.UIComponents.Tooltip.init();
        console.log('‚úÖ Tooltips initialis√©s');
      }

      // Initialiser les contr√¥les de lisibilit√© (pastilles, taille police, zoom)
      if (window.GroupsInterfaceV4.initLisibilityControls) {
        window.GroupsInterfaceV4.initLisibilityControls();
        console.log('‚úÖ Contr√¥les de lisibilit√© initialis√©s');
      }

      // Initialiser les contr√¥les des param√®tres (panneaux d√©pliants + joystick)
      if (window.GroupsInterfaceV4.initParametersControls) {
        window.GroupsInterfaceV4.initParametersControls();
        console.log('‚úÖ Contr√¥les des param√®tres initialis√©s');
      }

      console.log('‚úÖ Module Groupes V4 pr√™t');

    }).catch(error => {
      console.error('‚ùå Erreur lors du chargement des donn√©es FIN:', error);

      // Supprimer le loader
      const loaderElement = document.getElementById(loaderId);
      if (loaderElement) {
        loaderElement.remove();
      }

      alert('Erreur lors du chargement des donn√©es : ' + error.message);
      closeModuleGroupsV4();
    });
  }

  /**
   * Ferme l'interface du module
   */
  function closeModuleGroupsV4() {
    if (moduleContainer) {
      // R√©initialiser l'√©tat global avant de fermer (√©vite les regroupements fant√¥mes)
      if (typeof window.resetGroupsV4State === 'function') {
        window.resetGroupsV4State(false); // Ne pas conserver le swapDashboard
        console.log('üîÑ √âtat du module r√©initialis√© avant fermeture');
      }

      moduleContainer.remove();  // ‚Üê Supprimer du DOM
      moduleContainer = null;    // ‚Üê R√©initialiser la variable
      console.log('‚úÖ Module Groupes V4 ferm√© et nettoy√©');
    }
  }

  /**
   * G√®re l'√©v√©nement de g√©n√©ration des groupes
   */
  function handleGenerateGroups(event) {
    const { scenario, mode, selectedLanguage, regroupements, criteriaWeights } = event.detail;

    console.log('üéØ G√©n√©ration des groupes demand√©e:', { scenario, mode, selectedLanguage, regroupements });

    if (criteriaWeights) {
      console.log('üéõÔ∏è Pond√©rations personnalis√©es re√ßues:', criteriaWeights);
    }

    // Afficher le LoadingOverlay
    if (window.UIComponents && window.UIComponents.LoadingOverlay) {
      window.UIComponents.LoadingOverlay.show('G√©n√©ration des groupes en cours...');
    }

    // √âcouter les √©v√©nements de progression
    const progressHandler = (e) => {
      if (window.UIComponents && window.UIComponents.LoadingOverlay) {
        window.UIComponents.LoadingOverlay.setStep(e.detail.step);
      }
    };
    document.addEventListener('algorithm:progress', progressHandler);

    try {
      // Pour chaque regroupement, g√©n√©rer les groupes
      const allResults = regroupements.map(regroupement => {
        // R√©cup√©rer les √©l√®ves des classes du regroupement
        const classesData = getClassesData();
        let students = [];

        // Si aucune classe sp√©cifi√©e, prendre toutes les classes
        const classesToUse = regroupement.classes.length > 0
          ? regroupement.classes
          : Object.keys(classesData);

        classesToUse.forEach(className => {
          if (classesData[className]) {
            students.push(...classesData[className]);
          }
        });

        console.log(`üìö Regroupement "${regroupement.name}" : ${students.length} √©l√®ves (avant filtrage)`);

        // FILTRAGE PAR LANGUE pour le sc√©nario LV2
        if (scenario === 'lv2' && selectedLanguage) {
          const beforeFilter = students.length;
          students = students.filter(student => {
            const studentLang = (student.lv2 || 'ESP').toUpperCase();
            return studentLang === selectedLanguage;
          });
          console.log(`üåç Filtrage LV2 (${selectedLanguage}): ${beforeFilter} ‚Üí ${students.length} √©l√®ves`);
        }

        if (students.length === 0) {
          console.warn(`‚ö†Ô∏è Aucun √©l√®ve pour "${regroupement.name}" apr√®s filtrage`);
          return null;
        }

        console.log(`üìö Regroupement "${regroupement.name}" : ${students.length} √©l√®ves (apr√®s filtrage)`);

        // ‚ú® Utiliser les pond√©rations transmises par l'√©v√©nement
        if (criteriaWeights) {
          console.log('üéõÔ∏è Utilisation des pond√©rations personnalis√©es:', criteriaWeights);
        }

        // Appeler l'algorithme avec les pond√©rations personnalis√©es
        const result = window.GroupsAlgorithmV4.distribute({
          students,
          mode,
          numGroups: regroupement.numGroups,
          scenario,
          criteriaWeights // ‚ú® Pond√©rations de l'√©v√©nement (shorthand)
        });

        return {
          regroupement: regroupement.name,
          result
        };
      });

      // Filtrer les r√©sultats null (regroupements vides)
      const validResults = allResults.filter(r => r !== null);

      if (validResults.length === 0) {
        throw new Error('Aucun √©l√®ve trouv√© apr√®s filtrage. V√©rifiez la langue s√©lectionn√©e et les classes.');
      }

      // Combiner les r√©sultats avec NUM√âROTATION GLOBALE continue
      let globalGroupCounter = 1; // Compteur global pour tous les regroupements

      const combinedResults = {
        groups: validResults.flatMap(r =>
          r.result.groups.map(group => {
            const globalId = globalGroupCounter++;
            return {
              ...group,
              id: globalId, // ID global num√©rique
              name: `Groupe ${globalId}`, // Nom global
              originalId: group.id, // Conserver l'ID original du regroupement
              originalName: group.name, // Conserver le nom original
              regroupementName: r.regroupement, // Ajouter le nom du regroupement
              regroupementId: r.regroupement.replace(/\s+/g, '-').toLowerCase()
            };
          })
        ),
        stats: validResults.flatMap(r => r.result.stats),
        metadata: {
          scenario,
          scenarioApplied: scenario,
          mode,
          selectedLanguage,
          totalRegroupements: validResults.length,
          totalStudents: validResults.reduce((sum, r) => sum + r.result.metadata.totalStudents, 0),
          totalGroups: globalGroupCounter - 1, // Nombre total de groupes cr√©√©s
          timestamp: new Date().toISOString(),
          criteriaWeights: criteriaWeights || null, // ‚ú® Utiliser criteriaWeights de l'√©v√©nement
          criteriaWeightsSource: null, // Sera √©cras√© par firstMetadata plus bas
          criteriaWeightsOverridesApplied: false // Sera √©cras√© par firstMetadata plus bas
        }
      };

      combinedResults.groups = combinedResults.groups.map(group => {
        const normalizedStudents = (group.students || [])
          .map(normalizeStudentForResults)
          .filter(student => student !== null);
        return {
          ...group,
          students: normalizedStudents
        };
      });

      combinedResults.metadata.totalStudents = combinedResults.groups.reduce(
        (sum, group) => sum + (group.students ? group.students.length : 0),
        0
      );

      const firstMetadata = validResults[0]?.result?.metadata || {};
      combinedResults.metadata = {
        ...combinedResults.metadata,
        scenarioApplied: firstMetadata.scenarioApplied || combinedResults.metadata.scenarioApplied,
        criteriaWeights: firstMetadata.criteriaWeights || combinedResults.metadata.criteriaWeights,
        criteriaWeightsSource: firstMetadata.criteriaWeightsSource || combinedResults.metadata.criteriaWeightsSource,
        criteriaWeightsOverridesApplied: firstMetadata.criteriaWeightsOverridesApplied ?? combinedResults.metadata.criteriaWeightsOverridesApplied
      };

      // √âmettre l'√©v√©nement de succ√®s
      const successEvent = new CustomEvent('groups:generated', {
        detail: combinedResults
      });
      document.dispatchEvent(successEvent);

      console.log('‚úÖ Groupes g√©n√©r√©s avec succ√®s', combinedResults);

      // Masquer le LoadingOverlay apr√®s un court d√©lai
      setTimeout(() => {
        if (window.UIComponents && window.UIComponents.LoadingOverlay) {
          window.UIComponents.LoadingOverlay.hide();
        }
        document.removeEventListener('algorithm:progress', progressHandler);

        // Toast de succ√®s
        if (window.UIComponents && window.UIComponents.Toast) {
          window.UIComponents.Toast.success(
            `‚ú® ${combinedResults.metadata.totalGroups} groupe(s) cr√©√©(s) avec succ√®s !`
          );
        }
      }, 500);

    } catch (error) {
      console.error('‚ùå Erreur lors de la g√©n√©ration:', error);

      // Masquer le LoadingOverlay
      if (window.UIComponents && window.UIComponents.LoadingOverlay) {
        window.UIComponents.LoadingOverlay.hide();
      }
      document.removeEventListener('algorithm:progress', progressHandler);

      // Toast d'erreur
      if (window.UIComponents && window.UIComponents.Toast) {
        window.UIComponents.Toast.error(`‚ùå Erreur : ${error.message}`);
      }

      // √âmettre l'√©v√©nement d'erreur
      const errorEvent = new CustomEvent('groups:error', {
        detail: { message: error.message }
      });
      document.dispatchEvent(errorEvent);
    }
  }

  /**
   * G√®re l'√©v√©nement de r√©sultats g√©n√©r√©s
   */
  function handleGroupsGenerated(event) {
    console.log('üìä R√©sultats re√ßus:', event.detail);

    // Afficher les r√©sultats dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayResults(event.detail);
    }
  }

  /**
   * G√®re l'√©v√©nement d'erreur
   */
  function handleGroupsError(event) {
    console.error('‚ùå Erreur re√ßue:', event.detail);

    // Afficher l'erreur dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayError(event.detail);
    }
  }

  /**
   * Remplace la fonction openGroupsInterface existante
   */
  function replaceOpenGroupsInterface() {
    // Sauvegarder l'ancienne fonction si elle existe
    if (window.openGroupsInterface) {
      window._oldOpenGroupsInterface = window.openGroupsInterface;
      console.log('üíæ Ancienne openGroupsInterface sauvegard√©e');
    }

    // Remplacer par la nouvelle
    window.openGroupsInterface = function(mode) {
      console.log('üîÑ openGroupsInterface appel√©e avec mode:', mode);

      // Rediriger vers le module V4
      openModuleGroupsV4(mode);
    };

    console.log('‚úÖ openGroupsInterface remplac√©e par la version V4');
  }

  /**
   * Restaure l'ancienne fonction openGroupsInterface
   */
  function restoreOpenGroupsInterface() {
    if (window._oldOpenGroupsInterface) {
      window.openGroupsInterface = window._oldOpenGroupsInterface;
      delete window._oldOpenGroupsInterface;
      console.log('‚úÖ openGroupsInterface restaur√©e');
    }
  }

  /**
   * Initialisation du module
   */
  function init() {
    // √âcouter les √©v√©nements
    document.addEventListener('groups:generate', handleGenerateGroups);
    document.addEventListener('groups:generated', handleGroupsGenerated);
    document.addEventListener('groups:error', handleGroupsError);

    // Remplacer la fonction du header
    replaceOpenGroupsInterface();

    // Exposer les fonctions globalement
    window.openModuleGroupsV4 = openModuleGroupsV4;
    window.closeModuleGroupsV4 = closeModuleGroupsV4;

    console.log('‚úÖ Module Groupes V4 initialis√© et connect√© au header');
  }

  // Initialiser au chargement du DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM d√©j√† charg√©
    setTimeout(init, 100);
  }

  // Nettoyer √† la fermeture
  window.addEventListener('beforeunload', () => {
    restoreOpenGroupsInterface();
  });

})();
</script>
