<!DOCTYPE html>
<html lang="fr">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>PILOTAGE EXPERT V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --bg-dark: #0f172a;
            --text: #f8fafc;
            --card: #1e293b;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            margin: 0;
            height: calc(100vh - 36px);
            display: grid;
            grid-template-columns: 200px 1fr 280px; /* Gauche/Droite r√©duites, Centre LARGE */
            overflow: hidden;
            font-size: 16px;
        }

        /* SIDEBAR */
        .sidebar {
            background: #020617;
            padding: 20px;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .nav-item {
            padding: 18px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: #94a3b8;
            font-weight: 600;
            font-size: 15px;
            transition: 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* MAIN */
        .main {
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        .phase {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phase.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        h1 { font-size: 28px; font-weight: 900; margin-bottom: 15px; }
        h2 { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 20px; text-transform: uppercase; }
        h3 { font-size: 16px; font-weight: 700; margin-bottom: 10px; }
        label { display: block; font-size: 13px; font-weight: 700; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }

        input, select {
            width: 100%;
            background: #0f172a;
            border: 2px solid #334155;
            color: white;
            padding: 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* BOUTONS */
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 8px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn:disabled { opacity: 0.6; cursor: wait; }
        .btn-primary { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-success { background: var(--success); color: #022c22; }
        .btn-secondary { background: #334155; color: white; }

        /* TABLEAU √âDITEUR (Alignement Centr√©) */
        .editor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }

        .editor-table th {
            text-align: center;
            padding: 10px 2px;
            font-size: 12px;
            font-weight: 800;
            border-bottom: 2px solid #334155;
            vertical-align: bottom;
            color: #94a3b8;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .editor-table td {
            padding: 4px 2px;
            border-bottom: 1px solid #334155;
            text-align: center;
        }

        /* INPUTS (Grosses Cases) */
        .editor-table input {
            margin: 0 auto;
            padding: 0;
            height: 65px;
            width: 100%;
            font-size: 18px;
            font-weight: 900;
            text-align: center !important;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            color: white;
            transition: all 0.1s;
            cursor: pointer;
        }

        .editor-table input:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .editor-table input:focus {
            background: #1e293b;
            border: 2px solid var(--primary);
            outline: none;
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        /* SPINNERS DISCRETS (masqu√©s par d√©faut, visibles au survol) */
        .editor-table input[type="number"]::-webkit-inner-spin-button,
        .editor-table input[type="number"]::-webkit-outer-spin-button {
            opacity: 0;
            height: 55px;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.5);
            margin: 0;
            padding: 0;
            transition: opacity 0.2s ease, background 0.2s ease;
        }

        /* Afficher les spinners au survol ou focus de l'input */
        .editor-table input[type="number"]:hover::-webkit-inner-spin-button,
        .editor-table input[type="number"]:hover::-webkit-outer-spin-button,
        .editor-table input[type="number"]:focus::-webkit-inner-spin-button,
        .editor-table input[type="number"]:focus::-webkit-outer-spin-button {
            opacity: 1;
        }

        /* Style au survol des spinners eux-m√™mes */
        .editor-table input[type="number"]::-webkit-inner-spin-button:hover,
        .editor-table input[type="number"]::-webkit-outer-spin-button:hover {
            background: rgba(99, 102, 241, 0.4);
        }

        /* PANEL DROITE */
        .panel-right {
            background: #1e293b;
            border-left: 1px solid #334155;
            padding: 25px;
            overflow-y: auto;
        }

        .status-box {
            background: #0f172a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #334155;
        }

        /* SPINNER CSS */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: none;
        }
        .btn.loading .spinner { display: block; }
        .btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TOAST */
        .toast {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            min-width: 350px; padding: 20px 25px; border-radius: 12px;
            font-size: 16px; font-weight: 600; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s; display: none;
        }
        .toast.show { display: flex; align-items: center; gap: 15px; }
        .toast.success { background: var(--success); color: #022c22; }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--primary); color: white; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 10000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); animation: fadeIn 0.2s;
        }
        .modal-overlay.show { display: flex; }
        .welcome-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 10001;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); animation: fadeIn 0.2s;
        }
        .welcome-overlay.show { display: flex; }
        .modal {
            background: var(--card); border-radius: 20px; padding: 40px;
            max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s; border: 1px solid #334155;
        }
        .modal-icon { font-size: 48px; margin-bottom: 20px; text-align: center; }
        .modal-icon.success { color: var(--success); }
        .modal-icon.error { color: var(--danger); }
        .modal-icon.warning { color: var(--warning); }
        .modal-icon.info { color: var(--primary); }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; text-align: center; color: white; }
        .modal-message { font-size: 17px; color: #94a3b8; text-align: center; line-height: 1.6; margin-bottom: 30px; }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; }
        .modal-btn { padding: 15px 35px; border: none; border-radius: 8px; font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .modal-btn-primary { background: var(--primary); color: white; }
        .modal-btn-secondary { background: #334155; color: white; }
        @keyframes modalSlideIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* MINIMIZE BAR */
        .minimize-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 36px; z-index: 9998;
            background: #020617; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; font-family: 'Inter', sans-serif;
        }
        .minimize-bar .bar-title {
            font-size: 13px; font-weight: 700; color: #94a3b8;
            display: flex; align-items: center; gap: 8px;
        }
        .minimize-bar .bar-actions { display: flex; gap: 6px; }
        .minimize-bar .bar-btn {
            width: 28px; height: 28px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s;
        }
        .bar-btn.minimize { background: #eab308; color: #1e293b; }
        .bar-btn.minimize:hover { background: #facc15; }
        .bar-btn.close { background: #ef4444; color: white; }
        .bar-btn.close:hover { background: #f87171; }
        body { padding-top: 36px; }
        body.minimized .sidebar,
        body.minimized .main,
        body.minimized .panel-right,
        body.minimized .toast,
        body.minimized .modal-overlay,
        body.minimized .welcome-overlay { display: none !important; }
        body.minimized { height: auto; overflow: hidden; }
    </style>
</head>

<body>

    <div class="minimize-bar">
        <div class="bar-title"><i class="fas fa-rocket"></i> PILOTE V3</div>
        <div class="bar-actions">
            <button class="bar-btn minimize" id="btn-minimize" onclick="toggleMinimize()" title="R√©duire / Agrandir">&#x2796;</button>
            <button class="bar-btn close" onclick="google.script.host.close()" title="Fermer">&#x2716;</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div id="modal-icon" class="modal-icon"></div>
            <h2 id="modal-title" class="modal-title"></h2>
            <p id="modal-message" class="modal-message"></p>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <div id="welcome-overlay" class="welcome-overlay">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-icon info"><i class="fas fa-hand-sparkles"></i></div>
            <h2 class="modal-title">Bienvenue dans le Pilotage V3</h2>
            <p class="modal-message">Choisissez comment d√©marrer : reprendre une session existante ou repartir de z√©ro.</p>
            <div class="modal-buttons" style="gap: 10px;">
                <button id="btn-new-config" class="modal-btn modal-btn-secondary" onclick="handleNewConfiguration()">
                    <i class="fas fa-plus-circle"></i> NOUVELLE CONFIGURATION
                </button>
                <button id="btn-resume-session" class="modal-btn modal-btn-primary" onclick="handleResumeSession()" style="display:none;">
                    <i class="fas fa-history"></i> REPRENDRE LA SESSION
                </button>
            </div>
            <div id="welcome-status" style="text-align:center;color:#94a3b8;margin-top:10px;font-size:13px;"></div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-rocket"></i> PILOTE V3</div>
        <nav>
            <div class="nav-item active" onclick="goTo(1)" id="nav-1"><i class="fas fa-hammer"></i> INIT</div>
            <div class="nav-item" onclick="goTo('import')" id="nav-import"><i class="fas fa-file-import"></i> IMPORT</div>
            <div class="nav-item" onclick="goTo(3)" id="nav-3"><i class="fas fa-chart-bar"></i> STATS</div>
            <div class="nav-item" onclick="goTo(4)" id="nav-4"><i class="fas fa-chess-board"></i> STRUCTURE</div>
            <div class="nav-item" onclick="goTo(5)" id="nav-5"><i class="fas fa-cogs"></i> MOTEUR</div>
            <div class="nav-item" onclick="goTo(6)" id="nav-6"><i class="fas fa-check"></i> FINAL</div>
        </nav>
    </aside>

    <main class="main">

        <div id="phase-1" class="phase active">
            <h1>CONFIGURATION & INITIALISATION</h1>
            <div class="card">
                <h2>Param√®tres du Syst√®me</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div><label> Mot de Passe Admin</label><input type="password" id="pwd" value="admin123"></div>
                    <div>
                        <label> Niveau Scolaire</label>
                        <select id="niv">
                            <optgroup label="√âcole Primaire">
                                <option value="CM2">CM2</option>
                            </optgroup>
                            <optgroup label="Coll√®ge">
                                <option value="6¬∞">6√®me</option>
                                <option value="5¬∞" selected>5√®me</option>
                                <option value="4¬∞">4√®me</option>
                                <option value="3¬∞">3√®me</option>
                            </optgroup>
                            <optgroup label="Lyc√©e">
                                <option value="2nde">2nde</option>
                                <option value="1√®re">1√®re</option>
                                <option value="Term">Terminale</option>
                            </optgroup>
                        </select>
                    </div>
                    <div></div>
                    <div><label>üìÇ Nb Classes Sources</label><input type="number" id="src" value="6" min="1" max="30"></div>
                    <div><label>üéØ Nb Classes Cibles</label><input type="number" id="dest" value="6" min="1" max="20"></div>
                </div>

                <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">

                <h2>2. Dictionnaire des Codes</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div><label>üåç Langues (LV1/LV2)</label><input type="text" id="lv2" value="ANG, ALL, ESP, ITA"></div>
                    <div><label>üöÄ Options</label><input type="text" id="opt" value="LATIN, CHAV"></div>
                    <div><label>üìã Dispositifs</label><input type="text" id="dispo" value="PAI, PPRE, ULIS, UPE2A"></div>
                </div>
                <hr style="border: 0; border-top: 1px solid #334155; margin: 30px 0;">

                <h2 style="color: var(--success);">Actions</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="font-size: 16px; color: #94a3b8; margin-bottom: 10px;">üíæ Sauvegarde Config</h3>
                        <button onclick="saveConfigOnly()" id="btn-save-config" class="btn btn-success">
                            <div class="spinner"></div>
                            <span><i class="fas fa-save"></i> SAUVEGARDER CONFIG</span>
                        </button>
                    </div>
                    <div>
                        <h3 style="font-size: 16px; color: #94a3b8; margin-bottom: 10px;">üî• Initialisation Compl√®te</h3>
                        <button onclick="runInit()" id="btn-init" class="btn" style="background: var(--danger);">
                            <div class="spinner"></div>
                            <span><i class="fas fa-exclamation-triangle"></i> INITIALISER SYST√àME</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- =============== PHASE IMPORT ‚Äî Multi-paste Pronote =============== -->
        <div id="phase-import" class="phase">
            <h1>IMPORT MULTI-PASTE PRONOTE</h1>

            <!-- Barre de progression des 4 etapes -->
            <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
                <span id="badge-eleves" class="import-badge" style="background:#334155; color:#94a3b8; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">1. Eleves</span>
                <span id="badge-notes" class="import-badge" style="background:#334155; color:#94a3b8; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">2. Notes</span>
                <span id="badge-absences" class="import-badge" style="background:#334155; color:#94a3b8; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">3. Absences</span>
                <span id="badge-comportement" class="import-badge" style="background:#334155; color:#94a3b8; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">4. Comportement</span>
            </div>

            <!-- ETAPE 1 : Liste des eleves -->
            <div id="import-step-eleves" class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>1. Liste des Eleves</h2>
                    <button onclick="clearImportStep('eleves')" class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:11px;">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
                <p style="color:#94a3b8; margin-bottom:10px; font-size:13px;">
                    Dans Pronote, ouvrez la liste des eleves (Eleves &gt; Listes), selectionnez toutes les lignes et collez ici.
                    Colonnes attendues : NOM, PRENOM, SEXE, CLASSE et idealement les options (Toutes les options).
                </p>
                <textarea id="paste-eleves" rows="6" placeholder="Collez ici le tableau Pronote des eleves (Ctrl+V)..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical;"></textarea>
                <div id="preview-eleves" style="max-height:150px; overflow-y:auto; margin-top:8px;"></div>
                <button onclick="parseImportEleves()" class="btn btn-primary" style="margin-top:10px;">
                    <div class="spinner"></div>
                    <span><i class="fas fa-user-check"></i> VALIDER LES ELEVES</span>
                </button>
            </div>

            <!-- ETAPE 2 : Notes / Moyennes -->
            <div id="import-step-notes" class="card" style="opacity:0.5; pointer-events:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>2. Notes / Moyennes</h2>
                    <button onclick="clearImportStep('notes')" class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:11px;">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
                <p style="color:#94a3b8; margin-bottom:10px; font-size:13px;">
                    Collez les moyennes d'une classe a la fois. Apres chaque collage, cliquez "Ajouter cette classe".
                    Repetez pour chaque classe source.
                </p>
                <div id="notes-classes-badges" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <textarea id="paste-notes" rows="6" placeholder="Collez ici les moyennes Pronote d'UNE classe (Ctrl+V)..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical;"></textarea>
                <div id="preview-notes" style="max-height:150px; overflow-y:auto; margin-top:8px;"></div>
                <button onclick="parseImportNotes()" class="btn btn-primary" style="margin-top:10px;">
                    <div class="spinner"></div>
                    <span><i class="fas fa-plus-circle"></i> AJOUTER CETTE CLASSE</span>
                </button>
                <button onclick="toggleImportStep('absences')" class="btn btn-success" style="margin-top:8px; display:none;" id="btn-notes-done">
                    <span><i class="fas fa-arrow-right"></i> NOTES TERMINEES ‚Äî PASSER AUX ABSENCES</span>
                </button>
            </div>

            <!-- ETAPE 3 : Absences -->
            <div id="import-step-absences" class="card" style="opacity:0.5; pointer-events:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>3. Absences</h2>
                    <button onclick="clearImportStep('absences')" class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:11px;">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
                <p style="color:#94a3b8; margin-bottom:10px; font-size:13px;">
                    Collez le recapitulatif des absences Pronote (toutes classes). Format attendu : NOM, demi-journees d'absence, non justifiees.
                </p>
                <textarea id="paste-absences" rows="6" placeholder="Collez ici le recapitulatif des absences (Ctrl+V)..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical;"></textarea>
                <div id="preview-absences" style="max-height:150px; overflow-y:auto; margin-top:8px;"></div>
                <button onclick="parseImportAbsences()" class="btn btn-primary" style="margin-top:10px;">
                    <div class="spinner"></div>
                    <span><i class="fas fa-calendar-check"></i> VALIDER LES ABSENCES</span>
                </button>
            </div>

            <!-- ETAPE 4 : Comportement (Punitions + Retenues + Incidents) -->
            <div id="import-step-comportement" class="card" style="opacity:0.5; pointer-events:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>4. Comportement</h2>
                    <button onclick="clearImportStep('comportement')" class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:11px;">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
                <p style="color:#94a3b8; margin-bottom:10px; font-size:13px;">
                    Collez les punitions, les retenues et les incidents. Chaque zone est independante ‚Äî remplissez celles que vous avez.
                </p>
                <div style="font-size:12px; font-weight:700; color:#eab308; margin-bottom:6px;">PUNITIONS</div>
                <textarea id="paste-punitions" rows="4" placeholder="Collez ici la liste des punitions Pronote..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical; margin-bottom:8px;"></textarea>
                <div id="preview-punitions" style="max-height:100px; overflow-y:auto; margin-bottom:10px;"></div>
                <div style="font-size:12px; font-weight:700; color:#f97316; margin-bottom:6px;">RETENUES (heures de retenue)</div>
                <textarea id="paste-retenues" rows="4" placeholder="Collez ici les retenues Pronote..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical; margin-bottom:8px;"></textarea>
                <div id="preview-retenues" style="max-height:100px; overflow-y:auto; margin-bottom:10px;"></div>
                <div style="font-size:12px; font-weight:700; color:#ef4444; margin-bottom:6px;">INCIDENTS (faits graves)</div>
                <textarea id="paste-incidents" rows="4" placeholder="Collez ici les incidents Pronote (faits graves)..."
                    style="width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; padding:10px; font-family:monospace; font-size:12px; resize:vertical;"></textarea>
                <div id="preview-incidents" style="max-height:100px; overflow-y:auto; margin-top:8px;"></div>
                <button onclick="parseImportComportement()" class="btn btn-primary" style="margin-top:10px;">
                    <div class="spinner"></div>
                    <span><i class="fas fa-user-shield"></i> VALIDER LE COMPORTEMENT</span>
                </button>
            </div>

            <!-- Compilation finale -->
            <div id="import-compile-section" class="card" style="display:none; border:2px solid var(--success);">
                <h2><i class="fas fa-cogs" style="color:var(--success);"></i> COMPILATION FINALE</h2>
                <div id="import-summary" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px;">
                    <div style="background:#0f172a; padding:12px; border-radius:8px; text-align:center;">
                        <div id="sum-eleves" style="font-size:24px; font-weight:900; color:var(--primary);">0</div>
                        <div style="font-size:10px; color:#94a3b8; font-weight:700;">ELEVES</div>
                    </div>
                    <div style="background:#0f172a; padding:12px; border-radius:8px; text-align:center;">
                        <div id="sum-notes" style="font-size:24px; font-weight:900; color:#eab308;">0</div>
                        <div style="font-size:10px; color:#94a3b8; font-weight:700;">NOTES</div>
                    </div>
                    <div style="background:#0f172a; padding:12px; border-radius:8px; text-align:center;">
                        <div id="sum-absences" style="font-size:24px; font-weight:900; color:#f97316;">0</div>
                        <div style="font-size:10px; color:#94a3b8; font-weight:700;">ABSENCES</div>
                    </div>
                    <div style="background:#0f172a; padding:12px; border-radius:8px; text-align:center;">
                        <div id="sum-comportement" style="font-size:24px; font-weight:900; color:#ef4444;">0</div>
                        <div style="font-size:10px; color:#94a3b8; font-weight:700;">COMPORT.</div>
                    </div>
                </div>
                <button onclick="runCompileImport()" id="btn-compile-import" class="btn" style="background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <div class="spinner"></div>
                    <span><i class="fas fa-file-import"></i> COMPILER ET INJECTER DANS LES ONGLETS SOURCE</span>
                </button>
            </div>

            <!-- Resultat / DISSO suggestions -->
            <div id="import-result" class="card" style="display:none;">
                <h2><i class="fas fa-check-circle" style="color:var(--success);"></i> RESULTAT DE L'IMPORT</h2>
                <div id="import-result-content"></div>
                <div id="import-disso-suggestions" style="display:none; margin-top:15px; background:#0f172a; border:1px solid #eab308; border-radius:8px; padding:15px;">
                    <div style="font-size:13px; font-weight:700; color:#eab308; margin-bottom:8px;">SUGGESTIONS DISSO (eleves a separer)</div>
                    <div id="disso-groups-content"></div>
                </div>
                <button onclick="goTo(3)" class="btn btn-success" style="margin-top:15px;">
                    <span><i class="fas fa-arrow-right"></i> CONTINUER VERS LES STATS</span>
                </button>
            </div>
        </div>

        <div id="phase-3" class="phase">
            <h1>üìä ANALYSE DES EFFECTIFS</h1>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Statistiques</h2>
                    <button onclick="loadStats()" id="btn-refresh-stats" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>

                <div id="stats-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--primary); font-size: 16px; font-weight: 700; margin-bottom: 12px;">üìå EFFECTIFS</h3>
                        <div id="stats-effectifs" style="font-size: 42px; font-weight: 900;">-</div>
                    </div>
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--primary); font-size: 16px; font-weight: 700; margin-bottom: 12px;">‚öñÔ∏è PARIT√â F/M</h3>
                        <div id="stats-parite" style="font-size: 18px; font-weight: 600;">-</div>
                    </div>
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--primary); font-size: 16px; font-weight: 700; margin-bottom: 12px;">üåç LV2 SEULES</h3>
                        <table id="stats-lv2" style="width: 100%; font-size: 17px;"></table>
                    </div>
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--primary); font-size: 16px; font-weight: 700; margin-bottom: 12px;">üéØ OPTIONS SEULES</h3>
                        <table id="stats-options" style="width: 100%; font-size: 17px;"></table>
                    </div>
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--warning); font-size: 16px; font-weight: 700; margin-bottom: 12px;">‚ö° PROFILS DOUBLES</h3>
                        <table id="stats-combos" style="width: 100%; font-size: 17px;"></table>
                    </div>
                    <div class="card" style="background: #0f172a; padding: 25px;">
                        <h3 style="color: var(--primary); font-size: 16px; font-weight: 700; margin-bottom: 12px;">üìã DISPOSITIFS</h3>
                        <table id="stats-dispositifs" style="width: 100%; font-size: 17px;"></table>
                    </div>
                </div>

                <button onclick="goTo(4)" class="btn btn-success" style="margin-top: 30px;">
                    <span><i class="fas fa-arrow-right"></i> D√âFINIR LA STRUCTURE</span>
                </button>
            </div>
        </div>

        <div id="phase-4" class="phase">
            <h1>STRAT√âGIE DE R√âPARTITION</h1>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h2>D√©finition des Classes Cibles</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="loadStructure()" id="btn-load-struct" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                            <i class="fas fa-sync"></i> Actualiser
                        </button>
                    </div>
                </div>

                <div style="margin: 20px 0; border: 1px solid #334155; border-radius: 8px;">
                    <table class="editor-table" id="struct-table">
                        <thead id="struct-header"></thead>
                        <tbody id="struct-body"><tr><td style="padding:30px">Chargement...</td></tr></tbody>
                    </table>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <div style="color: var(--warning); font-size: 13px; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> Total Places : <span id="total-cap">0</span>
                    </div>
                    <button onclick="saveStructure()" id="btn-save-struct" class="btn btn-success" style="width: 200px;">
                        <div class="spinner"></div>
                        <span>VALIDER</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="phase-5" class="phase">
            <h1>OPTIMISATION</h1>
            <div class="card">
                <h2>Lancement du Moteur</h2>
                <p style="color: #94a3b8; margin-bottom: 20px;">L'algorithme va r√©partir les √©l√®ves selon votre structure.</p>
                <button onclick="runEngine()" id="btn-engine" class="btn btn-primary">
                    <div class="spinner"></div>
                    <span>LANCER CALCUL</span>
                </button>
            </div>
        </div>

        <div id="phase-6" class="phase">
            <h1>FINALISATION</h1>
            <div class="card">
                <h2>Acc√®s √† l'Interface V2</h2>
                <p style="color: #94a3b8; margin-bottom: 20px;">
                    Les onglets FIN ont d√©j√† √©t√© g√©n√©r√©s par le pipeline LEGACY.<br>
                    Vous pouvez maintenant ouvrir l'Interface V2 pour visualiser et affiner les r√©partitions.
                </p>
                <button onclick="openInterfaceV2()" id="btn-interface-v2" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span><i class="fas fa-external-link-alt"></i> OUVRIR INTERFACE V2</span>
                </button>
                <p style="color: #64748b; font-size: 13px; margin-top: 15px; text-align: center;">
                    L'interface s'ouvrira dans un nouvel onglet de votre navigateur
                </p>
            </div>
        </div>

    </main>

    <aside class="panel-right" style="background: #1e293b; border-left: 1px solid #334155; padding: 20px; overflow-y: auto;">
        
        <h2 style="font-size: 14px; color: #64748b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">√âTAT SYST√àME</h2>
        
        <div id="metric-places" class="status-box" style="background: #0f172a; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="text-align:center; color:#64748b; font-size:12px;">Chargement...</div>
        </div>

        <h2 style="font-size: 14px; color: #64748b; margin: 30px 0 15px 0; text-transform: uppercase; letter-spacing: 1px;">SUIVI DES QUOTAS</h2>
        
        <div style="background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 10px;">üåç QUOTAS LANGUES</div>
            <div id="quota-lv2"></div>
        </div>

        <div style="background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 10px;">üéØ QUOTAS OPTIONS</div>
            <div id="quota-options"></div>
        </div>

        <div style="background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--warning); margin-bottom: 10px;">‚ö° PROFILS DOUBLES</div>
            <div id="quota-combos"></div>
        </div>

    </aside>

    <script>
    // ===================================================================
        // MINIMIZE / MAXIMIZE
        // ===================================================================
        const FULL_HEIGHT = 900;
        const MINI_HEIGHT = 36;
        let isMinimized = false;

        function toggleMinimize() {
            isMinimized = !isMinimized;
            const btn = document.getElementById('btn-minimize');
            if (isMinimized) {
                document.body.classList.add('minimized');
                google.script.host.setHeight(MINI_HEIGHT);
                btn.innerHTML = '&#x2795;'; // ‚ûï
                btn.title = 'Agrandir';
            } else {
                google.script.host.setHeight(FULL_HEIGHT);
                document.body.classList.remove('minimized');
                btn.innerHTML = '&#x2796;'; // ‚ûñ
                btn.title = 'R√©duire';
            }
        }

        // ===================================================================
        // 0. UTILITAIRE S√âCURIT√â - √âCHAPPEMENT HTML
        // ===================================================================
        function escapeHtml(str) {
          if (str === null || str === undefined) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        // ===================================================================
        // 1. VARIABLES GLOBALES & S√âCURIT√â (ANTI-CRASH)
        // ===================================================================
        let currentStructure = null;
        // Initialisation vide pour √©viter "undefined" au d√©marrage
        let cachedStats = { 
            effectifs: { total: 0 }, 
            global: {}, 
            lv2: {}, 
            options: {}, 
            combos: {}, 
            dispositifs: {},
            asso: { eleves: 0 },
            disso: { eleves: 0 }
        };
        let lastKnownProgress = null;

        const sessionRoutes = {
            status: '/pilotageV3/session/status',
            load: '/pilotageV3/session/load',
            reset: '/pilotageV3/session/reset'
        };

        const sessionFunctionMap = {
            [sessionRoutes.status]: 'v3_getSessionStatus',
            [sessionRoutes.load]: 'v3_loadSessionState',
            [sessionRoutes.reset]: 'v3_resetSessionState'
        };

        // ===================================================================
        // 2. UTILITAIRES
        // ===================================================================
        function runServerCall(functionName, args, onSuccess, onError) {
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onError)
                [functionName](...args);
        }

        function callSessionEndpoint(url) {
            if (typeof google !== 'undefined' && google.script) {
                const functionName = sessionFunctionMap[url];
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(err => reject(new Error(err && err.message ? err.message : err)))
                        [functionName]();
                });
            }
            return Promise.reject("Environnement Google non d√©tect√©");
        }

        // ===================================================================
        // 3. INITIALISATION
        // ===================================================================
        window.onload = function() {
            console.log("üöÄ Console Pilotage V3 charg√©e");
            toggleWelcomeModal(true); // Affiche imm√©diatement l'√©cran de choix
            initializeWelcomeFlow();
            goTo(1); // Force l'affichage imm√©diat pour √©viter l'√©cran blanc
        };

        async function initializeWelcomeFlow() {
            const statusEl = document.getElementById('welcome-status');
            const btnResume = document.getElementById('btn-resume-session');
            if (statusEl) statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> V√©rification des sessions enregistr√©es...';

            try {
                const status = await getSessionStatus();
                if (btnResume) btnResume.style.display = status.hasBackup ? 'flex' : 'none';
                if (statusEl) statusEl.innerHTML = status.hasBackup
                    ? '<i class="fas fa-check-circle"></i> Session pr√©c√©dente d√©tect√©e.'
                    : '<i class="fas fa-info-circle"></i> Aucune session pr√©c√©dente trouv√©e. D√©marrez une nouvelle configuration.';
            } catch (e) {
                console.error("Erreur session", e);
                if (btnResume) btnResume.style.display = 'none';
                if (statusEl) statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Impossible de v√©rifier les sessions. Vous pouvez d√©marrer une nouvelle configuration.';
            }
        }

        async function getSessionStatus() {
            try {
                const data = await callSessionEndpoint(sessionRoutes.status);
                return { hasBackup: data && (data.hasBackup || data.success) };
            } catch (e) { return { hasBackup: false }; }
        }

        // ===================================================================
        // 4. NAVIGATION
        // ===================================================================
        function goTo(n) {
            document.querySelectorAll('.phase').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            
            const next = document.getElementById('phase-' + n);
            if (next) {
                next.style.display = 'block';
                setTimeout(() => next.classList.add('active'), 10);
            }

            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            const nav = document.getElementById('nav-' + n);
            if (nav) nav.classList.add('active');

            if (n === 3) loadStats();
            if (n === 4) {
                // S'assurer que les stats sont charg√©es avant d'afficher la structure
                if (!cachedStats || !cachedStats.effectifs || cachedStats.effectifs.total === 0) {
                    loadStats();
                }
                loadStructure();
            }
        }

        function showModal(msg, type = 'info') {
            const overlay = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const title = document.getElementById('modal-title');
            const txt = document.getElementById('modal-message');
            const btns = document.getElementById('modal-buttons');

            const icons = { success: 'check-circle', error: 'times-circle', info: 'info-circle' };
            icon.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i>`;
            icon.className = `modal-icon ${type}`;
            title.innerText = type === 'error' ? 'Erreur' : 'Information';
            txt.innerHTML = msg;
            btns.innerHTML = `<button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>`;
            overlay.classList.add('show');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); }
        function toggleWelcomeModal(show) { 
            const el = document.getElementById('welcome-overlay');
            if (el) { if (show) el.classList.add('show'); else el.classList.remove('show'); }
        }

        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.className = `toast ${type} show`;
            t.innerHTML = msg;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.disabled = isLoading;
            if (isLoading) btn.classList.add('loading'); else btn.classList.remove('loading');
        }

        // ===================================================================
        // 5. ACTIONS (Init, Conso, Session)
        // ===================================================================
        async function handleResumeSession() {
            const statusEl = document.getElementById('welcome-status');
            setLoading('btn-resume-session', true);
            if (statusEl) statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement de la session...';

            try {
                const data = await callSessionEndpoint(sessionRoutes.load);
                setLoading('btn-resume-session', false);
                if (statusEl) statusEl.innerHTML = '';

                if (data && data.success) {
                    loadConfigIntoForm(data.config);
                    toggleWelcomeModal(false);
                    showToast('Session restaur√©e', 'success');
                    // Toujours revenir √† INIT pour √©viter la confusion de l'utilisateur
                    goTo(1);
                } else {
                    showModal("Impossible de reprendre la session.", 'error');
                }
            } catch (e) {
                setLoading('btn-resume-session', false);
                if (statusEl) statusEl.innerHTML = '';
                showModal(e.message, 'error');
            }
        }

        async function handleNewConfiguration() {
            await callSessionEndpoint(sessionRoutes.reset);
            toggleWelcomeModal(false);
            goTo(1);
        }

        function loadConfigIntoForm(cfg) {
            if (!cfg) return;
            const c = cfg.config || cfg;
            if (c.adminPassword) document.getElementById('pwd').value = c.adminPassword;
            if (c.niveau) document.getElementById('niv').value = c.niveau;
            if (c.nbSources) document.getElementById('src').value = c.nbSources;
            if (c.nbDest) document.getElementById('dest').value = c.nbDest;
            if (c.lv2) document.getElementById('lv2').value = c.lv2;
            if (c.opt) document.getElementById('opt').value = c.opt;
            if (c.dispo) document.getElementById('dispo').value = c.dispo;
        }

        function saveConfigOnly() {
            const f = getForm();
            setLoading('btn-save-config', true);
            runServerCall('v3_saveConfigOnly', [f], res => {
                setLoading('btn-save-config', false);
                showToast('Configuration sauvegard√©e', 'success');
            }, err => showModal(err.message, 'error'));
        }

        function runInit() {
            const f = getForm();
            setLoading('btn-init', true);
            runServerCall('v3_runInitializationWithForm', [f], res => {
                setLoading('btn-init', false);
                if (res.success) {
                    showToast('Initialis√© !', 'success');
                    saveProgress('import');
                    setTimeout(() => goTo('import'), 1000);
                } else showModal(res.error, 'error');
            }, err => showModal(err.message, 'error'));
        }

        function getForm() {
            return {
                adminPassword: document.getElementById('pwd').value,
                niveau: document.getElementById('niv').value,
                nbSources: parseInt(document.getElementById('src').value),
                nbDest: parseInt(document.getElementById('dest').value),
                lv2: document.getElementById('lv2').value,
                opt: document.getElementById('opt').value,
                dispo: document.getElementById('dispo').value
            };
        }

        function saveProgress(phase, meta) {
            runServerCall('v3_saveProgress', [phase, meta || {}], () => {}, () => {});
        }

        // ===================================================================
        // 5a. IMPORT MULTI-PASTE PRONOTE
        // ===================================================================
        var importState = {
            eleves: null,      // { success, eleves: [...], count, classes }
            notes: [],         // [ {success, notes: [...], count, classe} ] ‚Äî une entree par classe
            absences: null,    // { success, absences: [...], count }
            punitions: null,   // { success, punitions: [...], count }
            retenues: null,    // { success, retenues: [...], count }
            incidents: null,   // { success, incidents: [...], count }
            observations: null // { success, observations: [...], count }
        };

        function parseTSV(text) {
            if (!text || !text.trim()) return [];
            // Remove BOM
            if (text.charCodeAt(0) === 0xFEFF) text = text.substring(1);
            var lines = text.split('\n');
            var rows = [];
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].replace(/\r$/, '');
                if (line.trim() === '') continue;
                rows.push(line.split('\t'));
            }
            return rows;
        }

        function updateImportBadge(step, status, detail) {
            var badge = document.getElementById('badge-' + step);
            if (!badge) return;
            var labels = { eleves: '1. Eleves', notes: '2. Notes', absences: '3. Absences', comportement: '4. Comportement' };
            if (status === 'done') {
                badge.style.background = '#22c55e';
                badge.style.color = '#fff';
                badge.textContent = labels[step] + (detail ? ' (' + detail + ')' : ' OK');
            } else if (status === 'partial') {
                badge.style.background = '#eab308';
                badge.style.color = '#000';
                badge.textContent = labels[step] + (detail ? ' (' + detail + ')' : '...');
            } else {
                badge.style.background = '#334155';
                badge.style.color = '#94a3b8';
                badge.textContent = labels[step];
            }
        }

        function updateImportSummary() {
            var el = document.getElementById('sum-eleves');
            if (el) el.textContent = importState.eleves ? importState.eleves.count : 0;
            var en = document.getElementById('sum-notes');
            if (en) {
                var totalNotes = 0;
                importState.notes.forEach(function(n) { totalNotes += n.count; });
                en.textContent = totalNotes;
            }
            var ea = document.getElementById('sum-absences');
            if (ea) ea.textContent = importState.absences ? importState.absences.count : 0;
            var ec = document.getElementById('sum-comportement');
            if (ec) {
                var cp = importState.punitions ? importState.punitions.count : 0;
                var cr = importState.retenues ? importState.retenues.count : 0;
                var ci = importState.incidents ? importState.incidents.count : 0;
                ec.textContent = cp + cr + ci;
            }

            // Afficher section compilation si eleves sont charges
            var compileSection = document.getElementById('import-compile-section');
            if (compileSection && importState.eleves && importState.eleves.count > 0) {
                compileSection.style.display = 'block';
            }
        }

        function toggleImportStep(step) {
            var steps = ['eleves', 'notes', 'absences', 'comportement'];
            for (var i = 0; i < steps.length; i++) {
                var el = document.getElementById('import-step-' + steps[i]);
                if (!el) continue;
                if (steps[i] === step) {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                } else if (el.style.opacity === '1') {
                    // Deja active, on le laisse
                }
            }
        }

        function clearImportStep(step) {
            if (step === 'eleves') {
                document.getElementById('paste-eleves').value = '';
                document.getElementById('preview-eleves').innerHTML = '';
                importState.eleves = null;
                updateImportBadge('eleves', 'pending');
            } else if (step === 'notes') {
                document.getElementById('paste-notes').value = '';
                document.getElementById('preview-notes').innerHTML = '';
                document.getElementById('notes-classes-badges').innerHTML = '';
                importState.notes = [];
                document.getElementById('btn-notes-done').style.display = 'none';
                updateImportBadge('notes', 'pending');
            } else if (step === 'absences') {
                document.getElementById('paste-absences').value = '';
                document.getElementById('preview-absences').innerHTML = '';
                importState.absences = null;
                updateImportBadge('absences', 'pending');
            } else if (step === 'comportement') {
                document.getElementById('paste-punitions').value = '';
                document.getElementById('paste-retenues').value = '';
                document.getElementById('paste-incidents').value = '';
                document.getElementById('preview-punitions').innerHTML = '';
                document.getElementById('preview-retenues').innerHTML = '';
                document.getElementById('preview-incidents').innerHTML = '';
                importState.punitions = null;
                importState.retenues = null;
                importState.incidents = null;
                updateImportBadge('comportement', 'pending');
            }
            updateImportSummary();
        }

        function renderMiniTable(rows, maxRows, containerId) {
            var el = document.getElementById(containerId);
            if (!el || !rows || rows.length === 0) { if (el) el.innerHTML = ''; return; }
            var limit = Math.min(rows.length, maxRows || 5);
            var maxCols = Math.min(rows[0].length, 8);
            var html = '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
            html += '<thead><tr style="border-bottom:2px solid #334155;background:#0f172a;">';
            for (var h = 0; h < maxCols; h++) {
                html += '<th style="padding:4px;color:#94a3b8;font-size:10px;text-align:left;">' + escapeHtml(String(rows[0][h] || '')) + '</th>';
            }
            if (rows[0].length > maxCols) html += '<th style="color:#64748b;">...</th>';
            html += '</tr></thead><tbody>';
            for (var i = 1; i <= limit; i++) {
                if (!rows[i]) break;
                html += '<tr style="border-bottom:1px solid #1e293b;">';
                for (var c = 0; c < maxCols; c++) {
                    html += '<td style="padding:3px;color:#e2e8f0;font-size:11px;">' + escapeHtml(String(rows[i][c] || '')) + '</td>';
                }
                if (rows[i].length > maxCols) html += '<td style="color:#64748b;">...</td>';
                html += '</tr>';
            }
            if (rows.length - 1 > limit) {
                html += '<tr><td colspan="' + (maxCols + 1) + '" style="text-align:center;color:#64748b;padding:6px;font-size:11px;">... et ' + (rows.length - 1 - limit) + ' autres lignes</td></tr>';
            }
            html += '</tbody></table>';
            el.innerHTML = html;
        }

        // --- Etape 1 : Eleves ---
        function parseImportEleves() {
            var text = document.getElementById('paste-eleves').value;
            var rows = parseTSV(text);
            if (rows.length < 2) { showToast('Collez au moins un en-tete et une ligne de donnees', 'error'); return; }

            renderMiniTable(rows, 5, 'preview-eleves');
            showToast('Envoi au serveur...', 'info');

            runServerCall('v3_parseListeEleves', [rows], function(res) {
                if (!res.success) { showToast('Erreur : ' + res.error, 'error'); return; }
                importState.eleves = res;
                updateImportBadge('eleves', 'done', res.count + ' eleves');
                toggleImportStep('notes');
                updateImportSummary();
                showToast(res.count + ' eleves detectes !', 'success');
            }, function(err) { showModal('Erreur serveur : ' + (err.message || err), 'error'); });
        }

        // --- Etape 2 : Notes (classe par classe) ---
        function parseImportNotes() {
            var text = document.getElementById('paste-notes').value;
            var rows = parseTSV(text);
            if (rows.length < 2) { showToast('Collez au moins un en-tete et une ligne', 'error'); return; }

            renderMiniTable(rows, 3, 'preview-notes');
            showToast('Analyse des notes...', 'info');

            runServerCall('v3_parseNotesMoyennes', [rows], function(res) {
                if (!res.success) { showToast('Erreur : ' + res.error, 'error'); return; }
                importState.notes.push(res);
                // Ajouter badge classe
                var badgesEl = document.getElementById('notes-classes-badges');
                if (badgesEl) {
                    var span = document.createElement('span');
                    span.style.cssText = 'background:#6366f1; color:white; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700;';
                    span.textContent = (res.classe || 'Classe ' + importState.notes.length) + ' (' + res.count + ')';
                    badgesEl.appendChild(span);
                }
                updateImportBadge('notes', 'partial', importState.notes.length + ' classe(s)');
                document.getElementById('btn-notes-done').style.display = 'block';
                document.getElementById('paste-notes').value = '';
                document.getElementById('preview-notes').innerHTML = '';
                updateImportSummary();
                showToast(res.count + ' eleves avec notes (' + (res.classe || '?') + ')', 'success');
            }, function(err) { showModal('Erreur serveur : ' + (err.message || err), 'error'); });
        }

        // --- Etape 3 : Absences ---
        function parseImportAbsences() {
            var text = document.getElementById('paste-absences').value;
            var rows = parseTSV(text);
            if (rows.length < 2) { showToast('Collez au moins un en-tete et une ligne', 'error'); return; }

            renderMiniTable(rows, 5, 'preview-absences');
            showToast('Analyse des absences...', 'info');

            runServerCall('v3_parseAbsences', [rows], function(res) {
                if (!res.success) { showToast('Erreur : ' + res.error, 'error'); return; }
                importState.absences = res;
                updateImportBadge('absences', 'done', res.count + ' eleves');
                toggleImportStep('comportement');
                updateImportSummary();
                showToast(res.count + ' lignes d\'absences traitees', 'success');
            }, function(err) { showModal('Erreur serveur : ' + (err.message || err), 'error'); });
        }

        // --- Etape 4 : Comportement (punitions + retenues + incidents) ---
        function parseImportComportement() {
            var textPuni = document.getElementById('paste-punitions').value;
            var textRet = document.getElementById('paste-retenues').value;
            var textInc = document.getElementById('paste-incidents').value;

            var rowsPuni = parseTSV(textPuni);
            var rowsRet = parseTSV(textRet);
            var rowsInc = parseTSV(textInc);

            if (rowsPuni.length < 2 && rowsRet.length < 2 && rowsInc.length < 2) {
                showToast('Collez au moins des punitions, retenues OU incidents', 'error');
                return;
            }

            if (rowsPuni.length > 1) renderMiniTable(rowsPuni, 3, 'preview-punitions');
            if (rowsRet.length > 1) renderMiniTable(rowsRet, 3, 'preview-retenues');
            if (rowsInc.length > 1) renderMiniTable(rowsInc, 3, 'preview-incidents');

            showToast('Analyse du comportement...', 'info');
            var pending = 0;
            var errors = [];

            if (rowsPuni.length >= 2) {
                pending++;
                runServerCall('v3_parsePunitions', [rowsPuni], function(res) {
                    pending--;
                    if (!res.success) { errors.push('Punitions: ' + res.error); }
                    else { importState.punitions = res; }
                    if (pending === 0) finishComportement(errors);
                }, function(err) { pending--; errors.push('Punitions: ' + (err.message || err)); if (pending === 0) finishComportement(errors); });
            }

            if (rowsRet.length >= 2) {
                pending++;
                runServerCall('v3_parseRetenues', [rowsRet], function(res) {
                    pending--;
                    if (!res.success) { errors.push('Retenues: ' + res.error); }
                    else { importState.retenues = res; }
                    if (pending === 0) finishComportement(errors);
                }, function(err) { pending--; errors.push('Retenues: ' + (err.message || err)); if (pending === 0) finishComportement(errors); });
            }

            if (rowsInc.length >= 2) {
                pending++;
                runServerCall('v3_parseIncidents', [rowsInc], function(res) {
                    pending--;
                    if (!res.success) { errors.push('Incidents: ' + res.error); }
                    else { importState.incidents = res; }
                    if (pending === 0) finishComportement(errors);
                }, function(err) { pending--; errors.push('Incidents: ' + (err.message || err)); if (pending === 0) finishComportement(errors); });
            }

            if (pending === 0) finishComportement(errors);
        }

        function finishComportement(errors) {
            if (errors && errors.length > 0) {
                showToast('Erreurs : ' + errors.join('; '), 'error');
            }
            var cp = importState.punitions ? importState.punitions.count : 0;
            var cr = importState.retenues ? importState.retenues.count : 0;
            var ci = importState.incidents ? importState.incidents.count : 0;
            if (cp > 0 || cr > 0 || ci > 0) {
                updateImportBadge('comportement', 'done', cp + 'P ' + cr + 'R ' + ci + 'I');
            }
            updateImportSummary();
            showToast('Comportement : ' + cp + ' punitions, ' + cr + ' retenues, ' + ci + ' incidents', 'success');
        }

        // --- Compilation finale ---
        function runCompileImport() {
            if (!importState.eleves || importState.eleves.count === 0) {
                showToast('Aucun eleve charge ‚Äî completez l\'etape 1', 'error');
                return;
            }

            setLoading('btn-compile-import', true);
            showToast('Compilation en cours... cela peut prendre quelques secondes', 'info');

            var data = {
                eleves: importState.eleves,
                notes: importState.notes,
                absences: importState.absences,
                punitions: importState.punitions,
                retenues: importState.retenues,
                incidents: importState.incidents,
                observations: importState.observations
            };

            runServerCall('v3_compileImport', [data], function(res) {
                setLoading('btn-compile-import', false);
                if (!res.success) { showModal('Erreur compilation : ' + res.error, 'error'); return; }

                var s = res.summary;
                var resultEl = document.getElementById('import-result');
                resultEl.style.display = 'block';

                document.getElementById('import-result-content').innerHTML =
                    '<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">' +
                    '<div style="background:#0f172a;padding:15px;border-radius:8px;text-align:center;">' +
                        '<div style="font-size:28px;font-weight:900;color:var(--success);">' + (s.totalStudents || 0) + '</div>' +
                        '<div style="font-size:11px;color:#94a3b8;font-weight:700;">ELEVES IMPORTES</div></div>' +
                    '<div style="background:#0f172a;padding:15px;border-radius:8px;text-align:center;">' +
                        '<div style="font-size:28px;font-weight:900;color:var(--primary);">' + (s.classesProcessed || 0) + '</div>' +
                        '<div style="font-size:11px;color:#94a3b8;font-weight:700;">CLASSES</div></div>' +
                    '<div style="background:#0f172a;padding:15px;border-radius:8px;text-align:center;">' +
                        '<div style="font-size:28px;font-weight:900;color:#eab308;">' + (s.scoresCalculated || 0) + '</div>' +
                        '<div style="font-size:11px;color:#94a3b8;font-weight:700;">SCORES CALCULES</div></div>' +
                    '</div>' +
                    '<div style="font-size:13px;color:#94a3b8;">' +
                    'Classes : <strong style="color:white;">' + (s.classesList || []).join(', ') + '</strong>' +
                    '</div>';

                // Afficher suggestions DISSO si presentes
                if (res.dissoSuggestions && res.dissoSuggestions.length > 0) {
                    var dissoEl = document.getElementById('import-disso-suggestions');
                    if (dissoEl) {
                        dissoEl.style.display = 'block';
                        var dhtml = '';
                        for (var g = 0; g < res.dissoSuggestions.length; g++) {
                            var group = res.dissoSuggestions[g];
                            dhtml += '<div style="margin-bottom:8px;">';
                            dhtml += '<span style="font-weight:700; color:#f59e0b;">Lot ' + (g + 1) + ' :</span> ';
                            for (var s2 = 0; s2 < group.length; s2++) {
                                dhtml += '<span style="background:#1e293b; padding:3px 8px; border-radius:6px; margin:2px; display:inline-block; font-size:12px; color:#e2e8f0;">';
                                dhtml += escapeHtml(group[s2].nom + ' ' + group[s2].prenom) + ' <span style="color:#ef4444;">(' + group[s2].score + ')</span>';
                                dhtml += '</span>';
                            }
                            dhtml += '</div>';
                        }
                        document.getElementById('disso-groups-content').innerHTML = dhtml;
                    }
                }

                showToast('Import termine ! ' + (s.totalStudents || 0) + ' eleves importes.', 'success');
                saveProgress('scores');
            }, function(err) {
                setLoading('btn-compile-import', false);
                showModal('Erreur serveur : ' + (err.message || err), 'error');
            });
        }

        // ===================================================================
        // 6. STATS
        // ===================================================================
        function loadStats() {
            const el = document.getElementById('stats-effectifs');
            if(el) el.innerHTML = '‚è≥';
            
            runServerCall('v3_getStats', [], stats => {
                if (!stats.success) return; 
                
                cachedStats = stats; // Mise √† jour du cache pour l'onglet Structure
                
                if(document.getElementById('stats-effectifs')) document.getElementById('stats-effectifs').innerHTML = stats.effectifs.total;
                if(document.getElementById('metric-eleves')) document.getElementById('metric-eleves').innerHTML = stats.effectifs.total;
                if(document.getElementById('stats-parite')) document.getElementById('stats-parite').innerHTML = `F: ${stats.parite.F} | M: ${stats.parite.M}`;
                
                const render = (obj, id) => {
                    let h = '<table style="width:100%">';
                    for(const [k,v] of Object.entries(obj)) h += `<tr><td style="padding:4px">${escapeHtml(k)}</td><td style="text-align:right;font-weight:bold">${escapeHtml(v)}</td></tr>`;
                    h += '</table>';
                    const target = document.getElementById(id);
                    if(target) target.innerHTML = h || 'Aucun';
                };
                
                render(stats.lv2, 'stats-lv2');
                render(stats.options, 'stats-options');
                render(stats.combos, 'stats-combos');
                render(stats.dispositifs, 'stats-dispositifs');
                
                if(document.getElementById('stats-asso')) document.getElementById('stats-asso').innerHTML = `<b>${stats.asso.codes}</b> codes<br>${stats.asso.eleves} √©l√®ves`;
                if(document.getElementById('stats-disso')) document.getElementById('stats-disso').innerHTML = `<b>${stats.disso.codes}</b> codes<br>${stats.disso.eleves} √©l√®ves`;

            }, err => console.error(err));
        }

        // ===================================================================
        // 7. MOTEUR STRUCTURE (LE FIX ESP+LATIN)
        // ===================================================================
        function loadStructure() {
            console.log("üì• Chargement Structure...");
            runServerCall('v3_getStructureDataForEditor', [], data => {
                if (!data.success) return showModal(data.error, 'error');
                
                currentStructure = data;
                
                // Important : si les stats viennent avec la structure, on met √† jour le cache
                if (data.stats && data.stats.global) {
                    cachedStats = data.stats;
                }
                
                renderStructureTable(data);
                triggerGlobalUpdate(); // Lancement imm√©diat du calcul
            }, err => showModal(err.message, 'error'));
        }

        function renderStructureTable(data) {
            const thead = document.getElementById('struct-header');
            const tbody = document.getElementById('struct-body');
            if(!thead || !tbody) return;
            
            let h = '<th style="text-align:left;padding-left:10px;">CLASSE</th><th>CAPACIT√â</th>';
            data.lv2.forEach(k => h += `<th>${escapeHtml(k)}</th>`);
            data.options.forEach(k => h += `<th>${escapeHtml(k)}</th>`);
            thead.innerHTML = `<tr>${h}</tr>`;

            tbody.innerHTML = '';
            data.classes.forEach((cls, i) => {
                const tr = document.createElement('tr');

                let html = `<td><input type="text" value="${escapeHtml(cls.name)}"
                    onchange="updateData(${i},'name',this.value)"
                    style="text-align:left!important;padding-left:10px;font-size:14px;font-weight:bold"></td>`;

                html += `<td><input type="number" value="${cls.capacity}"
                    onchange="updateData(${i},'capacity',this.value)"
                    style="color:#eab308;font-weight:bold"></td>`;

                [...data.lv2, ...data.options].forEach(k => {
                    const val = cls.quotas[k] || 0;
                    const style = val === 0 ? 'color:#475569;font-weight:normal' : 'color:white;font-weight:bold';
                    html += `<td><input type="number" value="${val}"
                        onchange="updateQuota(${i},'${escapeHtml(k)}',this.value)"
                        style="${style}"></td>`;
                });
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });

            const totRow = document.createElement('tr');
            totRow.id = 'totals-row';
            totRow.style.background = '#0f172a';
            totRow.style.borderTop = '3px solid #334155';
            tbody.appendChild(totRow);
        }

        function updateData(idx, field, val) {
            if (!currentStructure) return;
            if (field === 'capacity') val = parseInt(val) || 0;
            currentStructure.classes[idx][field] = val;
            triggerGlobalUpdate();
        }

        function updateQuota(idx, key, val) {
            if (!currentStructure) return;
            const v = parseInt(val) || 0;
            currentStructure.classes[idx].quotas[key] = v;
            
            if (event && event.target) {
                event.target.style.color = v === 0 ? '#475569' : 'white';
                event.target.style.fontWeight = v === 0 ? 'normal' : 'bold';
            }
            triggerGlobalUpdate();
        }

        // === LE C≈íUR DU MOTEUR ===
        function triggerGlobalUpdate() {
            if (!currentStructure) return;

            // 1. Calculer les sommes des colonnes
            const totals = { capacity: 0, counts: {} };
            [...currentStructure.lv2, ...currentStructure.options].forEach(k => totals.counts[k] = 0);

            currentStructure.classes.forEach(cls => {
                totals.capacity += parseInt(cls.capacity) || 0;
                for (const [k, v] of Object.entries(cls.quotas)) {
                    if (totals.counts[k] !== undefined) totals.counts[k] += (parseInt(v) || 0);
                }
            });

            // Mise √† jour chiffre global (sous tableau)
            const capEl = document.getElementById('total-cap');
            if(capEl) capEl.innerText = totals.capacity;

            // 2. Rendu Ligne Totaux (Blind√© contre undefined)
            const tr = document.getElementById('totals-row');
            if (tr) {
                const s = cachedStats || {};
                const effectifTotal = (s.effectifs && s.effectifs.total) ? s.effectifs.total : 0;
                const targets = s.global || {}; // Objectifs par mati√®re

                let capCol = '#f8fafc';
                if (effectifTotal > 0) {
                    if (totals.capacity === effectifTotal) capCol = '#22c55e';
                    else if (totals.capacity > effectifTotal) capCol = '#ef4444';
                }

                let html = `<td style="text-align:right;padding:10px;color:#94a3b8;font-size:12px;font-weight:bold">TOTAUX</td>`;
                html += `<td style="text-align:center;font-size:20px;font-weight:900;color:${capCol}">${totals.capacity}</td>`;

                [...currentStructure.lv2, ...currentStructure.options].forEach(k => {
                    const offer = totals.counts[k] || 0;
                    const demand = targets[k] || 0;
                    
                    let col = '#f8fafc';
                    if (demand > 0) {
                        if (offer === demand) col = '#22c55e';
                        else if (offer > demand) col = '#ef4444';
                    }
                    html += `<td style="text-align:center;font-size:18px;font-weight:900;color:${col}">${offer}</td>`;
                });
                tr.innerHTML = html;
            }

            // 3. Rendu Panneau Droite
            renderRightPanel(totals, cachedStats);
        }

        function renderRightPanel(totals, stats) {
            const s = stats || { effectifs: { total: 0 }, global: {}, combos: {} };
            const targets = s.global || {};
            const effTotal = (s.effectifs && s.effectifs.total) ? s.effectifs.total : 0;

            // En-t√™te
            const diff = totals.capacity - effTotal;
            const col = diff < 0 ? '#eab308' : (diff === 0 ? '#22c55e' : '#ef4444');
            
            const plEl = document.getElementById('metric-places');
            if(plEl) {
                plEl.innerHTML = `
                <div style="margin-bottom:5px;">
                    <div style="font-size:11px;color:#94a3b8;font-weight:700">BESOIN</div>
                    <div style="font-size:24px;font-weight:900;color:white;">${effTotal}</div>
                </div>
                <div style="border-top:1px solid #334155; padding-top:5px;">
                    <div style="font-size:11px;color:#94a3b8;font-weight:700">OFFRE</div>
                    <div style="font-size:24px;font-weight:900;color:${col}">${totals.capacity}</div>
                </div>`;
            }

            const renderRow = (code, demand, offer) => {
                let c = '#eab308';
                if (offer === demand) c = '#22c55e';
                else if (offer > demand) c = '#ef4444';
                const w = demand > 0 ? Math.min(100, (offer / demand) * 100) : 0;
                return `<div style="margin-bottom:5px;padding:5px;background:rgba(255,255,255,0.03);border-radius:4px">
                    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px">
                        <span style="font-weight:bold;color:white">${escapeHtml(code)}</span>
                        <span style="color:${c}">${offer} / ${demand}</span>
                    </div>
                    <div style="height:4px;background:#1e293b;border-radius:2px;overflow:hidden"><div style="width:${w}%;background:${c};height:100%"></div></div>
                </div>`;
            };

            const renderComboRow = (code, students, seats) => {
                const demand = Math.max(0, parseInt(students) || 0);   // √©l√®ves
                const offer = Math.max(0, parseInt(seats) || 0);        // places compatibles
                let c = '#eab308';
                if (demand === offer && offer > 0) c = '#22c55e';
                else if (demand > offer) c = '#ef4444';
                const w = offer > 0 ? Math.min(100, (demand / offer) * 100) : 0;
                return `<div style="margin-bottom:5px;padding:5px;background:rgba(255,255,255,0.03);border-radius:4px">
                    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px">
                        <span style="font-weight:bold;color:white">${escapeHtml(code)}</span>
                        <span style="color:${c}">${demand} √©l√®ves / ${offer} places</span>
                    </div>
                    <div style="height:4px;background:#1e293b;border-radius:2px;overflow:hidden"><div style="width:${w}%;background:${c};height:100%"></div></div>
                </div>`;
            };

            // LV2
            let h = '';
            currentStructure.lv2.forEach(k => h += renderRow(k, targets[k] || 0, totals.counts[k] || 0));
            const qLv2 = document.getElementById('quota-lv2');
            if(qLv2) qLv2.innerHTML = h;

            // OPT
            h = '';
            currentStructure.options.forEach(k => h += renderRow(k, targets[k] || 0, totals.counts[k] || 0));
            const qOpt = document.getElementById('quota-options');
            if(qOpt) qOpt.innerHTML = h;

            // COMBOS - calcul stricte LV2 √ó Option sans agr√©gat cross-LV2
            h = '';

            // Map normalis√©e des combos disponibles (√©vite tout m√©lange ESP/ITA)
            const comboMap = {};
            if (s.combos) {
                Object.entries(s.combos).forEach(([key, value]) => {
                    const [lv2Part, optPart] = String(key).split('+').map(p => p.trim().toUpperCase());
                    if (!lv2Part || !optPart) return;
                    comboMap[`${lv2Part} + ${optPart}`] = parseInt(value) || 0;
                });
            }

            // On parcourt explicitement chaque couple LV2/Option de la structure pour √©viter tout cumul involontaire
            const lv2ListUpper = (currentStructure.lv2 || []).map(c => String(c).trim().toUpperCase());
            (currentStructure.lv2 || []).forEach(lv2Code => {
                (currentStructure.options || []).forEach(optCode => {
                    const lv2Upper = String(lv2Code).trim().toUpperCase();
                    const optUpper = String(optCode).trim().toUpperCase();
                    const demand = comboMap[`${lv2Upper} + ${optUpper}`] || 0;
                    if (demand === 0) return; // n'afficher que les combos r√©ellement pr√©sents

                    // Intersection des quotas par classe (places r√©ellement compatibles)
                    let seats = 0;
                    currentStructure.classes.forEach(cls => {
                        const quotasUpper = {};
                        Object.keys(cls.quotas).forEach(key => {
                            quotasUpper[key.toUpperCase()] = cls.quotas[key];
                        });

                        const qLv2 = parseInt(quotasUpper[lv2Upper] || 0);
                        const qOpt = parseInt(quotasUpper[optUpper] || 0);

                        // Classe incompatible si une autre LV2 a un ratio PARFAIT avec l'option (quotas quasi-identiques)
                        if (qLv2 <= 0 || qOpt <= 0) return;
                        const hasConflictingLv2 = lv2ListUpper.some(otherLv2 => {
                            if (otherLv2 === lv2Upper) return false;
                            const qOther = parseInt(quotasUpper[otherLv2] || 0);
                            if (qOther <= 0) return false;
                            // Une LV2 monopolise l'option si les quotas sont quasi-identiques (diff√©rence ‚â§ 1)
                            const diff = Math.abs(qOther - qOpt);
                            return diff <= 1; // Ratio parfait ou presque (ex: 8/8, 11/11, 10/11)
                        });
                        if (hasConflictingLv2) return;

                        seats += Math.min(qLv2, qOpt);
                    });

                    h += renderComboRow(`${lv2Code} + ${optCode}`, demand, seats);
                });
            });

            const qComb = document.getElementById('quota-combos');
            if(qComb) qComb.innerHTML = h || '<div style="color:#64748b;font-size:11px">Aucun</div>';
        }

        // ===================================================================
        // 8. FINALISATION
        // ===================================================================
        function saveStructure() {
            setLoading('btn-save-struct', true);
            runServerCall('v3_saveStructureFromEditor', [currentStructure], res => {
                setLoading('btn-save-struct', false);
                if (res.success) {
                    showToast('Structure sauvegard√©e !', 'success');
                    saveProgress(5);
                    setTimeout(() => goTo(5), 1000);
                } else showModal(res.error, 'error');
            }, err => showModal(err.message, 'error'));
        }

        function runEngine() {
            setLoading('btn-engine', true);
            runServerCall('v3_runGeneration', [], res => {
                setLoading('btn-engine', false);
                if (res.success) {
                    showToast('Calcul termin√©', 'success');
                    saveProgress(6);
                    setTimeout(() => goTo(6), 1000);
                } else showModal(res.error, 'error');
            }, err => showModal(err.message, 'error'));
        }

        /**
         * Ouvre l'Interface V2 dans une nouvelle fen√™tre du navigateur
         * puis ferme la Console Pilotage
         */
        function openInterfaceV2() {
            const interfaceURL = 'https://script.google.com/macros/s/AKfycbwb6XbvEQjbskiqsMlKUa1EPXicH8bCu6fTxpyiKl0Oh47nRFJKcUy2IsNDWQsbbXltjQ/exec';
            
            // Ouvrir l'Interface V2 dans un nouvel onglet
            window.open(interfaceURL, '_blank');
            
            // Afficher un message de confirmation
            showToast('Interface V2 ouverte dans un nouvel onglet', 'success');
            
            // Fermer la Console Pilotage apr√®s un court d√©lai
            setTimeout(() => {
                google.script.host.close();
            }, 1500);
        }

    </script>
</body>
</html>