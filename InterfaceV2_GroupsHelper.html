<script>
  // ========== MODULE DE GROUPES V2 - INTERFACE CLARIFI√âE ==========

  function addGroupsButton() {

    const nav = document.querySelector('.app-header nav');
    if (!nav || document.getElementById('btnGroups')) return;

    // Cr√©er un wrapper pour le bouton et son menu
    const groupsWrapper = document.createElement('div');
    groupsWrapper.className = 'relative';
    groupsWrapper.id = 'groupsMenuWrapper';

    // Bouton principal avec fl√®che
    const btnGroups = document.createElement('button');
    btnGroups.id = 'btnGroups';
    btnGroups.className = 'btn btn-primary flex items-center gap-1';
    btnGroups.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';

    // Menu d√©roulant
    const dropdown = document.createElement('div');
    dropdown.id = 'groupsDropdown';
    dropdown.className = 'absolute right-0 mt-2 w-64 bg-white rounded shadow-lg z-50 hidden p-2';
    dropdown.innerHTML = `
    <div class="px-2 py-2 border-b border-gray-200 mb-2">
      <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Param√®tres Groupes</div>
      <label class="flex items-center gap-2 text-sm cursor-pointer">
        <input type="checkbox" id="toggleHeaderGroups" onchange="toggleHeaderGroups(this.checked)">
        <span>Afficher le bouton Groupes dans le header</span>
      </label>
    </div>
    <button onclick="openGroupsInterface()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-plus-circle text-green-600"></i> Cr√©er des groupes
    </button>
    <button onclick="openGroupsInterface('manager')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-cog text-blue-600"></i> G√©rer les groupes
    </button>
    <button onclick="openGroupsInterface('templates')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-layer-group text-purple-600"></i> Mod√®les de groupes
    </button>
    <hr class="my-2 border-gray-200">
    <button onclick="exportGroupsData()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-download text-purple-600"></i> Exporter tous les groupes
    </button>
    <button onclick="confirmDeleteAllGroups()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-red-600">
      <i class="fas fa-trash"></i> Supprimer tous les groupes
    </button>
  `;

    groupsWrapper.appendChild(btnGroups);
    groupsWrapper.appendChild(dropdown);

    // G√©rer l'ouverture/fermeture du menu
    btnGroups.addEventListener('click', (e) => {
      e.stopPropagation();
      // Fermer tous les autres dropdowns
      document.querySelectorAll('.app-header .absolute').forEach(d => {
        if (d !== dropdown) d.classList.add('hidden');
      });
      dropdown.classList.toggle('hidden');
    });

    // Fermer le menu si on clique ailleurs
    document.addEventListener('click', () => {
      dropdown.classList.add('hidden');
    });

    dropdown.addEventListener('click', e => e.stopPropagation());

    // Placement id√©al: entre Brouillon (#btnSaveWIP) et √âdition (#btnEdition)
    const btnBrouillon = document.getElementById('btnSaveWIP');
    const btnEdition = document.getElementById('btnEdition');
    if (btnBrouillon && btnBrouillon.parentElement) {
      btnBrouillon.insertAdjacentElement('afterend', groupsWrapper);
    } else if (btnEdition && btnEdition.parentElement) {
      btnEdition.parentElement.insertBefore(groupsWrapper, btnEdition);
    } else {
      nav.appendChild(groupsWrapper);
    }

    // Initialiser l'√©tat du toggle √† partir du serveur
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function (settings) {
          const cb = document.getElementById('toggleHeaderGroups');
          if (cb && settings) cb.checked = !!settings.SHOW_GROUPS_BUTTON;
        })
        .withFailureHandler(function (err) { console.error('Erreur getUiSettings:', err); })
        .getUiSettings();
    }
  }

  // Retirer le bouton Groupes du header si pr√©sent
  function removeGroupsButton() {
    const wrapper = document.getElementById('groupsMenuWrapper') || document.getElementById('btnGroups')?.parentElement;
    if (wrapper && wrapper.parentElement) {
      wrapper.parentElement.removeChild(wrapper);
    }
  }

  // Handler pour le toggle dans le menu Groupes
  function toggleHeaderGroups(checked) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function () {
          if (checked) { addGroupsButton(); } else { removeGroupsButton(); }
          if (typeof toast === 'function') toast(checked ? 'Bouton Groupes activ√©' : 'Bouton Groupes d√©sactiv√©', 'success');
        })
        .withFailureHandler(function (err) {
          console.error('Erreur setUiSettings:', err);
          if (typeof toast === 'function') toast('Erreur: ' + err.message, 'error');
        })
        .setUiSettings({ SHOW_GROUPS_BUTTON: !!checked });
    }
  }

  // Mettre √† jour le bouton pour afficher le nombre de groupes - Version modulaire
  function updateGroupsButton() {
    const btn = document.getElementById('btnGroups');
    if (btn) {
      // R√©cup√©rer le nombre de groupes depuis le serveur
      google.script.run
        .withSuccessHandler(function (count) {
          if (count > 0) {
            btn.innerHTML = `<i class="fas fa-layer-group"></i> Groupes <span class="bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full text-xs ml-1">${count}</span> <i class="fas fa-caret-down"></i>`;
          } else {
            btn.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
          }
        })
        .getGroupsCount();
    }
  }

  // Fonction pour notifier les changements de groupes
  function notifyGroupsChanged() {
    updateGroupsButton();
    // Autres actions √† effectuer quand les groupes changent
  }

  // ========== CODE √Ä AJOUTER/MODIFIER DANS INTERFACEV2.HTML ==========

  // 1. Fonction unifi√©e openGroupsInterface - utilise le nouveau GroupsModuleComplete (modal int√©gr√©e)
  function openGroupsInterface(tab = 'creator') {

    // V√©rifier si GroupsModuleComplete est disponible (groupsModuleComplete.html)
    if (typeof window !== 'undefined' && window.GroupsModuleComplete && typeof window.GroupsModuleComplete.open === 'function') {
      try {
        window.GroupsModuleComplete.open();
        return;
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'ouverture de GroupsModuleComplete:', error);
      }
    }

    // FALLBACK : Si GroupsModuleComplete n'est pas disponible, utiliser l'ancienne interface popup
    console.warn('‚ö†Ô∏è GroupsModuleComplete non disponible, fallback vers interface popup...');
    google.script.run
      .withSuccessHandler(function (html) {
        try {
          const groupsWindow = window.open('', 'GroupsManager', 'width=1400,height=900,menubar=no,toolbar=no,scrollbars=yes,resizable=yes');

          if (!groupsWindow || groupsWindow.closed || typeof groupsWindow.closed === 'undefined') {
            console.error('‚ùå Impossible d\'ouvrir la fen√™tre popup - bloqu√©e par le navigateur');
            alert('‚ö†Ô∏è Impossible d\'ouvrir l\'interface des groupes. Veuillez autoriser les popups pour ce site et r√©essayer.');
            return;
          }

          groupsWindow.document.open();
          groupsWindow.document.write(html);
          groupsWindow.document.close();

          const checkInterval = setInterval(() => {
            try {
              if (groupsWindow.GroupsUI && typeof groupsWindow.GroupsUI.switchTab === 'function') {
                clearInterval(checkInterval);
                groupsWindow.GroupsUI.switchTab(tab);
              }
            } catch (uiError) {
              clearInterval(checkInterval);
            }
          }, 100);

          setTimeout(() => clearInterval(checkInterval), 5000);
        } catch (error) {
          console.error('‚ùå Erreur lors de l\'ouverture de l\'interface:', error);
          alert('Erreur lors de l\'ouverture de l\'interface des groupes: ' + error.message);
        }
      })
      .withFailureHandler(function (error) {
        console.error('‚ùå Erreur serveur:', error);
        alert('Impossible de charger l\'interface des groupes: ' + error.message);
      })
      .getGroupsInterface();
  }

  // 2. Fonction pour notifier les changements de groupes
  window.notifyGroupsChanged = function () {
    updateGroupsButton();

    // Afficher un message de confirmation
    if (typeof toast === 'function') {
      toast('Groupes mis √† jour avec succ√®s', 'success');
    }
  };

  // 3. Fonction d'export am√©lior√©e
  function exportGroupsData() {
    console.log('üì§ Export des groupes...');

    google.script.run
      .withSuccessHandler(function (groupsData) {
        if (!groupsData || Object.keys(groupsData).length === 0) {
          alert('Aucun groupe √† exporter');
          return;
        }

        // Cr√©er le CSV avec point-virgule comme s√©parateur (compatible Excel FR)
        let csv = 'Type;Groupe;Nom;Pr√©nom;Sexe;Classe d\'origine;Langue;Score COM;Score TRA;Score PART;Score ABS;Score Maths;Score Fran√ßais\n';

        Object.entries(groupsData).forEach(([groupName, groupData]) => {
          groupData.students.forEach(student => {
            // Construire la ligne sans guillemets inutiles
            const line = [
              groupData.type || 'N/A',
              groupName,
              student.nom || '',
              student.prenom || '',
              student.sexe || '',
              student.classe || '',
              student.lv1Badge || student.lv1 || '', // Badge de langue ou valeur brute
              student.com || 0,
              student.tra || 0,
              student.part || 0,
              student.abs || 0,
              student.scores?.M || 0,
              student.scores?.F || 0
            ];

            csv += line.join(';') + '\n';
          });
        });

        // T√©l√©charger le fichier
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `export_groupes_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        toast('Export CSV g√©n√©r√© avec succ√®s', 'success');
      })
      .withFailureHandler(function (error) {
        console.error('Erreur export:', error);
        alert('Erreur lors de l\'export: ' + error.message);
      })
      .getAllGroups();
  }

  // 4. Fonction de suppression avec confirmation am√©lior√©e
  function confirmDeleteAllGroups() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
    modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
      <h3 class="text-lg font-bold mb-4 text-red-600">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        Suppression de tous les groupes
      </h3>
      <p class="text-gray-700 mb-6">
        Cette action supprimera d√©finitivement tous les groupes cr√©√©s. 
        Cette op√©ration est irr√©versible.
      </p>
      <div class="flex justify-end gap-3">
        <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
          Annuler
        </button>
        <button onclick="deleteAllGroups(); this.closest('.fixed').remove();" class="btn btn-danger">
          <i class="fas fa-trash mr-2"></i>
          Supprimer tout
        </button>
      </div>
    </div>
  `;
    document.body.appendChild(modal);
  }

  function deleteAllGroups() {
    google.script.run
      .withSuccessHandler(function (success) {
        if (success) {
          updateGroupsButton();
          toast('Tous les groupes ont √©t√© supprim√©s', 'success');
        } else {
          toast('Erreur lors de la suppression', 'error');
        }
      })
      .withFailureHandler(function (error) {
        console.error('Erreur suppression:', error);
        toast('Erreur: ' + error.message, 'error');
      })
      .deleteAllGroups();
  }



  // ========== FONCTIONS SUPPL√âMENTAIRES ==========

  // Fonction pour ajouter des scores de mati√®res
  window.addSubjectScores = function () {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="text-xl font-bold">Ajouter des scores de mati√®res</h2>
        <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="bg-blue-50 p-3 rounded mb-4">
          <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-1"></i>
            Importez un fichier Excel avec les colonnes : ID, MATH, FR
            ou saisissez manuellement les scores.
          </p>
        </div>
        
        <div class="mb-4">
          <button onclick="importSubjectScores()" class="btn btn-primary w-full">
            <i class="fas fa-upload"></i> Importer depuis Excel
          </button>
        </div>
        
        <div class="text-center text-gray-500 my-4">ou</div>
        
        <div>
          <h3 class="font-bold mb-2">Saisie manuelle rapide</h3>
          <div class="text-xs text-gray-600 mb-2">
            S√©lectionnez une classe et attribuez des scores al√©atoires pour tester
          </div>
          <select id="classForScores" class="form-control mb-2">
            <option value="">-- S√©lectionner une classe --</option>
            ${Array.from(document.querySelectorAll('.classe-name'))
        .map(el => `<option value="${el.textContent}">${el.textContent}</option>`)
        .join('')}
          </select>
          <button onclick="generateRandomScores()" class="btn btn-secondary w-full">
            <i class="fas fa-dice"></i> G√©n√©rer des scores al√©atoires
          </button>
        </div>
      </div>
    </div>
  `;
    document.body.appendChild(modal);
  };

  // G√©n√©rer des scores al√©atoires pour tester
  window.generateRandomScores = function () {
    const classe = document.getElementById('classForScores').value;
    if (!classe) {
      toast('S√©lectionnez une classe', 'warning');
      return;
    }

    const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
    if (!zone) return;

    let count = 0;
    zone.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve) {
        // G√©n√©rer des scores coh√©rents avec le comportement
        const baseScore = eleve.scores?.C || 2.5;
        const variance = 0.5;

        eleve.scores.MATH = Math.max(1, Math.min(4,
          baseScore + (Math.random() - 0.5) * 2 * variance
        ));

        eleve.scores.FR = Math.max(1, Math.min(4,
          baseScore + (Math.random() - 0.5) * 2 * variance
        ));

        count++;
      }
    });

    toast(`${count} scores g√©n√©r√©s pour ${classe}`, 'success');
    document.querySelector('.modal').remove();
  };

</script>
