<script>
(function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ›¡ï¸ DOM ENVIRONMENT GUARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (typeof document === 'undefined') {
    console.warn('[GroupsInterfaceV4] Skipping client-side code in server context');
    return;
  }
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * GROUPS INTERFACE V4 - TRIPTYQUE
 * Interface utilisateur en trois volets pour la crÃ©ation de groupes
 * Architecture : Volet A (30%) - Volet B (40%) - Volet C (30%)
 */

const GroupsInterfaceV4 = (function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYSTÃˆME DE NOTIFICATIONS TOAST
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const GroupsNotifications = {
    container: null,

    init() {
      if (!this.container) {
        this.container = document.createElement('div');
        this.container.id = 'toast-container';
        document.body.appendChild(this.container);
      }
    },

    show(title, message, type = 'info', duration = 4000) {
      this.init();

      const toast = document.createElement('div');
      toast.className = `groups-toast toast-${type}`;

      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      toast.innerHTML = `
        <div class="toast-icon">
          <i class="fas ${icons[type] || icons.info}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" aria-label="Fermer">
          <i class="fas fa-times"></i>
        </button>
      `;

      this.container.appendChild(toast);

      // Fermer au clic
      const closeBtn = toast.querySelector('.toast-close');
      closeBtn.addEventListener('click', () => this.remove(toast));

      // Auto-fermeture
      if (duration > 0) {
        setTimeout(() => this.remove(toast), duration);
      }

      return toast;
    },

    remove(toast) {
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    },

    success(title, message, duration) {
      return this.show(title, message, 'success', duration);
    },

    error(title, message, duration) {
      return this.show(title, message, 'error', duration);
    },

    warning(title, message, duration) {
      return this.show(title, message, 'warning', duration);
    },

    info(title, message, duration) {
      return this.show(title, message, 'info', duration);
    }
  };

  const normalizeStudentForUI = student => {
    if (!student) return null;

    if (window.GroupsModuleV4Utils && typeof window.GroupsModuleV4Utils.normalizeStudentForResults === 'function') {
      return window.GroupsModuleV4Utils.normalizeStudentForResults(student);
    }

    const coerceNumber = (...values) => {
      for (const value of values) {
        if (value === undefined || value === null || value === '') continue;
        const num = parseFloat(value);
        if (!isNaN(num) && isFinite(num)) {
          return num;
        }
      }
      return 0;
    };

    const collectOptions = () => {
      if (Array.isArray(student.options)) return student.options;
      if (Array.isArray(student.optionsList)) return student.optionsList;
      const raw = student.opt || student.optionsRaw || student.optionsString || student.options;
      if (typeof raw === 'string' && raw.trim() !== '') {
        return raw.split(/[;,/]/).map(opt => opt.trim()).filter(Boolean);
      }
      return [];
    };

    const lastName = (student.lastName || student.nom || '').toString().trim();
    const firstName = (student.firstName || student.prenom || '').toString().trim();
    const classe = (student.class || student.classe || student.className || '').toString().trim();
    const sourceClass = (student.SOURCE || student.source || student._SOURCE_CLASS || classe || '').toString().trim() || classe;
    const lv2 = (student.lv2 || student.LV2 || '').toString().trim().toUpperCase() || 'ESP';
    const sexe = (student.sexe || student.gender || '').toString().trim().toUpperCase();

    const optionsArray = collectOptions().map(opt => opt.toString().trim()).filter(Boolean);
    const normalizedOptions = optionsArray.map(opt => opt.toUpperCase());
    const optionsString = typeof student.opt === 'string' && student.opt.trim() !== ''
      ? student.opt.trim()
      : normalizedOptions.join(';');

    const scoreF = coerceNumber(student.scoreF, student.scores?.F, student.scores?.SCOREF, student.besoinsF);
    const scoreM = coerceNumber(student.scoreM, student.scores?.M, student.scores?.SCOREM, student.besoinsM);
    const com = coerceNumber(student.com, student.scores?.COM);
    const tra = coerceNumber(student.tra, student.scores?.TRA);
    const part = coerceNumber(student.part, student.scores?.PART);
    const abs = coerceNumber(student.abs, student.scores?.ABS);

    return {
      ...student,
      id: (student.id || '').toString().trim(),
      lastName,
      nom: lastName,
      firstName,
      prenom: firstName,
      sexe,
      gender: sexe,
      class: classe,
      classe,
      className: student.className || classe,
      SOURCE: sourceClass,
      source: sourceClass,
      _SOURCE_CLASS: sourceClass,
      lv2,
      LV2: lv2,
      opt: optionsString,
      options: normalizedOptions,
      optionsList: normalizedOptions,
      scores: {
        F: scoreF,
        M: scoreM,
        COM: com,
        TRA: tra,
        PART: part,
        ABS: abs
      },
      scoreF,
      scoreM,
      com,
      tra,
      part,
      abs
    };
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WRAPPER GOOGLE SCRIPT RUN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Wrapper pour google.script.run avec promesses et gestion d'erreur
   */
  function gsRun(functionName, ...args) {
    return new Promise((resolve, reject) => {
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        reject(new Error('Google Script API non disponible. Assurez-vous que ce code s\'exÃ©cute dans Google Apps Script.'));
        return;
      }

      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        [functionName](...args);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // JOYSTICK CONTROLLER - ContrÃ´le interactif des pondÃ©rations
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const JoystickController = {
    /**
     * CrÃ©e un joystick interactif (sliders) pour ajuster les pondÃ©rations des critÃ¨res
     * @param {Object} initialWeights - { com: 1, tra: 1, part: 1, abs: 1 }
     * @param {Function} onChange - Callback appelÃ© lors du changement (weights) => {...}
     * @returns {HTMLElement} - Ã‰lÃ©ment DOM du joystick
     */
    create(initialWeights = { com: 1, tra: 1, part: 1, abs: 1 }, onChange = null) {
      const container = document.createElement('div');
      container.className = 'joystick-controller';
      container.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      `;

      const weights = { ...initialWeights };

      // Fonction de normalisation (somme = 4)
      const normalize = () => {
        const total = weights.com + weights.tra + weights.part + weights.abs;
        if (total === 0) return;
        const factor = 4 / total;
        weights.com *= factor;
        weights.tra *= factor;
        weights.part *= factor;
        weights.abs *= factor;
      };

      // CritÃ¨res avec couleurs
      const criteria = [
        { key: 'com', label: 'Comportement', color: '#ef4444', icon: 'fa-user-shield' },
        { key: 'tra', label: 'Travail', color: '#3b82f6', icon: 'fa-book' },
        { key: 'part', label: 'Participation', color: '#10b981', icon: 'fa-hand-paper' },
        { key: 'abs', label: 'Absences', color: '#f59e0b', icon: 'fa-calendar-times' }
      ];

      // Header
      container.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: #1f2937;">
            <i class="fas fa-sliders-h"></i> PondÃ©rations des critÃ¨res
          </h3>
          <p style="margin: 0; font-size: 12px; color: #6b7280;">
            Ajustez l'importance de chaque critÃ¨re (total = 4)
          </p>
        </div>
      `;

      // CrÃ©er les sliders
      criteria.forEach(criterion => {
        const sliderDiv = document.createElement('div');
        sliderDiv.style.marginBottom = '16px';

        sliderDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 8px;">
              <i class="fas ${criterion.icon}" style="color: ${criterion.color}; width: 16px;"></i>
              <span>${criterion.label}</span>
            </label>
            <span class="weight-value" data-key="${criterion.key}" style="
              font-size: 14px;
              font-weight: 700;
              color: ${criterion.color};
              min-width: 40px;
              text-align: right;
            ">${weights[criterion.key].toFixed(2)}</span>
          </div>
          <input
            type="range"
            min="0"
            max="4"
            step="0.1"
            value="${weights[criterion.key]}"
            data-key="${criterion.key}"
            class="joystick-slider"
            style="
              width: 100%;
              height: 8px;
              border-radius: 4px;
              outline: none;
              -webkit-appearance: none;
              background: linear-gradient(to right,
                ${criterion.color} 0%,
                ${criterion.color} ${(weights[criterion.key] / 4 * 100)}%,
                #e5e7eb ${(weights[criterion.key] / 4 * 100)}%,
                #e5e7eb 100%
              );
            "
          />
        `;

        container.appendChild(sliderDiv);

        // Ã‰couteur de changement
        const slider = sliderDiv.querySelector('.joystick-slider');
        const valueSpan = sliderDiv.querySelector('.weight-value');

        slider.addEventListener('input', (e) => {
          weights[criterion.key] = parseFloat(e.target.value);
          valueSpan.textContent = weights[criterion.key].toFixed(2);

          // Mettre Ã  jour le gradient du slider
          e.target.style.background = `linear-gradient(to right,
            ${criterion.color} 0%,
            ${criterion.color} ${(weights[criterion.key] / 4 * 100)}%,
            #e5e7eb ${(weights[criterion.key] / 4 * 100)}%,
            #e5e7eb 100%
          )`;

          // Callback
          if (onChange) {
            onChange({ ...weights });
          }
        });
      });

      // Bouton de normalisation
      const normalizeBtn = document.createElement('button');
      normalizeBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Normaliser (total = 4)';
      normalizeBtn.style.cssText = `
        width: 100%;
        padding: 10px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.2s;
      `;
      normalizeBtn.onmouseover = () => normalizeBtn.style.transform = 'translateY(-2px)';
      normalizeBtn.onmouseout = () => normalizeBtn.style.transform = 'translateY(0)';

      normalizeBtn.addEventListener('click', () => {
        normalize();

        // Mettre Ã  jour tous les sliders
        criteria.forEach(criterion => {
          const slider = container.querySelector(`input[data-key="${criterion.key}"]`);
          const valueSpan = container.querySelector(`.weight-value[data-key="${criterion.key}"]`);

          slider.value = weights[criterion.key];
          valueSpan.textContent = weights[criterion.key].toFixed(2);

          slider.style.background = `linear-gradient(to right,
            ${criterion.color} 0%,
            ${criterion.color} ${(weights[criterion.key] / 4 * 100)}%,
            #e5e7eb ${(weights[criterion.key] / 4 * 100)}%,
            #e5e7eb 100%
          )`;
        });

        if (onChange) {
          onChange({ ...weights });
        }
      });

      container.appendChild(normalizeBtn);

      return container;
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VISUALISATIONS - Graphiques Ã  barres SVG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * CrÃ©e un graphique Ã  barres horizontales SVG
   * @param {Array} data - [{label: 'Group 1', value: 12.5, max: 20, color: '#3b82f6'}, ...]
   * @param {number} width - Largeur du graphique
   * @param {number} barHeight - Hauteur de chaque barre
   * @returns {string} - SVG HTML string
   */
  function createBarChart(data, width = 300, barHeight = 24) {
    const gap = 8;
    const labelWidth = 80;
    const valueWidth = 40;
    const barWidth = width - labelWidth - valueWidth - 20;
    const height = data.length * (barHeight + gap);

    const bars = data.map((item, index) => {
      const y = index * (barHeight + gap);
      const percentage = (item.value / item.max) * 100;
      const barW = (barWidth * percentage) / 100;

      return `
        <!-- Label -->
        <text x="0" y="${y + barHeight / 2 + 4}" font-size="12" font-weight="600" fill="#374151">
          ${item.label}
        </text>

        <!-- Barre de fond -->
        <rect
          x="${labelWidth}"
          y="${y}"
          width="${barWidth}"
          height="${barHeight}"
          fill="#e5e7eb"
          rx="4"
        />

        <!-- Barre de valeur -->
        <rect
          x="${labelWidth}"
          y="${y}"
          width="${barW}"
          height="${barHeight}"
          fill="${item.color}"
          rx="4"
        >
          <animate attributeName="width" from="0" to="${barW}" dur="0.6s" fill="freeze"/>
        </rect>

        <!-- Valeur -->
        <text
          x="${labelWidth + barWidth + 10}"
          y="${y + barHeight / 2 + 4}"
          font-size="13"
          font-weight="700"
          fill="${item.color}"
        >
          ${item.value.toFixed(1)}
        </text>
      `;
    }).join('');

    return `
      <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
        ${bars}
      </svg>
    `;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VISUALISATIONS - (Radar supprimÃ© - inutilisable et non cÃ¢blÃ©)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Fonction createMiniRadar supprimÃ©e car le radar Ã©tait trop petit, non cÃ¢blÃ©,
  // et n'apportait aucune valeur Ã  l'utilisateur

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS - Badges critÃ¨res
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function createCriteriaBadge(type, value) {
    /**
     * CrÃ©e un badge colorÃ© pour un critÃ¨re (COM/TRA/PART/ABS)
     * @param {string} type - 'com' | 'tra' | 'part' | 'abs'
     * @param {number} value - Valeur du score (0-4)
     * @returns {string} - HTML string
     */
    const labels = {
      com: 'COM',
      tra: 'TRA',
      part: 'PART',
      abs: 'ABS'
    };

    return `
      <span class="groups-badge groups-badge-${type}" title="${labels[type]}: ${value.toFixed(1)}/4">
        <i class="fas fa-circle" style="font-size: 6px;"></i>
        ${labels[type]} ${value.toFixed(1)}
      </span>
    `;
  }

  const DEFAULT_CRITERIA_WEIGHTS = { com: 1, tra: 1, part: 1, abs: 1 };

  const SCENARIO_WEIGHT_PRESETS = {
    besoins: {
      scoreF: 3.0,
      scoreM: 3.0,
      com: 1.5,
      tra: 1.5,
      part: 1.0,
      abs: -2.0
    },
    lv2: {
      scoreF: 1.0,
      scoreM: 1.0,
      com: 1.5,
      tra: 1.5,
      part: 4.0,
      abs: -2.5
    },
    options: {
      scoreF: 2.0,
      scoreM: 2.0,
      com: 2.0,
      tra: 2.0,
      part: 2.0,
      abs: -1.5
    }
  };

  function sanitizeCriteriaWeights(weights = {}) {
    const sanitized = { ...DEFAULT_CRITERIA_WEIGHTS };

    if (!weights || typeof weights !== 'object') {
      return sanitized;
    }

    ['com', 'tra', 'part', 'abs'].forEach(key => {
      const value = parseFloat(weights[key]);
      if (!Number.isNaN(value) && Number.isFinite(value)) {
        sanitized[key] = value;
      }
    });

    return sanitized;
  }

  function getActiveCriteriaWeights() {
    return sanitizeCriteriaWeights(state.groupsGeneration?.criteriaWeights);
  }

  function getCriteriaWeightsSource() {
    return state.groupsGeneration?.criteriaWeightsSource || 'scenario-default';
  }

  // Ã‰tat interne de l'interface
  const state = {
    scenario: null,        // 'besoins' | 'lv2' | 'options'
    mode: null,           // 'heterogeneous' | 'homogeneous'
    selectedLanguage: null, // 'ESP' | 'ITA' | 'ALL' | 'CHI' | 'ARA' | etc.
    availableLanguages: [], // [{ lang: 'ESP', count: 45 }, ...]
    regroupements: [],    // Liste des regroupements configurÃ©s
    currentResults: null, // RÃ©sultats de la gÃ©nÃ©ration en cours
    timeline: [],         // Historique des actions
    carouselIndex: 0,     // Index du carrousel de groupes

    // Ã‰tat de gÃ©nÃ©ration
    groupsGeneration: {
      criteriaWeights: { ...DEFAULT_CRITERIA_WEIGHTS },
      criteriaWeightsSource: 'scenario-default',
      criteriaWeightsUpdatedAt: null
    },

    // Ã‰tat du dashboard de swap
    swapDashboard: {
      currentRegroupementIndex: 0,  // Index du regroupement affichÃ©
      allRegroupements: [],          // Tous les regroupements gÃ©nÃ©rÃ©s
      statsVisible: false,           // Panneau statistiques visible
      sidebarCollapsed: false,       // Panneau latÃ©ral rÃ©tractÃ©
      comparisonVisible: true,       // Bandeau comparaison visible
      headerVisible: true,           // Header avec boutons visible
      groupHeaderCompact: false,     // Mode compact pour les en-tÃªtes de groupes
      sortState: {},                 // Ã‰tat des tris (parity, scoreF, scoreM, com) : { critÃ¨re: 'asc'|'desc' }
      showSourceClass: false,        // Afficher la classe SOURCE (origine annÃ©e prÃ©cÃ©dente)

      // âœ¨ NOUVEAU : Historique pour UNDO/REDO lors des rÃ©gÃ©nÃ©rations
      history: [],                   // Historique des Ã©tats de regroupements
      historyIndex: -1               // Position actuelle dans l'historique (-1 = pas d'historique)
    }
  };

  /**
   * RÃ©initialise complÃ¨tement l'Ã©tat de l'application
   * @param {boolean} keepSwapDashboard - Si true, conserve l'Ã©tat du dashboard de swap
   */
  function resetState(keepSwapDashboard = false) {
    console.log('ğŸ”„ RÃ©initialisation complÃ¨te de l\'Ã©tat...');

    // RÃ©initialiser les paramÃ¨tres principaux
    state.scenario = null;
    state.mode = null;
    state.selectedLanguage = null;
    state.availableLanguages = [];
    state.regroupements = [];
    state.currentResults = null;
    state.timeline = [];
    state.carouselIndex = 0;

    // RÃ©initialiser les pondÃ©rations
    if (!state.groupsGeneration) {
      state.groupsGeneration = {};
    }
    state.groupsGeneration.criteriaWeights = { ...DEFAULT_CRITERIA_WEIGHTS };
    state.groupsGeneration.criteriaWeightsSource = 'scenario-default';
    state.groupsGeneration.criteriaWeightsUpdatedAt = null;

    // RÃ©initialiser le dashboard de swap si demandÃ©
    if (!keepSwapDashboard) {
      state.swapDashboard.currentRegroupementIndex = 0;
      state.swapDashboard.allRegroupements = [];
      state.swapDashboard.statsVisible = false;
      state.swapDashboard.sidebarCollapsed = false;
      state.swapDashboard.comparisonVisible = true;
      state.swapDashboard.headerVisible = true;
      state.swapDashboard.groupHeaderCompact = false;
      state.swapDashboard.sortState = {};
      state.swapDashboard.showSourceClass = false;
    }

    console.log('âœ… Ã‰tat rÃ©initialisÃ©:', state);
  }

  // Exposer resetState sur window pour que closeModuleGroupsV4 puisse l'appeler
  window.resetGroupsV4State = resetState;

  /**
   * Rendu de la structure HTML complÃ¨te (triptyque 30/40/30)
   */
  function renderInitialStructure(container) {
    container.innerHTML = `
      <div class="groups-v4-triptyque">

        <!-- VOLET A : ParamÃ¨tres (30%) -->
        <div class="groups-volet-a">
          <div class="groups-volet-content">
            <!-- Header avec bouton de fermeture -->
            <div class="groups-volet-header">
              <h2 class="groups-volet-title">
                <i class="fas fa-route"></i> Parcours de configuration
              </h2>
              <button id="close-groups-interface" style="
                padding: 8px 12px;
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
              " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                <i class="fas fa-times"></i> Fermer
              </button>
            </div>

            <!-- ğŸ¨ SECTION Ã‰TAPES OBLIGATOIRES avec Timeline -->
            <div style="position: relative; margin-bottom: 32px;">

              <!-- Timeline verticale (barre colorÃ©e Ã  gauche) -->
              <div style="
                position: absolute;
                left: 16px;
                top: 20px;
                width: 3px;
                height: calc(100% - 40px);
                background: linear-gradient(to bottom,
                  #6366f1 0%,     /* Violet (scÃ©nario) */
                  #6366f1 33%,
                  #3b82f6 33%,    /* Bleu (mode) */
                  #3b82f6 66%,
                  #10b981 66%,    /* Vert (langue) */
                  #10b981 100%
                );
                border-radius: 2px;
                opacity: 0.3;
              "></div>

              <!-- Ã‰TAPE 1 : ScÃ©nario (Violet) -->
              <div class="step-card" data-step="1" style="
                position: relative;
                margin-bottom: 24px;
                margin-left: 32px;
                padding: 20px;
                background: linear-gradient(135deg, #f5f3ff 0%, #ffffff 100%);
                border: 2px solid #c7d2fe;
                border-left: 6px solid #6366f1;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
                transition: all 0.3s ease;
              ">
                <!-- NumÃ©ro d'Ã©tape (badge) -->
                <div style="
                  position: absolute;
                  left: -50px;
                  top: 16px;
                  width: 36px;
                  height: 36px;
                  background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: 800;
                  font-size: 16px;
                  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
                  border: 3px solid white;
                ">1</div>

                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <h3 style="font-size: 16px; font-weight: 700; margin: 0; color: #4f46e5;">
                    <i class="fas fa-bullseye" style="color: #6366f1;"></i> Choisir un scÃ©nario
                  </h3>
                  <span style="
                    padding: 3px 8px;
                    background: #6366f1;
                    color: white;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    border-radius: 4px;
                    letter-spacing: 0.5px;
                  ">Obligatoire</span>
                </div>

                <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px; font-style: italic;">
                  Le scÃ©nario dÃ©termine les critÃ¨res prioritaires pour la rÃ©partition
                </p>

                <div id="scenario-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="scenario-btn groups-select-btn" data-scenario="besoins" style="border: 2px solid transparent;">
                    <i class="fas fa-user-graduate"></i> Besoins pÃ©dagogiques
                  </button>
                  <button class="scenario-btn groups-select-btn" data-scenario="lv2" style="border: 2px solid transparent;">
                    <i class="fas fa-language"></i> Langues vivantes (LV2)
                  </button>
                  <button class="scenario-btn groups-select-btn" data-scenario="options" style="border: 2px solid transparent;">
                    <i class="fas fa-star"></i> Options spÃ©cifiques
                  </button>
                </div>
              </div>

              <!-- Ã‰TAPE 2 : Mode de distribution (Bleu) -->
              <div id="mode-section" class="step-card" data-step="2" style="
                position: relative;
                margin-bottom: 24px;
                margin-left: 32px;
                padding: 20px;
                background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
                border: 2px solid #bfdbfe;
                border-left: 6px solid #3b82f6;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                display: none;
                transition: all 0.3s ease;
              ">
                <!-- NumÃ©ro d'Ã©tape -->
                <div style="
                  position: absolute;
                  left: -50px;
                  top: 16px;
                  width: 36px;
                  height: 36px;
                  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: 800;
                  font-size: 16px;
                  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                  border: 3px solid white;
                ">2</div>

                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <h3 style="font-size: 16px; font-weight: 700; margin: 0; color: #1e40af;">
                    <i class="fas fa-layer-group" style="color: #3b82f6;"></i> Mode de distribution
                  </h3>
                  <span style="
                    padding: 3px 8px;
                    background: #3b82f6;
                    color: white;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    border-radius: 4px;
                    letter-spacing: 0.5px;
                  ">Obligatoire</span>
                </div>

                <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px; font-style: italic;">
                  Choisissez comment les Ã©lÃ¨ves seront rÃ©partis dans les groupes
                </p>

                <div id="mode-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="mode-btn groups-select-btn" data-mode="heterogeneous" style="border: 2px solid transparent;">
                    <i class="fas fa-random"></i> HÃ©tÃ©rogÃ¨ne
                    <div class="groups-select-btn-subtitle">
                      MÃ©lange les niveaux pour Ã©quilibrer
                    </div>
                  </button>
                  <button class="mode-btn groups-select-btn" data-mode="homogeneous" style="border: 2px solid transparent;">
                    <i class="fas fa-equals"></i> HomogÃ¨ne
                    <div class="groups-select-btn-subtitle">
                      Groupes de niveaux similaires
                    </div>
                  </button>
                </div>
              </div>

              <!-- Ã‰TAPE 3 : Langue LV2 (Vert - conditionnelle) -->
              <div id="language-section" class="step-card" data-step="3" style="
                position: relative;
                margin-bottom: 24px;
                margin-left: 32px;
                padding: 20px;
                background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
                border: 2px solid #bbf7d0;
                border-left: 6px solid #10b981;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
                display: none;
                transition: all 0.3s ease;
              ">
                <!-- NumÃ©ro d'Ã©tape -->
                <div style="
                  position: absolute;
                  left: -50px;
                  top: 16px;
                  width: 36px;
                  height: 36px;
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: 800;
                  font-size: 16px;
                  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                  border: 3px solid white;
                ">3</div>

                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <h3 style="font-size: 16px; font-weight: 700; margin: 0; color: #065f46;">
                    <i class="fas fa-language" style="color: #10b981;"></i> Langue Ã  regrouper
                  </h3>
                  <span style="
                    padding: 3px 8px;
                    background: #10b981;
                    color: white;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    border-radius: 4px;
                    letter-spacing: 0.5px;
                  ">LV2 uniquement</span>
                </div>

                <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px; font-style: italic;">
                  SÃ©lectionnez la langue pour filtrer les Ã©lÃ¨ves
                </p>

                <div id="language-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                  <!-- Les langues seront insÃ©rÃ©es ici dynamiquement -->
                </div>
                <div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 12px; color: #065f46;">
                  <i class="fas fa-info-circle"></i> <span id="language-info">SÃ©lectionnez une langue</span>
                </div>
              </div>

            </div>

            <!-- ğŸ¨ SÃ‰PARATEUR : Informations / RÃ©glages facultatifs -->
            <div style="
              margin: 32px 0;
              padding: 12px;
              background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
              border-radius: 8px;
              text-align: center;
              font-size: 11px;
              font-weight: 700;
              color: #6b7280;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">
              <i class="fas fa-arrow-down"></i> Informations & RÃ©glages facultatifs <i class="fas fa-arrow-down"></i>
            </div>

            <!-- Classes dÃ©tectÃ©es (Informatif) -->
            <div id="classes-detected-section" style="
              display: none;
              margin-bottom: 24px;
              padding: 16px;
              background: #f9fafb;
              border: 1px solid #e5e7eb;
              border-radius: 10px;
            ">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="
                  width: 32px;
                  height: 32px;
                  background: linear-gradient(135deg, #10b981, #059669);
                  border-radius: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                ">
                  <i class="fas fa-school"></i>
                </div>
                <h3 style="font-size: 14px; font-weight: 700; margin: 0; color: #374151;">
                  Classes dÃ©tectÃ©es
                </h3>
                <span style="
                  margin-left: auto;
                  padding: 3px 8px;
                  background: #e5e7eb;
                  color: #6b7280;
                  font-size: 10px;
                  font-weight: 700;
                  text-transform: uppercase;
                  border-radius: 4px;
                ">Info</span>
              </div>

              <div id="classes-detected-list" style="
                padding: 12px;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                font-size: 13px;
              ">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <!-- Les classes dÃ©tectÃ©es s'afficheront ici -->
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> Ces classes sont disponibles pour crÃ©er des regroupements
              </div>
            </div>

            <!-- Aide contextuelle (Informatif) -->
            <div id="help-box" style="
              padding: 14px;
              background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
              border-left: 4px solid #3b82f6;
              border-radius: 8px;
              font-size: 13px;
              color: #1e40af;
              display: none;
              margin-bottom: 24px;
              box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
            ">
              <div style="display: flex; align-items: start; gap: 10px;">
                <i class="fas fa-lightbulb" style="color: #3b82f6; font-size: 18px; margin-top: 2px;"></i>
                <span id="help-text" style="flex: 1; line-height: 1.5;"></span>
              </div>
            </div>

            <!-- âœ¨ Panneau dÃ©pliant : PondÃ©rations des critÃ¨res (Optionnel) -->
            <div style="
              margin-bottom: 24px;
              padding: 16px;
              background: #fafafa;
              border: 2px dashed #d1d5db;
              border-radius: 10px;
            ">
              <div id="panel-weighting-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                padding: 12px;
                margin: -12px -12px 0 -12px;
                border-radius: 8px;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(99,102,241,0.05)'" onmouseout="this.style.background='transparent'">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="
                    width: 32px;
                    height: 32px;
                    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                  ">
                    <i class="fas fa-sliders-h"></i>
                  </div>
                  <div>
                    <h3 style="font-size: 14px; font-weight: 700; margin: 0; color: #374151;">
                      PondÃ©rations des critÃ¨res
                    </h3>
                    <p style="font-size: 11px; color: #9ca3af; margin: 2px 0 0 0;">
                      Ajustez l'importance relative de chaque critÃ¨re
                    </p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="
                    padding: 3px 8px;
                    background: #fbbf24;
                    color: white;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    border-radius: 4px;
                  ">AvancÃ©</span>
                  <i id="panel-weighting-chevron" class="fas fa-chevron-down" style="color: #6b7280; transition: transform 0.2s; font-size: 14px;"></i>
                </div>
              </div>

              <div id="panel-weighting-content" style="
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid #e5e7eb;
                display: block;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
              ">
                <div style="
                  padding: 12px;
                  background: #fffbeb;
                  border-left: 3px solid #fbbf24;
                  border-radius: 6px;
                  font-size: 12px;
                  color: #92400e;
                  margin-bottom: 16px;
                ">
                  <i class="fas fa-exclamation-triangle" style="color: #fbbf24;"></i>
                  <strong>Note :</strong> Les pondÃ©rations modifient l'importance relative des critÃ¨res lors du calcul des groupes.
                </div>
                <div id="joystick-container-volet-a"></div>
              </div>
            </div>

            <!-- âœ¨ Panneau dÃ©pliant : Options de lisibilitÃ© (Optionnel) -->
            <div style="
              margin-bottom: 24px;
              padding: 16px;
              background: #fafafa;
              border: 2px dashed #d1d5db;
              border-radius: 10px;
            ">
              <div id="panel-readability-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                padding: 12px;
                margin: -12px -12px 0 -12px;
                border-radius: 8px;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(16,185,129,0.05)'" onmouseout="this.style.background='transparent'">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="
                    width: 32px;
                    height: 32px;
                    background: linear-gradient(135deg, #34d399, #10b981);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                  ">
                    <i class="fas fa-eye"></i>
                  </div>
                  <div>
                    <h3 style="font-size: 14px; font-weight: 700; margin: 0; color: #374151;">
                      Options de lisibilitÃ©
                    </h3>
                    <p style="font-size: 11px; color: #9ca3af; margin: 2px 0 0 0;">
                      Personnalisez l'affichage des rÃ©sultats
                    </p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="
                    padding: 3px 8px;
                    background: #e5e7eb;
                    color: #6b7280;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    border-radius: 4px;
                  ">Optionnel</span>
                  <i id="panel-readability-chevron" class="fas fa-chevron-down" style="color: #6b7280; transition: transform 0.2s; font-size: 14px;"></i>
                </div>
              </div>

              <div id="panel-readability-content" style="
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid #e5e7eb;
                display: block;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
              ">

              <!-- Checkboxes d'affichage -->
              <div style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" id="toggle-scores-v4" checked style="cursor: pointer; width: 16px; height: 16px;">
                  <span>Afficher les pastilles COM/TRA/PART/ABS</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; padding: 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" id="toggle-fmscores-v4" checked style="cursor: pointer; width: 16px; height: 16px;">
                  <span>Afficher les scores F:/M:</span>
                </label>
              </div>

              <!-- Taille des cartes avec aperÃ§us visuels -->
              <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px;">Taille des cartes</label>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  <label class="size-option-label" data-size="small" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 8px 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: white;
                  " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
                    <span style="font-size: 11px; font-weight: 600; color: #6b7280;">S</span>
                    <span style="font-size: 10px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
                    <input type="radio" name="cardSize" value="small" style="cursor: pointer; width: 16px; height: 16px;">
                  </label>
                  <label class="size-option-label active" data-size="medium" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 8px 12px;
                    border: 2px solid #6366f1;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: #eef2ff;
                  ">
                    <span style="font-size: 12px; font-weight: 600; color: #6b7280;">M</span>
                    <span style="font-size: 12px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
                    <input type="radio" name="cardSize" value="medium" checked style="cursor: pointer; width: 16px; height: 16px;">
                  </label>
                  <label class="size-option-label" data-size="large" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 8px 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: white;
                  " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
                    <span style="font-size: 13px; font-weight: 600; color: #6b7280;">L</span>
                    <span style="font-size: 14px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
                    <input type="radio" name="cardSize" value="large" style="cursor: pointer; width: 16px; height: 16px;">
                  </label>
                  <label class="size-option-label" data-size="xlarge" style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 8px 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: white;
                  " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
                    <span style="font-size: 14px; font-weight: 600; color: #6b7280;">XL</span>
                    <span style="font-size: 16px; font-weight: 800; color: #1f2937;">DUPONT LÃ©a</span>
                    <input type="radio" name="cardSize" value="xlarge" style="cursor: pointer; width: 16px; height: 16px;">
                  </label>
                </div>
              </div>

              <!-- Style de police -->
              <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px;">Style</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                  <label class="style-option-label active" data-style="normal" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 8px 12px;
                    border: 2px solid #6366f1;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: #eef2ff;
                  ">
                    <input type="radio" name="cardStyle" value="normal" checked style="display: none;">
                    <span style="font-size: 12px; font-weight: 600; color: #4f46e5;">Normal</span>
                  </label>
                  <label class="style-option-label" data-style="bold" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 8px 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: white;
                  " onmouseover="if(!this.classList.contains('active')) this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
                    <input type="radio" name="cardStyle" value="bold" style="display: none;">
                    <span style="font-size: 12px; font-weight: 600;">Gras</span>
                  </label>
                  <label class="style-option-label" data-style="highlight" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 8px 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: white;
                  " onmouseover="if(!this.classList.contains('active')) this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
                    <input type="radio" name="cardStyle" value="highlight" style="display: none;">
                    <span style="font-size: 12px; font-weight: 600;">SurlignÃ©</span>
                  </label>
                </div>
              </div>

              <!-- Mode zoom global -->
              <div>
                <button id="btn-zoom-v4" style="
                  padding: 10px 16px;
                  background: #f3f4f6;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 600;
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                  <i class="fas fa-search-plus"></i>
                  <span>Mode zoom</span>
                </button>
              </div>

              </div> <!-- Fin du panel-readability-content -->
            </div> <!-- Fin du panneau dÃ©pliant lisibilitÃ© -->
          </div>
        </div>

        <!-- VOLET B : Regroupements (40%) -->
        <div class="groups-volet-b">
          <div class="groups-volet-content">
            <div class="groups-volet-header">
              <h2 class="groups-volet-title">
                <i class="fas fa-layer-group"></i> Regroupements
              </h2>
              <button id="btn-add-regroupement" style="
                padding: 8px 16px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: none;
              ">
                <i class="fas fa-plus"></i> Ajouter
              </button>
            </div>

            <div id="regroupements-list" style="display: flex; flex-direction: column; gap: 16px;">
              <div id="regroupements-placeholder" style="
                padding: 48px 24px;
                text-align: center;
                color: #1f2937;
                border: 2px dashed #e5e7eb;
                border-radius: 8px;
              ">
                <i class="fas fa-arrow-left" style="font-size: 24px; margin-bottom: 16px;"></i>
                <div style="font-size: 14px;">
                  SÃ©lectionnez un scÃ©nario et un mode pour commencer
                </div>
              </div>
            </div>

            <!-- Bandeau d'actions -->
            <div id="actions-banner" style="
              display: none;
              margin-top: 24px;
              padding: 16px;
              background: white;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
            ">
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="btn-reset" style="
                  padding: 10px 20px;
                  background: #ef4444;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                ">
                  <i class="fas fa-redo"></i> RÃ©initialiser
                </button>
                <button id="btn-generate" style="
                  padding: 10px 20px;
                  background: #3b82f6;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 700;
                ">
                  <i class="fas fa-magic"></i> GÃ©nÃ©rer les groupes
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- VOLET C : RÃ©capitulatif (30%) -->
        <div class="groups-volet-c">
          <div class="groups-volet-content">
            <h2 class="groups-volet-title" style="margin-bottom: var(--space-xl);">
              <i class="fas fa-chart-bar"></i> RÃ©capitulatif
            </h2>

            <!-- ScÃ©nario et mode sÃ©lectionnÃ©s -->
            <div id="recap-selection" style="
              padding: 16px;
              background: #f9fafb;
              border-radius: 8px;
              margin-bottom: 24px;
              font-size: 14px;
            ">
              <div style="margin-bottom: 8px;">
                <strong>ScÃ©nario :</strong> <span id="recap-scenario">-</span>
              </div>
              <div style="margin-bottom: 8px;">
                <strong>Mode :</strong> <span id="recap-mode">-</span>
              </div>
              <div id="recap-language-row" style="display: none;">
                <strong>Langue :</strong> <span id="recap-language">-</span>
              </div>
            </div>

            <!-- Statistiques -->
            <div id="recap-stats" style="display: none; margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-chart-pie"></i> Statistiques
              </h3>
              <div id="stats-content"></div>
            </div>

            <!-- Timeline -->
            <div id="recap-timeline" style="margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-clock"></i> Timeline
              </h3>
              <div id="timeline-content" style="
                font-size: 13px;
                color: #374151;
              ">
                Aucune action pour le moment
              </div>
            </div>

            <!-- AperÃ§u des groupes (carrousel) -->
            <div id="recap-groups" style="display: none;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-users"></i> AperÃ§u des groupes
              </h3>
              <div id="groups-carousel"></div>
            </div>

            <!-- Interface de swap -->
            <div id="recap-swap-section" style="display: none; margin-top: 24px;">
              <button id="btn-open-swap" style="
                width: 100%;
                padding: 14px 20px;
                background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                transition: all 0.2s;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'">
                <i class="fas fa-exchange-alt"></i> Ouvrir l'interface de swap
              </button>
              <div style="margin-top: 8px; font-size: 12px; color: #374151; text-align: center;">
                <i class="fas fa-info-circle"></i> Ã‰changez les Ã©lÃ¨ves entre les groupes
              </div>
            </div>
          </div>
        </div>

      </div>
    `;

    // Initialiser les Ã©vÃ©nements
    initializeEvents(container);
  }

  /**
   * Initialise les Ã©vÃ©nements de l'interface
   */
  function initializeEvents(container) {
    // Boutons de scÃ©nario
    container.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => selectScenario(btn.dataset.scenario));
    });

    // Boutons de mode
    container.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => selectMode(btn.dataset.mode));
    });

    // Bouton ajouter regroupement
    const btnAdd = container.querySelector('#btn-add-regroupement');
    if (btnAdd) {
      btnAdd.addEventListener('click', addRegroupement);
    }

    // Bouton gÃ©nÃ©rer
    const btnGenerate = container.querySelector('#btn-generate');
    if (btnGenerate) {
      btnGenerate.addEventListener('click', generateGroups);
    }

    // Bouton rÃ©initialiser
    const btnReset = container.querySelector('#btn-reset');
    if (btnReset) {
      btnReset.addEventListener('click', resetInterface);
    }

    // Bouton ouvrir swap interface
    const btnOpenSwap = container.querySelector('#btn-open-swap');
    if (btnOpenSwap) {
      btnOpenSwap.addEventListener('click', openSwapInterface);
    }

    // Bouton fermer l'interface
    const btnClose = container.querySelector('#close-groups-interface');
    if (btnClose) {
      btnClose.addEventListener('click', () => {
        if (confirm('Fermer le module Groupes ? Les modifications non sauvegardÃ©es seront perdues.')) {
          // RÃ©initialiser complÃ¨tement l'Ã©tat avant de fermer
          resetState(false);

          // Fermer le dashboard de swap s'il est ouvert
          const swapDashboard = document.getElementById('swap-dashboard');
          if (swapDashboard) {
            swapDashboard.remove();
          }

          // âœ… Appeler la fonction de fermeture globale pour rÃ©initialiser moduleContainer
          if (window.closeModuleGroupsV4) {
            window.closeModuleGroupsV4();
          } else {
            // Fallback si la fonction n'existe pas
            container.remove();
          }
        }
      });
    }
  }

  /**
   * SÃ©lection du scÃ©nario
   */
  function selectScenario(scenario) {
    // Si on change de scÃ©nario, invalider les rÃ©sultats actuels
    if (state.scenario && state.scenario !== scenario) {
      invalidateCurrentResults();
      GroupsNotifications.info('ScÃ©nario modifiÃ©', 'Les rÃ©sultats de gÃ©nÃ©ration prÃ©cÃ©dents ont Ã©tÃ© invalidÃ©s. Veuillez rÃ©gÃ©nÃ©rer les groupes.');
    }

    state.scenario = scenario;

    // Mettre Ã  jour l'UI
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      if (btn.dataset.scenario === scenario) {
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#eff6ff';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section mode
    const modeSection = document.getElementById('mode-section');
    if (modeSection) modeSection.style.display = 'block';

    // Si scÃ©nario LV2, afficher le sÃ©lecteur de langue
    if (scenario === 'lv2') {
      displayLanguageSelection();
    } else {
      // Masquer la section langue pour les autres scÃ©narios
      const languageSection = document.getElementById('language-section');
      if (languageSection) languageSection.style.display = 'none';
      state.selectedLanguage = null;
    }

    // Mettre Ã  jour le rÃ©capitulatif
    updateRecap();

    // Ajouter Ã  la timeline
    addToTimeline(`ScÃ©nario "${scenario}" sÃ©lectionnÃ©`, 'info');

    console.log('âœ… ScÃ©nario sÃ©lectionnÃ©:', scenario);
  }

  /**
   * SÃ©lection du mode
   */
  function selectMode(mode) {
    // Si on change de mode, invalider les rÃ©sultats actuels
    if (state.mode && state.mode !== mode) {
      invalidateCurrentResults();
      GroupsNotifications.info('Mode modifiÃ©', 'Les rÃ©sultats de gÃ©nÃ©ration prÃ©cÃ©dents ont Ã©tÃ© invalidÃ©s. Veuillez rÃ©gÃ©nÃ©rer les groupes.');
    }

    state.mode = mode;

    // Mettre Ã  jour l'UI
    document.querySelectorAll('.mode-btn').forEach(btn => {
      if (btn.dataset.mode === mode) {
        btn.style.borderColor = '#10b981';
        btn.style.background = '#f0fdf4';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section des classes dÃ©tectÃ©es
    displayDetectedClasses();

    // Activer le volet B
    activateVoletB();

    // Mettre Ã  jour le rÃ©capitulatif
    updateRecap();

    // Ajouter Ã  la timeline
    addToTimeline(`Mode "${mode}" sÃ©lectionnÃ©`, 'info');

    console.log('âœ… Mode sÃ©lectionnÃ©:', mode);
  }

  /**
   * Affiche la liste des classes dÃ©tectÃ©es depuis le DOM
   */
  function displayDetectedClasses() {
    const section = document.getElementById('classes-detected-section');
    const listContainer = document.querySelector('#classes-detected-list > div');

    if (!section || !listContainer) return;

    // DÃ©tecter les classes depuis le DOM
    const zones = document.querySelectorAll('.droppable-zone[data-classe]');
    const classes = [];
    zones.forEach(zone => {
      const className = zone.getAttribute('data-classe');
      if (className && !classes.includes(className)) {
        classes.push(className);
      }
    });

    if (classes.length === 0) {
      listContainer.innerHTML = '<span style="color: #ef4444;">Aucune classe dÃ©tectÃ©e</span>';
    } else {
      listContainer.innerHTML = classes.map(className => `
        <span style="
          display: inline-block;
          padding: 4px 10px;
          background: white;
          border: 1px solid #10b981;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 700;
          color: #047857;
        ">
          <i class="fas fa-graduation-cap" style="margin-right: 4px;"></i>${className}
        </span>
      `).join('');
    }

    // Afficher la section
    section.style.display = 'block';

    console.log(`âœ… ${classes.length} classe(s) dÃ©tectÃ©e(s):`, classes);
  }

  /**
   * DÃ©tecte les langues LV2 disponibles depuis les donnÃ©es
   */
  function detectAvailableLanguages() {
    if (!window.STATE || !window.STATE.students) {
      console.warn('âš ï¸ STATE.students non disponible pour dÃ©tecter les langues');
      return [];
    }

    // Compter les Ã©lÃ¨ves par langue
    const languageCounts = {};

    Object.values(window.STATE.students).forEach(student => {
      const lang = (student.lv2 || student.LV2 || 'ESP').toUpperCase();
      languageCounts[lang] = (languageCounts[lang] || 0) + 1;
    });

    // Convertir en tableau
    const languages = Object.entries(languageCounts).map(([lang, count]) => ({
      lang,
      count
    }));

    // Trier par nombre d'Ã©lÃ¨ves dÃ©croissant
    languages.sort((a, b) => b.count - a.count);

    console.log('ğŸŒ Langues dÃ©tectÃ©es:', languages);
    return languages;
  }

  /**
   * Affiche le sÃ©lecteur de langues
   */
  function displayLanguageSelection() {
    const section = document.getElementById('language-section');
    const buttonsContainer = document.getElementById('language-buttons');
    const infoSpan = document.getElementById('language-info');

    if (!section || !buttonsContainer || !infoSpan) return;

    // DÃ©tecter les langues disponibles
    state.availableLanguages = detectAvailableLanguages();

    if (state.availableLanguages.length === 0) {
      buttonsContainer.innerHTML = '<p style="color: #ef4444; font-size: 13px;">Aucune langue dÃ©tectÃ©e</p>';
      section.style.display = 'block';
      return;
    }

    // Afficher les langues sous forme de boutons
    buttonsContainer.innerHTML = state.availableLanguages.map(({ lang, count }) => {
      const langNames = {
        'ESP': 'Espagnol ğŸ‡ªğŸ‡¸',
        'ITA': 'Italien ğŸ‡®ğŸ‡¹',
        'ALL': 'Allemand ğŸ‡©ğŸ‡ª',
        'CHI': 'Chinois ğŸ‡¨ğŸ‡³',
        'ARA': 'Arabe ğŸ‡¦ğŸ‡ª'
      };
      const displayName = langNames[lang] || `${lang} ğŸŒ`;

      return `
        <button class="language-btn" data-language="${lang}" style="
          padding: 12px 16px;
          border: 2px solid ${state.selectedLanguage === lang ? '#8b5cf6' : '#e5e7eb'};
          border-radius: 8px;
          background: ${state.selectedLanguage === lang ? '#f3e8ff' : 'white'};
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span style="font-weight: ${state.selectedLanguage === lang ? '600' : '400'};">
            ${displayName}
          </span>
          <span style="
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
          ">
            ${count}
          </span>
        </button>
      `;
    }).join('');

    // Mettre Ã  jour le texte d'info
    if (state.selectedLanguage) {
      const selectedLang = state.availableLanguages.find(l => l.lang === state.selectedLanguage);
      if (selectedLang) {
        infoSpan.textContent = `${selectedLang.count} Ã©lÃ¨ve(s) en ${state.selectedLanguage}`;
      }
    } else {
      infoSpan.textContent = 'SÃ©lectionnez une langue';
    }

    // Afficher la section
    section.style.display = 'block';

    // Attacher les Ã©vÃ©nements
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', () => selectLanguage(btn.dataset.language));
    });
  }

  /**
   * SÃ©lectionne une langue
   */
  function selectLanguage(language) {
    state.selectedLanguage = language;

    // Mettre Ã  jour l'UI
    displayLanguageSelection();

    // Mettre Ã  jour le rÃ©capitulatif
    updateRecap();

    // Ajouter Ã  la timeline
    addToTimeline(`Langue "${language}" sÃ©lectionnÃ©e`, 'info');

    console.log('âœ… Langue sÃ©lectionnÃ©e:', language);
  }

  /**
   * Active le volet B (regroupements)
   */
  function activateVoletB() {
    const placeholder = document.getElementById('regroupements-placeholder');
    const btnAdd = document.getElementById('btn-add-regroupement');
    const actionsBanner = document.getElementById('actions-banner');

    if (placeholder) placeholder.style.display = 'none';
    if (btnAdd) btnAdd.style.display = 'inline-block';
    if (actionsBanner) actionsBanner.style.display = 'block';
  }

  /**
   * Ajoute un regroupement
   */
  function addRegroupement() {
    const regroupement = {
      id: Date.now(),
      name: `Regroupement ${state.regroupements.length + 1}`,
      classes: [],
      numGroups: 3
    };

    state.regroupements.push(regroupement);
    renderRegroupements();
    addToTimeline(`Regroupement "${regroupement.name}" ajoutÃ©`, 'success');
  }

  /**
   * Rendu de la liste des regroupements
   */
  function renderRegroupements() {
    const list = document.getElementById('regroupements-list');
    if (!list) return;

    // RÃ©cupÃ©rer les classes disponibles depuis window.STATE
    const availableClasses = [];
    if (window.STATE && window.STATE.students) {
      const zones = document.querySelectorAll('.droppable-zone[data-classe]');
      zones.forEach(zone => {
        const className = zone.getAttribute('data-classe');
        if (className && !availableClasses.includes(className)) {
          availableClasses.push(className);
        }
      });
    }

    list.innerHTML = state.regroupements.map(reg => `
      <div class="regroupement-card" data-id="${reg.id}" style="
        padding: 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <input
            type="text"
            value="${reg.name}"
            data-id="${reg.id}"
            class="regroupement-name"
            style="
              font-weight: 700;
              border: none;
              background: transparent;
              outline: none;
              font-size: 14px;
            "
          />
          <div style="display: flex; gap: 8px;">
            <button class="btn-duplicate" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
            ">
              <i class="fas fa-copy"></i>
            </button>
            <button class="btn-delete" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
              color: #ef4444;
            ">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- SÃ©lection des classes -->
        <div style="margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            SÃ©lectionner les classes :
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${availableClasses.map(className => `
              <label style="
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                border: 2px solid ${reg.classes && reg.classes.includes(className) ? '#3b82f6' : '#e5e7eb'};
                background: ${reg.classes && reg.classes.includes(className) ? '#eff6ff' : 'white'};
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
              ">
                <input
                  type="checkbox"
                  class="class-checkbox"
                  data-regroupement-id="${reg.id}"
                  data-class-name="${className}"
                  ${reg.classes && reg.classes.includes(className) ? 'checked' : ''}
                  style="margin-right: 6px;"
                />
                ${className}
              </label>
            `).join('')}
          </div>
        </div>

        <div style="font-size: 13px; color: #374151;">
          <div style="margin-bottom: 8px;">
            <strong>Classes sÃ©lectionnÃ©es :</strong>
            <span id="classes-${reg.id}">
              ${reg.classes && reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune'}
            </span>
          </div>
          <div style="margin-top: 8px;">
            <strong>Nombre de groupes :</strong>
            <input
              type="number"
              value="${reg.numGroups}"
              min="2"
              max="10"
              data-id="${reg.id}"
              class="num-groups-input"
              style="
                width: 60px;
                padding: 4px 8px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                text-align: center;
              "
            />
          </div>
        </div>
      </div>
    `).join('');

    // RÃ©attacher les Ã©vÃ©nements
    attachRegroupementEvents();
  }

  /**
   * Attache les Ã©vÃ©nements aux cartes de regroupement
   */
  function attachRegroupementEvents() {
    // Checkboxes de sÃ©lection de classes
    document.querySelectorAll('.class-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const regId = parseInt(e.target.dataset.regroupementId);
        const className = e.target.dataset.className;
        const reg = state.regroupements.find(r => r.id === regId);

        if (reg) {
          if (!reg.classes) reg.classes = [];

          if (e.target.checked) {
            if (!reg.classes.includes(className)) {
              reg.classes.push(className);
            }
          } else {
            reg.classes = reg.classes.filter(c => c !== className);
          }

          // Mettre Ã  jour l'affichage
          const display = document.getElementById(`classes-${regId}`);
          if (display) {
            display.textContent = reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune';
          }

          addToTimeline(`"${reg.name}" : ${reg.classes.length} classe(s) sÃ©lectionnÃ©e(s)`, 'info');
        }
      });
    });

    // Renommer
    document.querySelectorAll('.regroupement-name').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.name = e.target.value;
          addToTimeline(`"${reg.name}" renommÃ©`, 'info');
        }
      });
    });

    // Changer le nombre de groupes
    document.querySelectorAll('.num-groups-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.numGroups = parseInt(e.target.value);
          addToTimeline(`"${reg.name}" : ${reg.numGroups} groupes`, 'info');
        }
      });
    });

    // Dupliquer
    document.querySelectorAll('.btn-duplicate').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          const duplicate = {
            ...reg,
            id: Date.now(),
            name: `${reg.name} (copie)`,
            classes: [...(reg.classes || [])]
          };
          state.regroupements.push(duplicate);
          renderRegroupements();
          addToTimeline(`"${duplicate.name}" crÃ©Ã© par duplication`, 'success');
        }
      });
    });

    // Supprimer
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg && confirm(`Supprimer "${reg.name}" ?`)) {
          state.regroupements = state.regroupements.filter(r => r.id !== id);
          renderRegroupements();
          addToTimeline(`"${reg.name}" supprimÃ©`, 'warning');
        }
      });
    });
  }

  /**
   * GÃ©nÃ¨re les groupes
   */
  function generateGroups() {
    if (!state.scenario || !state.mode) {
      GroupsNotifications.warning('Configuration incomplÃ¨te', 'Veuillez sÃ©lectionner un scÃ©nario et un mode');
      return;
    }

    // Pour LV2, vÃ©rifier qu'une langue est sÃ©lectionnÃ©e
    if (state.scenario === 'lv2' && !state.selectedLanguage) {
      GroupsNotifications.warning('Langue manquante', 'Veuillez sÃ©lectionner une langue pour le scÃ©nario LV2');
      return;
    }

    if (state.regroupements.length === 0) {
      GroupsNotifications.warning('Aucun regroupement', 'Veuillez ajouter au moins un regroupement');
      return;
    }

    // âœ¨ Ã‰mettre l'Ã©vÃ©nement avec les pondÃ©rations personnalisÃ©es
    const event = new CustomEvent('groups:generate', {
      detail: {
        scenario: state.scenario,
        mode: state.mode,
        selectedLanguage: state.selectedLanguage,
        regroupements: state.regroupements,
        criteriaWeights: state.groupsGeneration.criteriaWeights || null // âœ¨ PondÃ©rations du joystick
      }
    });

    document.dispatchEvent(event);
    console.log('ğŸš€ Ã‰vÃ©nement groups:generate Ã©mis', event.detail);

    if (event.detail.criteriaWeights) {
      console.log('ğŸ›ï¸ PondÃ©rations personnalisÃ©es incluses:', event.detail.criteriaWeights);
    }

    addToTimeline('GÃ©nÃ©ration des groupes lancÃ©e...', 'info');
  }

  /**
   * RÃ©initialise l'interface (appelÃ© par le bouton RÃ©initialiser)
   */
  function resetInterface() {
    if (!confirm('RÃ©initialiser tous les regroupements ?\n\nCette action effacera tous les paramÃ¨tres, regroupements et rÃ©sultats actuels.')) return;

    // RÃ©initialiser complÃ¨tement l'Ã©tat
    resetState(false);

    // Re-rendre l'interface
    renderRegroupements();

    // Fermer le dashboard de swap s'il est ouvert
    const swapDashboard = document.getElementById('swap-dashboard');
    if (swapDashboard) {
      swapDashboard.remove();
    }

    // Afficher une notification
    GroupsNotifications.success('RÃ©initialisÃ©', 'L\'interface a Ã©tÃ© rÃ©initialisÃ©e avec succÃ¨s.');
    addToTimeline('Interface rÃ©initialisÃ©e', 'info');
  }

  /**
   * Met Ã  jour le rÃ©capitulatif
   */
  function updateRecap() {
    const recapScenario = document.getElementById('recap-scenario');
    const recapMode = document.getElementById('recap-mode');
    const recapLanguageRow = document.getElementById('recap-language-row');
    const recapLanguage = document.getElementById('recap-language');

    if (recapScenario) {
      recapScenario.textContent = state.scenario || '-';
    }

    if (recapMode) {
      recapMode.textContent = state.mode || '-';
    }

    // Afficher la langue si scÃ©nario LV2
    if (recapLanguageRow && recapLanguage) {
      if (state.scenario === 'lv2') {
        recapLanguageRow.style.display = 'block';
        recapLanguage.textContent = state.selectedLanguage || '-';
      } else {
        recapLanguageRow.style.display = 'none';
      }
    }
  }

  /**
   * Ajoute une entrÃ©e Ã  la timeline avec type et icÃ´ne
   */
  function addToTimeline(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString('fr-FR');
    state.timeline.push({ timestamp, message, type });

    const timelineContent = document.getElementById('timeline-content');
    if (timelineContent) {
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      const entry = document.createElement('div');
      entry.style.cssText = 'margin-bottom: 8px; display: flex; align-items: center; gap: 8px;';
      entry.innerHTML = `
        <div class="timeline-icon type-${type}">
          <i class="fas ${icons[type] || icons.info}" style="font-size: 10px;"></i>
        </div>
        <div style="flex: 1;">
          <span style="color: var(--groups-gray-600); font-size: var(--font-xs);">[${timestamp}]</span>
          <span style="color: var(--groups-gray-900); margin-left: 8px;">${message}</span>
        </div>
      `;
      timelineContent.appendChild(entry);

      // Scroll vers le bas
      timelineContent.scrollTop = timelineContent.scrollHeight;
    }
  }

  /**
   * Affiche les rÃ©sultats de gÃ©nÃ©ration
   */
  function displayResults(results) {
    const normalizedGroups = (results.groups || []).map(group => ({
      ...group,
      students: (group.students || []).map(normalizeStudentForUI).filter(student => student !== null)
    }));

    results.groups = normalizedGroups;
    results.stats = Array.isArray(results.stats) ? results.stats : [];
    results.metadata = {
      ...(results.metadata || {}),
      totalStudents: normalizedGroups.reduce((sum, group) => sum + group.students.length, 0)
    };

    state.currentResults = results;

    // Calculer les moyennes globales COM/TRA/PART/ABS
    const avgScores = calculateAverageScores(results.groups);

    // Afficher les statistiques
    const statsSection = document.getElementById('recap-stats');
    const statsContent = document.getElementById('stats-content');

    if (statsSection && statsContent) {
      statsSection.style.display = 'block';
      statsContent.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <!-- Stats principales avec design system -->
          <div class="groups-grid-2">
            <div class="groups-stat-card">
              <div class="groups-stat-label">
                <i class="fas fa-layer-group"></i> Groupes
              </div>
              <div class="groups-stat-value">${results.stats.length}</div>
              <div class="groups-stat-subtitle">Regroupements crÃ©Ã©s</div>
            </div>

            <div class="groups-stat-card">
              <div class="groups-stat-label">
                <i class="fas fa-users"></i> Ã‰lÃ¨ves
              </div>
              <div class="groups-stat-value">${results.metadata.totalStudents}</div>
              <div class="groups-stat-subtitle">Total rÃ©partis</div>
            </div>
          </div>

          <!-- Moyennes des critÃ¨res -->
          <div class="groups-stat-card" style="text-align: center;">
            <div class="groups-stat-label" style="text-align: center; margin-bottom: 12px;">
              <i class="fas fa-chart-bar"></i> Profil moyen des groupes
            </div>
            <div class="groups-stat-badges" style="justify-content: center; margin-top: 12px;">
              ${createCriteriaBadge('com', avgScores.com)}
              ${createCriteriaBadge('tra', avgScores.tra)}
              ${createCriteriaBadge('part', avgScores.part)}
              ${createCriteriaBadge('abs', avgScores.abs)}
            </div>
          </div>

          <!-- MÃ©tadonnÃ©es -->
          ${results.metadata.scenario ? `
            <div style="
              padding: 10px 14px;
              background: var(--groups-gray-50);
              border-radius: var(--radius-md);
              border-left: 3px solid var(--groups-primary);
              font-size: var(--font-sm);
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <span class="groups-text-muted" style="font-weight: 600;">ScÃ©nario :</span>
              <span class="groups-badge groups-badge-primary">
                ${results.metadata.scenario === 'besoins' ? 'ğŸ¯ Besoins' :
                  results.metadata.scenario === 'lv2' ? 'ğŸŒ LV2' :
                  results.metadata.scenario === 'options' ? 'âš™ï¸ Options' :
                  results.metadata.scenario}
              </span>
            </div>
          ` : ''}

          ${results.metadata.mode ? `
            <div style="
              padding: 10px 14px;
              background: var(--groups-gray-50);
              border-radius: var(--radius-md);
              border-left: 3px solid var(--groups-secondary);
              font-size: var(--font-sm);
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <span class="groups-text-muted" style="font-weight: 600;">Mode :</span>
              <span class="groups-badge groups-badge-secondary">
                ${results.metadata.mode === 'heterogeneous' ? 'ğŸ”€ HÃ©tÃ©rogÃ¨ne' : 'âš–ï¸ HomogÃ¨ne'}
              </span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Afficher la section swap
    const swapSection = document.getElementById('recap-swap-section');
    if (swapSection) {
      swapSection.style.display = 'block';
    }

    // Notification toast + timeline
    GroupsNotifications.success(
      'GÃ©nÃ©ration rÃ©ussie',
      `${results.stats.length} groupes crÃ©Ã©s avec ${results.metadata.totalStudents} Ã©lÃ¨ves`
    );
    addToTimeline(`${results.stats.length} groupes gÃ©nÃ©rÃ©s avec succÃ¨s`, 'success');
  }

  /**
   * Calcule les moyennes COM/TRA/PART/ABS de tous les Ã©lÃ¨ves
   */
  function calculateAverageScores(groups) {
    let totalCom = 0, totalTra = 0, totalPart = 0, totalAbs = 0, count = 0;

    groups.forEach(group => {
      group.students.forEach(student => {
        totalCom += student.com || 0;
        totalTra += student.tra || 0;
        totalPart += student.part || 0;
        totalAbs += student.abs || 0;
        count++;
      });
    });

    return {
      com: count > 0 ? totalCom / count : 0,
      tra: count > 0 ? totalTra / count : 0,
      part: count > 0 ? totalPart / count : 0,
      abs: count > 0 ? totalAbs / count : 0
    };
  }

  /**
   * Invalide les rÃ©sultats de gÃ©nÃ©ration actuels
   * Ã€ appeler aprÃ¨s toute modification qui pourrait affecter les regroupements
   */
  function invalidateCurrentResults() {
    console.log('âš ï¸ Invalidation des rÃ©sultats de gÃ©nÃ©ration...');
    state.currentResults = null;
    state.swapDashboard.allRegroupements = [];
    state.swapDashboard.currentRegroupementIndex = 0;
  }

  /**
   * Ouvre l'interface de swap - DASHBOARD MODERNE
   */
  function openSwapInterface() {
    if (!state.currentResults || !state.currentResults.groups) {
      GroupsNotifications.warning('Aucun groupe', 'Veuillez d\'abord gÃ©nÃ©rer les groupes');
      return;
    }

    // VÃ©rifier que les regroupements sont cohÃ©rents avec l'Ã©tat actuel
    if (state.regroupements.length === 0) {
      GroupsNotifications.warning('Aucun regroupement configurÃ©', 'Ajoutez au moins un regroupement dans le volet A');
      return;
    }

    // Organiser les groupes par regroupement
    organizeGroupsByRegroupement();

    if (state.swapDashboard.allRegroupements.length === 0) {
      GroupsNotifications.warning('Aucun regroupement', 'Aucun regroupement disponible');
      return;
    }

    // CrÃ©er le dashboard plein Ã©cran
    const dashboard = document.createElement('div');
    dashboard.id = 'swap-dashboard';
    dashboard.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    `;

    dashboard.innerHTML = `
      <!-- BOUTON TOGGLE HEADER (FLOTTANT, TOUJOURS VISIBLE) -->
      <button id="btn-toggle-header" style="
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 10002;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 26px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'">
        <i class="fas fa-chevron-up"></i>
      </button>

      <!-- HEADER UNIFIÃ‰ SUR UNE SEULE LIGNE (COMPACT) -->
      <div id="swap-dashboard-header" style="
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 10px 20px 10px 90px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: ${state.swapDashboard.headerVisible ? 'flex' : 'none'};
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-shrink: 0;
        flex-wrap: nowrap;
        min-height: 60px;
      ">
        <!-- ZONE GAUCHE : MENUS PRINCIPAUX -->
        <div style="display: flex; gap: 12px; align-items: center; flex-shrink: 0;">
          <!-- Bouton ParamÃ¨tres -->
          <button id="btn-open-settings" style="
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
          " onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
            <i class="fas fa-cog"></i> ParamÃ¨tres
          </button>

          <!-- Bouton Statistiques -->
          <button id="btn-open-stats" style="
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
          " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
            <i class="fas fa-chart-bar"></i> Stats
          </button>

          <!-- Menu Export (dropdown) -->
          <div style="position: relative; flex-shrink: 0;">
            <button id="btn-export-menu" style="
              background: #10b981;
              color: white;
              border: none;
              border-radius: 6px;
              padding: 8px 16px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
              white-space: nowrap;
            " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
              <i class="fas fa-download"></i> Export <i class="fas fa-chevron-down" style="margin-left: 6px; font-size: 12px;"></i>
            </button>
            <div id="export-dropdown" style="
              position: absolute;
              top: 38px;
              left: 0;
              background: white;
              border-radius: 6px;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
              min-width: 120px;
              display: none;
              overflow: hidden;
              z-index: 10002;
            ">
              <button id="btn-export-pdf" style="
                width: 100%;
                padding: 8px 12px;
                background: white;
                border: none;
                text-align: left;
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                color: #1f2937;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
              " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                <i class="fas fa-file-pdf" style="color: #ef4444; width: 12px;"></i>
                <span>PDF</span>
              </button>
              <button id="btn-export-csv" style="
                width: 100%;
                padding: 8px 12px;
                background: white;
                border: none;
                text-align: left;
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                color: #1f2937;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
                border-top: 1px solid #e5e7eb;
              " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                <i class="fas fa-file-csv" style="color: #10b981; width: 12px;"></i>
                <span>CSV</span>
              </button>
            </div>
          </div>

          <!-- Bouton Fermer -->
          <button id="close-dashboard" style="
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
          " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
            <i class="fas fa-times"></i> Fermer
          </button>
        </div>

        <!-- ZONE DROITE : TRI + NAVIGATION + SAUVEGARDES -->
        <div style="display: flex; align-items: center; gap: 16px; flex-shrink: 0;">
          <!-- Options de tri -->
          <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0;">
            <span style="font-size: 16px; font-weight: 600; opacity: 0.9; margin-right: 4px;">
              <i class="fas fa-sort"></i>
            </span>
            <button id="btn-sort-parity" data-sort="parity" class="sort-btn" style="
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.15);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">F/M</button>
            <button id="btn-sort-scoreF" data-sort="scoreF" class="sort-btn" style="
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.15);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">F</button>
            <button id="btn-sort-scoreM" data-sort="scoreM" class="sort-btn" style="
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.15);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">M</button>
            <button id="btn-sort-com" data-sort="com" class="sort-btn" style="
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.15);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">COM</button>
          </div>

          <!-- Toggle affichage classe SOURCE -->
          <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0; padding: 0 8px; border-left: 1px solid rgba(255, 255, 255, 0.3);">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.95);">
              <input type="checkbox" id="toggle-show-source" style="cursor: pointer; width: 16px; height: 16px;">
              <span title="Afficher la classe d'origine (annÃ©e prÃ©cÃ©dente) dans les cartes Ã©lÃ¨ves">
                <i class="fas fa-history"></i> Source
              </span>
            </label>
          </div>

          <!-- Navigation -->
          <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
            <button id="btn-prev-regroupement" style="
              background: rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 18px;
              transition: all 0.2s;
            " ${state.swapDashboard.currentRegroupementIndex === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
              <i class="fas fa-chevron-left"></i>
            </button>

            <div style="
              background: rgba(255, 255, 255, 0.95);
              color: #6366f1;
              padding: 8px 16px;
              border-radius: 6px;
              font-size: 15px;
              font-weight: 700;
              white-space: nowrap;
            ">
              <span id="regroupement-name">Reg 1</span>
              <span style="font-size: 13px; font-weight: 400; color: #1f2937; margin-left: 6px;">
                (<span id="regroupement-counter">1</span>/${state.swapDashboard.allRegroupements.length})
              </span>
            </div>

            <button id="btn-next-regroupement" style="
              background: rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 18px;
              transition: all 0.2s;
            " ${state.swapDashboard.currentRegroupementIndex === state.swapDashboard.allRegroupements.length - 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Sauvegardes -->
          <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0;">
            <button id="btn-load" style="
              padding: 8px 16px;
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
              white-space: nowrap;
            " title="Charger des groupes depuis les onglets Google Sheets">
              <i class="fas fa-folder-open"></i> Charger
            </button>
            <button id="btn-save-temp" style="
              padding: 8px 16px;
              background: #f97316;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
              white-space: nowrap;
            " title="Sauvegarder en brouillon (onglets TEMP) - Modifications conservÃ©es mais non publiÃ©es">
              <i class="fas fa-save"></i> Sauvegarder en brouillon
            </button>
            <button id="btn-finalize" style="
              padding: 8px 16px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
              white-space: nowrap;
            " title="Publier les groupes dÃ©finitifs - Supprime les brouillons TEMP et crÃ©e les onglets finaux">
              <i class="fas fa-check-circle"></i> Publier les groupes
            </button>
          </div>
        </div>
      </div>

      <!-- CONTENU PRINCIPAL -->
      <div style="
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      ">
        <!-- Panneau statistiques (superposÃ©, gauche) -->
        <div id="stats-panel" style="
          position: absolute;
          top: 0;
          left: ${state.swapDashboard.statsVisible ? '0' : '-350px'};
          width: 350px;
          height: 100%;
          background: white;
          box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
          overflow-y: auto;
          transition: left 0.3s ease;
          z-index: 100;
          padding: 24px;
        ">
          <h3 style="
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: #6366f1;
            border-bottom: 2px solid #8b5cf6;
            padding-bottom: 12px;
          ">
            <i class="fas fa-chart-pie"></i> Statistiques Globales
          </h3>
          <div id="stats-panel-content"></div>
        </div>

        <!-- Zone groupes (centre) -->
        <div id="groups-zone" style="
          flex: 1;
          overflow-y: auto;
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        ">
          <!-- Bandeau comparaison stats -->
          <div id="stats-comparison-banner" style="
            display: ${state.swapDashboard.comparisonVisible ? 'block' : 'none'};
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 3px solid #6d28d9;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 16px rgba(109, 40, 217, 0.2);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
              <h3 style="font-size: 17px; font-weight: 700; color: #6d28d9; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-chart-bar"></i> Comparaison des groupes
              </h3>
              <button id="btn-toggle-comparison" style="
                padding: 6px 12px;
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                color: #374151;
              ">
                <i class="fas fa-chevron-up"></i> RÃ©duire
              </button>
            </div>
            <div id="stats-comparison-content"></div>
          </div>

          <!-- Container groupes responsive -->
          <div id="swap-groups-container" style="
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: minmax(280px, 1fr);
            gap: 16px;
            flex: 1;
            min-height: 0;
            overflow-x: auto;
            align-items: stretch;
          "></div>
        </div>

        <!-- Panneau latÃ©ral droit (statistiques distribution) -->
        <div id="sidebar-panel" style="
          width: ${state.swapDashboard.sidebarCollapsed ? '60px' : '320px'};
          background: white;
          border-left: 2px solid #e5e7eb;
          overflow-y: auto;
          transition: width 0.3s ease;
          padding: ${state.swapDashboard.sidebarCollapsed ? '16px 8px' : '24px'};
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="
              font-size: ${state.swapDashboard.sidebarCollapsed ? '0' : '16px'};
              font-weight: 700;
              color: #6366f1;
              margin: 0;
              white-space: nowrap;
              overflow: hidden;
            ">
              <i class="fas fa-chart-line"></i> Distribution des scores
            </h3>
            <button id="btn-toggle-sidebar" style="
              background: #f3f4f6;
              border: 1px solid #e5e7eb;
              padding: 6px 10px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              color: #374151;
            ">
              <i class="fas fa-chevron-${state.swapDashboard.sidebarCollapsed ? 'left' : 'right'}"></i>
            </button>
          </div>
          <div id="sidebar-content" style="display: ${state.swapDashboard.sidebarCollapsed ? 'none' : 'block'};"></div>
        </div>
      </div>
    `;

    document.body.appendChild(dashboard);

    // Initialiser le contenu
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();
    attachDashboardEvents();

    console.log('âœ… Dashboard de swap ouvert');
  }

  /**
   * Rendu des groupes dans l'interface de swap - NOUVEAU DESIGN
   */
  function renderSwapGroups(groups) {
    return groups.map((group, groupIndex) => {
      // Calculer les statistiques du groupe
      const total = group.students.length;
      const girls = group.students.filter(s => s.sexe === 'F').length;
      const boys = total - girls;

      // Moyennes FranÃ§ais et Maths
      const avgF = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreF) || 0), 0) / total).toFixed(1)
        : '0.0';
      const avgM = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreM) || 0), 0) / total).toFixed(1)
        : '0.0';

      // Moyennes COM/TRA/PART/ABS du groupe
      let sumCom = 0, sumTra = 0, sumPart = 0, sumAbs = 0;
      group.students.forEach(s => {
        sumCom += s.com || 0;
        sumTra += s.tra || 0;
        sumPart += s.part || 0;
        sumAbs += s.abs || 0;
      });
      const groupScores = {
        com: total > 0 ? sumCom / total : 0,
        tra: total > 0 ? sumTra / total : 0,
        part: total > 0 ? sumPart / total : 0,
        abs: total > 0 ? sumAbs / total : 0
      };

      // Styles conditionnels pour le mode compact
      const isCompact = state.swapDashboard.groupHeaderCompact;
      const headerPadding = isCompact ? '8px' : '16px';
      const titleFontSize = isCompact ? '14px' : '18px';
      const titleMargin = isCompact ? '6px' : '12px';
      const badgePadding = isCompact ? '4px 8px' : '6px 10px';
      const badgeFontSize = isCompact ? '12px' : '14px';

      return `
        <div class="swap-group" data-group-index="${groupIndex}" style="
          background: white;
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          flex: 1;
          min-width: 0;
          display: flex;
          flex-direction: column;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        ">
          <!-- EN-TÃŠTE DU GROUPE -->
          <div style="
            background: linear-gradient(135deg, #6d28d9 0%, #4f46e5 100%);
            color: white;
            padding: ${headerPadding};
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
          ">
            <!-- LIGNE 1 : Nom du groupe -->
            <div style="font-size: ${titleFontSize}; font-weight: 700; margin-bottom: ${titleMargin}; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
              ${group.name}
            </div>

            <!-- LIGNE 2 : Stats + Scores + Badges + Toggle Radar -->
            <div style="display: flex; align-items: center; gap: ${isCompact ? '8px' : '12px'}; flex-wrap: wrap; font-size: ${badgeFontSize};">
              <!-- Total Ã©lÃ¨ves (GRAS) -->
              <span style="font-weight: 700; background: rgba(255, 255, 255, 0.15); padding: ${badgePadding}; border-radius: 6px;">
                <i class="fas fa-users"></i> ${total} Ã©lÃ¨ve${total > 1 ? 's' : ''}
              </span>

              <!-- ParitÃ© F/M (GRAS) -->
              <span style="font-weight: 700; background: rgba(255, 255, 255, 0.15); padding: ${badgePadding}; border-radius: 6px;">
                <i class="fas fa-venus" style="color: #fcd34d;"></i> ${girls}F /
                <i class="fas fa-mars" style="color: #93c5fd;"></i> ${boys}M
              </span>

              <!-- Moyenne FranÃ§ais -->
              <span style="background: rgba(255, 255, 255, 0.15); padding: ${badgePadding}; border-radius: 6px;">
                <span style="font-weight: 600;">F:</span> ${avgF}
              </span>

              <!-- Moyenne Maths -->
              <span style="background: rgba(255, 255, 255, 0.15); padding: ${badgePadding}; border-radius: 6px;">
                <span style="font-weight: 600;">M:</span> ${avgM}
              </span>

              <!-- Badges COM/TRA/PART/ABS -->
              ${total > 0 ? `
                <div style="display: flex; gap: 6px;">
                  ${createCriteriaBadge('com', groupScores.com)}
                  ${createCriteriaBadge('tra', groupScores.tra)}
                  ${createCriteriaBadge('part', groupScores.part)}
                  ${createCriteriaBadge('abs', groupScores.abs)}
                </div>
              ` : ''}
            </div>
          </div>

          <!-- LISTE DES Ã‰LÃˆVES -->
          <div class="swap-students-list" data-group-index="${groupIndex}" style="
            padding: 12px;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
          ">
            ${group.students.length === 0 ? `
              <div style="
                padding: 24px;
                text-align: center;
                color: #1f2937;
                font-size: 13px;
                border: 2px dashed #e5e7eb;
                border-radius: 8px;
              ">
                <i class="fas fa-inbox"></i><br>
                Aucun Ã©lÃ¨ve
              </div>
            ` : group.students.map((student, studentIndex) => {
              const isCOM1 = (student.com || 0) === 1;
              const scoreF = parseFloat(student.scoreF) || 0;
              const scoreM = parseFloat(student.scoreM) || 0;
              const genderIcon = student.sexe === 'F'
                ? '<i class="fas fa-circle" style="color: #ec4899;"></i>'
                : '<i class="fas fa-circle" style="color: #3b82f6;"></i>';

              return `
                <div
                  class="swap-student-card"
                  draggable="true"
                  tabindex="0"
                  role="button"
                  aria-label="Ã‰lÃ¨ve ${student.lastName} ${student.firstName}, FranÃ§ais ${scoreF.toFixed(1)}, Maths ${scoreM.toFixed(1)}"
                  data-group-index="${groupIndex}"
                  data-student-index="${studentIndex}"
                  data-student-id="${student.id}"
                  style="
                    padding: 6px 10px;
                    background: #f9fafb;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    cursor: move;
                    font-size: 12px;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  "
                  onmouseover="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.2)'; this.style.transform='translateX(4px)'"
                  onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateX(0)'"
                >
                  <!-- âœ… TOUT SUR UNE LIGNE -->
                  ${genderIcon}
                  <span class="student-name-v4 size-medium" style="
                    font-weight: 700;
                    color: ${isCOM1 ? '#ef4444' : '#1f2937'};
                    ${isCOM1 ? 'text-decoration: underline;' : ''}
                    flex: 1;
                    min-width: 0;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                  ">
                    ${student.lastName} ${student.firstName}
                  </span>
                  ${state.swapDashboard.showSourceClass && (student.SOURCE || student.source) ? `
                    <span style="
                      font-size: 10px;
                      padding: 2px 5px;
                      background: #fef3c7;
                      color: #92400e;
                      border-radius: 3px;
                      font-weight: 600;
                    " title="Classe source (origine annÃ©e prÃ©cÃ©dente)">${student.SOURCE || student.source}</span>
                  ` : ''}
                  ${student.class ? `
                    <span style="
                      font-size: 10px;
                      padding: 2px 5px;
                      background: #dbeafe;
                      color: #1e40af;
                      border-radius: 3px;
                      font-weight: 600;
                    ">${student.class}</span>
                  ` : ''}
                  <span class="fm-scores" style="display: inline-flex; gap: 4px;">
                    <span style="
                      padding: 2px 7px;
                      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                      color: white;
                      border-radius: 4px;
                      font-size: 10px;
                      font-weight: 800;
                      letter-spacing: 0.3px;
                    ">
                      F:${scoreF.toFixed(1)}
                    </span>
                    <span style="
                      padding: 2px 7px;
                      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
                      color: white;
                      border-radius: 4px;
                      font-size: 10px;
                      font-weight: 800;
                      letter-spacing: 0.3px;
                    ">
                      M:${scoreM.toFixed(1)}
                    </span>
                  </span>
                  <!-- Pastilles COM/TRA/PART/ABS (systÃ¨me InterfaceV2) -->
                  <span class="scores" style="display: flex; align-items: center; gap: 4px;">
                    ${(student.com && student.com > 0) ? `<div class="score-pill score-${Math.round(student.com)}" title="Comportement: ${student.com}/4">C</div>` : ''}
                    ${(student.tra && student.tra > 0) ? `<div class="score-pill score-${Math.round(student.tra)}" title="Travail: ${student.tra}/4">T</div>` : ''}
                    ${(student.part && student.part > 0) ? `<div class="score-pill score-${Math.round(student.part)}" title="Participation: ${student.part}/4">P</div>` : ''}
                    ${(student.abs && student.abs > 0) ? `<div class="score-pill score-${Math.round(student.abs)}" title="Absences: ${student.abs}/4">A</div>` : ''}
                  </span>
                  <i class="fas fa-grip-vertical" style="color: #d1d5db;"></i>
                </div>
              `;
            }).join('')}
          </div>

          <!-- FOOTER UNIFORME DE LA CARTE -->
          <div style="
            padding: 10px 12px;
            background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            min-height: 48px;
          ">
            ${total > 0 ? `
              <div style="font-size: 12px; color: #6b7280; text-align: center;">
                <i class="fas fa-users"></i> ${total} Ã©lÃ¨ve${total > 1 ? 's' : ''} â€¢ <i class="fas fa-venus" style="color: #ec4899;"></i> ${girls}F / <i class="fas fa-mars" style="color: #3b82f6;"></i> ${boys}M
              </div>
            ` : `
              <div style="font-size: 12px; color: #9ca3af; text-align: center;">
                <i class="fas fa-info-circle"></i> Ajoutez des Ã©lÃ¨ves pour voir les stats
              </div>
            `}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * Organise les groupes par regroupement
   */
  function organizeGroupsByRegroupement() {
    if (!state.currentResults || !state.currentResults.groups) {
      state.swapDashboard.allRegroupements = [];
      return;
    }

    // Grouper par regroupement en utilisant la propriÃ©tÃ© regroupementName
    const regroupementMap = {};
    let globalGroupCounter = 1; // âœ… COMPTEUR GLOBAL pour numÃ©rotation continue

    state.currentResults.groups.forEach((group, index) => {
      const regroupementName = group.regroupementName || 'Regroupement 1';

      if (!regroupementMap[regroupementName]) {
        regroupementMap[regroupementName] = {
          name: regroupementName,
          groups: []
        };
      }

      // âœ… Renommer le groupe avec numÃ©rotation GLOBALE
      const renamedGroup = {
        ...group,
        originalName: group.name,
        name: `Groupe ${globalGroupCounter}`,
        globalId: globalGroupCounter // Ajouter l'ID global pour rÃ©fÃ©rence
      };

      regroupementMap[regroupementName].groups.push(renamedGroup);
      globalGroupCounter++; // IncrÃ©menter le compteur global
    });

    state.swapDashboard.allRegroupements = Object.values(regroupementMap);
    state.swapDashboard.currentRegroupementIndex = 0;

    console.log('ğŸ“Š Regroupements organisÃ©s:', state.swapDashboard.allRegroupements.length);
    state.swapDashboard.allRegroupements.forEach((reg, i) => {
      console.log(`  - ${reg.name}: ${reg.groups.length} groupes`);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYSTÃˆME D'HISTORIQUE ET RÃ‰GÃ‰NÃ‰RATION (UNDO/REDO)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Sauvegarde l'Ã©tat actuel dans l'historique
   */
  function saveCurrentStateToHistory() {
    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      console.warn('âš ï¸ Aucun regroupement actuel Ã  sauvegarder');
      return;
    }

    // CrÃ©er un snapshot de l'Ã©tat actuel
    const snapshot = {
      timestamp: new Date().toISOString(),
      regroupement: JSON.parse(JSON.stringify(currentReg)), // Deep clone
      metadata: JSON.parse(JSON.stringify(state.currentResults.metadata))
    };

    // Supprimer l'historique aprÃ¨s l'index actuel (si on a fait des UNDO avant)
    state.swapDashboard.history = state.swapDashboard.history.slice(0, state.swapDashboard.historyIndex + 1);

    // Ajouter le nouveau snapshot
    state.swapDashboard.history.push(snapshot);
    state.swapDashboard.historyIndex = state.swapDashboard.history.length - 1;

    // Limiter l'historique Ã  10 Ã©tats pour Ã©viter une consommation mÃ©moire excessive
    if (state.swapDashboard.history.length > 10) {
      state.swapDashboard.history.shift();
      state.swapDashboard.historyIndex--;
    }

    console.log(`ğŸ’¾ Ã‰tat sauvegardÃ© dans l'historique (${state.swapDashboard.history.length} Ã©tats)`);
  }

  /**
   * RÃ©gÃ©nÃ¨re le regroupement actuel avec les pondÃ©rations actuelles
   */
  async function regenerateCurrentRegroupement() {
    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      GroupsNotifications.warning('Aucun regroupement', 'Aucun regroupement sÃ©lectionnÃ© pour la rÃ©gÃ©nÃ©ration');
      return;
    }

    // Sauvegarder l'Ã©tat actuel avant rÃ©gÃ©nÃ©ration
    saveCurrentStateToHistory();

    console.log('ğŸ”„ RÃ©gÃ©nÃ©ration du regroupement:', currentReg.name);

    // RÃ©cupÃ©rer les mÃ©tadonnÃ©es de la gÃ©nÃ©ration originale
    const originalMetadata = state.currentResults.metadata;
    const scenario = originalMetadata.scenario;
    const mode = originalMetadata.mode;
    const numGroups = currentReg.groups.length;

    // RÃ©cupÃ©rer les Ã©lÃ¨ves du regroupement actuel
    const students = currentReg.groups.flatMap(group => group.students);

    console.log(`ğŸ² RÃ©gÃ©nÃ©ration avec ${students.length} Ã©lÃ¨ves en ${numGroups} groupes (${mode}, scÃ©nario: ${scenario})`);

    // RÃ©cupÃ©rer les pondÃ©rations personnalisÃ©es actuelles
    const criteriaWeights = state.groupsGeneration.criteriaWeights || null;

    try {
      // Loader pendant la rÃ©gÃ©nÃ©ration
      const notification = GroupsNotifications.info('RÃ©gÃ©nÃ©ration en cours', 'Calcul des nouveaux groupes...');

      // Appeler l'algorithme
      const result = await GroupsAlgorithmV4.distribute({
        students,
        mode,
        numGroups,
        scenario,
        criteriaWeights
      });

      // Remplacer le regroupement actuel par le nouveau
      const newGroups = result.groups.map((group, idx) => ({
        ...group,
        regroupementName: currentReg.name,
        name: `Groupe ${state.swapDashboard.allRegroupements.flatMap(r => r.groups).findIndex((g, i) => {
          // Trouver l'index global du premier groupe de ce regroupement
          return r.groups[0] === g;
        }) + idx + 1}`
      }));

      // Mettre Ã  jour le regroupement
      currentReg.groups = newGroups;

      // Re-render le dashboard
      renderCurrentRegroupement();
      updateStatsPanel();
      updateSidebarPanel();
      updateStatsComparison();

      // Fermer la notification de chargement
      setTimeout(() => notification.remove(), 500);

      GroupsNotifications.success('RÃ©gÃ©nÃ©ration rÃ©ussie', `Le regroupement "${currentReg.name}" a Ã©tÃ© rÃ©gÃ©nÃ©rÃ© avec les pondÃ©rations actuelles`);

      // Mettre Ã  jour les boutons UNDO/REDO
      updateHistoryButtons();

      console.log('âœ… RÃ©gÃ©nÃ©ration terminÃ©e');
    } catch (error) {
      console.error('âŒ Erreur lors de la rÃ©gÃ©nÃ©ration:', error);
      GroupsNotifications.error('Erreur de rÃ©gÃ©nÃ©ration', error.message);
    }
  }

  /**
   * Annule la derniÃ¨re rÃ©gÃ©nÃ©ration (UNDO)
   */
  function undoRegeneration() {
    if (state.swapDashboard.historyIndex < 1) {
      GroupsNotifications.warning('Aucun historique', 'Impossible de revenir en arriÃ¨re');
      return;
    }

    // Reculer dans l'historique
    state.swapDashboard.historyIndex--;
    const snapshot = state.swapDashboard.history[state.swapDashboard.historyIndex];

    console.log('â†¶ UNDO: restauration de l\'Ã©tat', snapshot.timestamp);

    // Restaurer le regroupement
    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    currentReg.groups = JSON.parse(JSON.stringify(snapshot.regroupement.groups));

    // Re-render
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();

    // Mettre Ã  jour les boutons
    updateHistoryButtons();

    GroupsNotifications.success('Annulation', 'Ã‰tat prÃ©cÃ©dent restaurÃ©');
  }

  /**
   * Refait la rÃ©gÃ©nÃ©ration annulÃ©e (REDO)
   */
  function redoRegeneration() {
    if (state.swapDashboard.historyIndex >= state.swapDashboard.history.length - 1) {
      GroupsNotifications.warning('Aucun historique', 'Impossible d\'avancer');
      return;
    }

    // Avancer dans l'historique
    state.swapDashboard.historyIndex++;
    const snapshot = state.swapDashboard.history[state.swapDashboard.historyIndex];

    console.log('â†· REDO: restauration de l\'Ã©tat', snapshot.timestamp);

    // Restaurer le regroupement
    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    currentReg.groups = JSON.parse(JSON.stringify(snapshot.regroupement.groups));

    // Re-render
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();

    // Mettre Ã  jour les boutons
    updateHistoryButtons();

    GroupsNotifications.success('RÃ©tablissement', 'Ã‰tat suivant restaurÃ©');
  }

  /**
   * Met Ã  jour l'Ã©tat des boutons UNDO/REDO
   */
  function updateHistoryButtons() {
    const undoBtn = document.getElementById('btn-undo-modal');
    const redoBtn = document.getElementById('btn-redo-modal');

    if (undoBtn) {
      const canUndo = state.swapDashboard.historyIndex > 0;
      undoBtn.disabled = !canUndo;
      undoBtn.style.opacity = canUndo ? '1' : '0.5';
      undoBtn.style.cursor = canUndo ? 'pointer' : 'not-allowed';
    }

    if (redoBtn) {
      const canRedo = state.swapDashboard.historyIndex < state.swapDashboard.history.length - 1;
      redoBtn.disabled = !canRedo;
      redoBtn.style.opacity = canRedo ? '1' : '0.5';
      redoBtn.style.cursor = canRedo ? 'pointer' : 'not-allowed';
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYSTÃˆME DE SAUVEGARDE ET CHARGEMENT DES GROUPES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * GÃ©nÃ¨re le prÃ©fixe de scÃ©nario pour les noms d'onglets
   * @param {string} scenario - 'besoins' | 'lv2' | 'options'
   * @returns {string} PrÃ©fixe ('B', 'LV', 'Op')
   */
  function getScenarioPrefix(scenario) {
    const prefixes = {
      'besoins': 'B',
      'lv2': 'LV',
      'options': 'Op'
    };
    return prefixes[scenario] || 'Grp';
  }

  /**
   * GÃ©nÃ¨re le nom d'un onglet de groupe
   * @param {number} groupId - ID global du groupe
   * @param {string} scenario - ScÃ©nario actif
   * @param {boolean} isTemp - Si true, ajoute suffixe TEMP
   * @returns {string} Nom de l'onglet (ex: "6Â°GrpB1TEMP" ou "6Â°GrpLV3")
   */
  function generateSheetName(groupId, scenario, isTemp = false) {
    const prefix = getScenarioPrefix(scenario);
    const suffix = isTemp ? 'TEMP' : '';
    // Format: 6Â°GrpB1TEMP ou 6Â°GrpLV3
    return `6Â°Grp${prefix}${groupId}${suffix}`;
  }

  /**
   * Sauvegarde les groupes dans des onglets Google Sheets
   * @param {boolean} isTemp - Si true, crÃ©er onglets TEMP, sinon dÃ©finitifs
   */
  async function saveGroups(isTemp = true) {
    if (!state.currentResults || !state.currentResults.groups) {
      GroupsNotifications.warning('Aucun groupe', 'Veuillez d\'abord gÃ©nÃ©rer des groupes');
      return;
    }

    const groups = state.currentResults.groups;
    const scenario = state.currentResults.metadata.scenario;
    const mode = isTemp ? 'TEMP' : 'DÃ‰FINITIF';

    console.log(`ğŸ’¾ Sauvegarde ${mode} de ${groups.length} groupe(s)...`);

    // Afficher un loader
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'save-loading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10002;
      background: white;
      padding: 32px 48px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
    `;
    loadingDiv.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¾</div>
      <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">
        Sauvegarde ${mode}...
      </div>
      <div style="font-size: 14px; color: #6b7280;">
        CrÃ©ation de ${groups.length} onglet(s)
      </div>
      <div style="margin-top: 16px; width: 200px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
        <div style="width: 0%; height: 100%; background: #3b82f6; animation: progress 2s ease-in-out infinite;"></div>
      </div>
      <style>
        @keyframes progress {
          0%, 100% { width: 0%; }
          50% { width: 100%; }
        }
      </style>
    `;
    document.body.appendChild(loadingDiv);

    try {
      // PrÃ©parer les donnÃ©es pour chaque groupe
      const groupsData = groups.map(group => ({
        sheetName: generateSheetName(group.id, scenario, isTemp),
        students: group.students.map(student => ({
          id: student.id,
          nom: student.lastName,
          prenom: student.firstName,
          sexe: student.sexe,
          classe: student.class,
          scoreF: student.scoreF,
          scoreM: student.scoreM,
          com: student.com,
          tra: student.tra,
          part: student.part,
          abs: student.abs,
          lv2: student.lv2,
          options: student.options || [],
          source: student.SOURCE || student.source || student.class || '' // O - SOURCE (classe d'origine)
        })),
        metadata: {
          // âœ¨ MÃ©tadonnÃ©es complÃ¨tes de la gÃ©nÃ©ration (incluant pondÃ©rations)
          ...state.currentResults.metadata,

          // MÃ©tadonnÃ©es spÃ©cifiques au groupe (peuvent override les mÃ©tadonnÃ©es globales)
          groupId: group.id,
          groupName: group.name,
          regroupementName: group.regroupementName,
          scenario: scenario,
          mode: state.currentResults.metadata.mode,
          scenarioApplied: state.currentResults.metadata.scenarioApplied || scenario,
          criteriaWeights: state.currentResults.metadata.criteriaWeights || null,
          criteriaWeightsSource: state.currentResults.metadata.criteriaWeightsSource || getCriteriaWeightsSource(),
          criteriaWeightsOverridesApplied: state.currentResults.metadata.criteriaWeightsOverridesApplied ?? null,
          selectedLanguage: state.currentResults.metadata.selectedLanguage || state.selectedLanguage || null,
          isTemp: isTemp,
          savedAt: new Date().toISOString()
        }
      }));

      // Appeler la fonction Apps Script pour crÃ©er les onglets
      const result = await gsRun('saveGroupsToSheetsV4', groupsData, isTemp);

      // Supprimer le loader
      loadingDiv.remove();

      // Afficher le rÃ©sultat
      if (result.success) {
        const message = `Sauvegarde ${mode} rÃ©ussie ! ${result.created} onglet(s) crÃ©Ã©(s)` +
          (result.updated ? `, ${result.updated} mis Ã  jour` : '') +
          (result.deleted && !isTemp ? `, ${result.deleted} TEMP supprimÃ©(s)` : '');

        GroupsNotifications.success('Sauvegarde rÃ©ussie', message);
        console.log('âœ… Sauvegarde rÃ©ussie:', result);
      } else {
        throw new Error(result.error || 'Erreur inconnue');
      }

    } catch (error) {
      loadingDiv.remove();
      console.error('âŒ Erreur sauvegarde:', error);
      GroupsNotifications.error('Erreur de sauvegarde', `Erreur sauvegarde ${mode}: ${error.message || error}`);
    }
  }

  /**
   * Charge des groupes depuis des onglets Google Sheets
   */
  async function loadGroups() {
    console.log('ğŸ“‚ Chargement des groupes...');

    // Afficher un loader
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'load-loading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10002;
      background: white;
      padding: 32px 48px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
    `;
    loadingDiv.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‚</div>
      <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">
        Chargement...
      </div>
      <div style="font-size: 14px; color: #6b7280;">
        Recherche des onglets de groupes
      </div>
    `;
    document.body.appendChild(loadingDiv);

    try {
      // Appeler la fonction Apps Script pour charger les onglets
      const result = await gsRun('loadGroupsFromSheetsV4');

      loadingDiv.remove();

      if (result.success && result.groups.length > 0) {
        // Reconstruire la structure de rÃ©sultats
        const firstMetadata = result.groups[0]?.metadata || {};

        const loadedResults = {
          groups: result.groups.map(g => ({
            id: g.metadata.groupId,
            name: g.metadata.groupName,
            students: (g.students || []).map(normalizeStudentForUI).filter(student => student !== null),
            regroupementName: g.metadata.regroupementName,
            regroupementId: (g.metadata.regroupementName || '').replace(/\s+/g, '-').toLowerCase()
          })),
          metadata: {
            scenario: firstMetadata.scenario,
            scenarioApplied: firstMetadata.scenarioApplied || firstMetadata.scenario,
            mode: firstMetadata.mode,
            totalGroups: result.groups.length,
            totalStudents: result.groups.reduce((sum, g) => sum + ((g.students || []).length), 0),
            timestamp: new Date().toISOString(),
            loadedFrom: result.sheetNames,
            criteriaWeights: firstMetadata.criteriaWeights || null,
            criteriaWeightsSource: firstMetadata.criteriaWeightsSource || 'scenario-default',
            criteriaWeightsOverridesApplied: firstMetadata.criteriaWeightsOverridesApplied ?? null,
            selectedLanguage: firstMetadata.selectedLanguage || null
          }
        };

        loadedResults.metadata.totalStudents = loadedResults.groups.reduce(
          (sum, group) => sum + group.students.length,
          0
        );

        // Afficher les rÃ©sultats chargÃ©s
        displayResults(loadedResults);

        GroupsNotifications.success('Chargement rÃ©ussi', `${result.groups.length} groupe(s) chargÃ©(s) depuis les onglets`);
        console.log('âœ… Groupes chargÃ©s:', loadedResults);

      } else {
        GroupsNotifications.info('Aucun groupe', 'Aucun groupe trouvÃ© dans les onglets');
      }

    } catch (error) {
      loadingDiv.remove();
      console.error('âŒ Erreur chargement:', error);
      GroupsNotifications.error('Erreur de chargement', `Erreur chargement: ${error.message || error}`);
    }
  }

  /**
   * Rendu du regroupement courant
   */
  function renderCurrentRegroupement() {
    const container = document.getElementById('swap-groups-container');
    if (!container) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      container.innerHTML = '<p style="color: #1f2937;">Aucun regroupement disponible</p>';
      return;
    }

    // Mettre Ã  jour le nom et le compteur
    const nameEl = document.getElementById('regroupement-name');
    const counterEl = document.getElementById('regroupement-counter');
    if (nameEl) nameEl.textContent = currentReg.name;
    if (counterEl) counterEl.textContent = state.swapDashboard.currentRegroupementIndex + 1;

    // Rendre les groupes
    container.innerHTML = renderSwapGroups(currentReg.groups);

    // Activer le drag & drop
    enableDragAndDrop();

    // âœ… NOUVEAU : Attacher les Ã©vÃ©nements de clic pour le mode Focus Ã©lÃ¨ve
    attachStudentFocusEvents();
  }

  /**
   * Attache les Ã©vÃ©nements de clic sur les cartes Ã©lÃ¨ves pour le mode Focus
   */
  function attachStudentFocusEvents() {
    const cards = document.querySelectorAll('.swap-student-card');
    cards.forEach(card => {
      // Double-clic pour ouvrir le mode Focus
      card.addEventListener('dblclick', (e) => {
        const groupIndex = parseInt(card.dataset.groupIndex);
        const studentIndex = parseInt(card.dataset.studentIndex);
        const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

        if (currentReg && currentReg.groups[groupIndex]) {
          const group = currentReg.groups[groupIndex];
          const student = group.students[studentIndex];

          if (student) {
            openStudentFocusModal(student, group.name);
          }
        }
      });

      // Support clavier (EntrÃ©e)
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          card.dispatchEvent(new Event('dblclick'));
        }
      });
    });
  }

  // Fonction attachRadarToggleEvents supprimÃ©e (radar retirÃ©)

  /**
   * Active le drag & drop pour les Ã©lÃ¨ves
   */
  function enableDragAndDrop() {
    let draggedElement = null;
    let draggedData = null;

    // Ã‰vÃ©nements sur les cartes Ã©lÃ¨ves
    document.querySelectorAll('.swap-student-card').forEach(card => {
      card.addEventListener('dragstart', (e) => {
        draggedElement = e.target;
        draggedData = {
          groupIndex: parseInt(e.target.dataset.groupIndex),
          studentIndex: parseInt(e.target.dataset.studentIndex),
          studentId: e.target.dataset.studentId
        };
        e.target.style.opacity = '0.5';
      });

      card.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
      });
    });

    // Ã‰vÃ©nements sur les zones de drop (listes d'Ã©lÃ¨ves)
    document.querySelectorAll('.swap-students-list').forEach(list => {
      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        list.style.background = '#f3e8ff';
      });

      list.addEventListener('dragleave', (e) => {
        list.style.background = '';
      });

      list.addEventListener('drop', (e) => {
        e.preventDefault();
        list.style.background = '';

        if (!draggedData) return;

        const targetGroupIndex = parseInt(list.dataset.groupIndex);
        const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

        if (!currentReg) return;

        // DÃ©placer l'Ã©lÃ¨ve
        const sourceGroup = currentReg.groups[draggedData.groupIndex];
        const targetGroup = currentReg.groups[targetGroupIndex];

        if (sourceGroup && targetGroup) {
          const student = sourceGroup.students.splice(draggedData.studentIndex, 1)[0];
          if (student) {
            targetGroup.students.push(student);

            // Re-rendre l'interface
            renderCurrentRegroupement();
            updateSidebarPanel();
            updateStatsComparison();

            console.log(`âœ… Ã‰lÃ¨ve ${student.lastName} dÃ©placÃ© du groupe ${draggedData.groupIndex + 1} vers ${targetGroupIndex + 1}`);
          }
        }
      });
    });
  }

  /**
   * Met Ã  jour le panneau des statistiques
   */
  function updateStatsPanel() {
    const content = document.getElementById('stats-panel-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      content.innerHTML = '<p style="color: #1f2937;">Aucune donnÃ©e</p>';
      return;
    }

    // Calculer les statistiques globales
    const totalStudents = currentReg.groups.reduce((sum, g) => sum + g.students.length, 0);
    const totalGirls = currentReg.groups.reduce((sum, g) => sum + g.students.filter(s => s.sexe === 'F').length, 0);
    const totalBoys = totalStudents - totalGirls;

    const avgScoreF = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.scoreF) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgScoreM = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.scoreM) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgCOM = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.com) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgTRA = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.tra) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgPART = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.part) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgABS = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.abs) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    content.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 16px;">

        <!-- âœ… NOUVEAU : PondÃ©rations actives -->
        ${(() => {
          // RÃ©cupÃ©rer les pondÃ©rations depuis les mÃ©tadonnÃ©es
          const metadata = state.currentResults?.metadata || {};
          const scenarioKey = metadata.scenarioApplied || metadata.scenario || 'besoins';
          const fallbackWeights = SCENARIO_WEIGHT_PRESETS[scenarioKey] || SCENARIO_WEIGHT_PRESETS.besoins;
          const weights = metadata.criteriaWeights || fallbackWeights;

          // Normaliser pour affichage (valeur absolue pour les barres)
          const criteria = [
            {
              key: 'scoreF',
              label: 'Score FranÃ§ais',
              value: weights.scoreF || 0,
              color: '#7c3aed',
              tooltip: 'Note en FranÃ§ais (1-4). Poids positif = favorise les bons Ã©lÃ¨ves dans groupes hÃ©tÃ©rogÃ¨nes.'
            },
            {
              key: 'scoreM',
              label: 'Score Maths',
              value: weights.scoreM || 0,
              color: '#4f46e5',
              tooltip: 'Note en MathÃ©matiques (1-4). Poids positif = favorise les bons Ã©lÃ¨ves.'
            },
            {
              key: 'com',
              label: 'Comportement',
              value: weights.com || 0,
              color: '#06b6d4',
              tooltip: 'QualitÃ© du comportement en classe (0-4). Poids positif = valorise les Ã©lÃ¨ves calmes et respectueux.'
            },
            {
              key: 'tra',
              label: 'Travail',
              value: weights.tra || 0,
              color: '#10b981',
              tooltip: 'SÃ©rieux et rÃ©gularitÃ© du travail (0-4). Poids positif = valorise les Ã©lÃ¨ves assidus.'
            },
            {
              key: 'part',
              label: 'Participation',
              value: weights.part || 0,
              color: '#f59e0b',
              tooltip: 'Niveau de participation en cours (0-4). Poids positif = favorise les Ã©lÃ¨ves actifs.'
            },
            {
              key: 'abs',
              label: 'Absences',
              value: weights.abs || 0,
              color: '#ef4444',
              tooltip: 'Nombre d\'absences (0-4). Poids nÃ©gatif = pÃ©nalise les Ã©lÃ¨ves souvent absents.'
            }
          ];

          const maxWeight = Math.max(...criteria.map(c => Math.abs(c.value)), 1);

          return `
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
          border-radius: 8px;
          border-left: 4px solid #a855f7;
        " role="region" aria-label="PondÃ©rations actives">
          <div style="font-size: 14px; font-weight: 700; color: #7e22ce; margin-bottom: 12px;">
            <i class="fas fa-sliders-h"></i> PondÃ©rations actives
          </div>
          <div style="font-size: 11px; color: #374151; margin-bottom: 12px; line-height: 1.4;">
            ${metadata.scenarioApplied ? `ScÃ©nario : <strong>${metadata.scenarioApplied}</strong>` : 'PondÃ©rations par dÃ©faut'}${metadata.criteriaWeightsSource ? ` â€¢ <em>${metadata.criteriaWeightsSource}</em>` : ''}
          </div>
          ${criteria.map(crit => {
            const absValue = Math.abs(crit.value);
            const percentage = (absValue / maxWeight) * 100;
            const sign = crit.value < 0 ? 'âˆ’' : '+';

            return `
            <div style="margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-size: 11px; font-weight: 600; color: #374151; cursor: help;" data-tooltip="${crit.tooltip}">${crit.label}</span>
                <span style="
                  font-size: 11px;
                  font-weight: 800;
                  color: ${crit.value < 0 ? '#dc2626' : '#059669'};
                  padding: 2px 6px;
                  background: ${crit.value < 0 ? '#fee2e2' : '#d1fae5'};
                  border-radius: 3px;
                ">${sign}${absValue.toFixed(1)}</span>
              </div>
              <div style="
                width: 100%;
                height: 8px;
                background: #e5e7eb;
                border-radius: 4px;
                overflow: hidden;
                position: relative;
              " role="progressbar" aria-valuenow="${absValue}" aria-valuemin="0" aria-valuemax="${maxWeight}" aria-label="${crit.label}: ${crit.value}">
                <div style="
                  width: ${percentage}%;
                  height: 100%;
                  background: linear-gradient(90deg, ${crit.color} 0%, ${crit.color}dd 100%);
                  transition: width 0.3s ease;
                  box-shadow: 0 0 4px ${crit.color}80;
                "></div>
              </div>
            </div>
            `;
          }).join('')}
        </div>
          `;
        })()}

        <!-- Effectifs -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
          border-radius: 8px;
          border-left: 4px solid #3b82f6;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">
            <i class="fas fa-users"></i> Effectifs
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>Total :</strong> <strong style="font-weight: 700; color: #1f2937;">${totalStudents} Ã©lÃ¨ves</strong></div>
            <div><strong>Filles :</strong> <strong style="font-weight: 700; color: #1f2937;">${totalGirls}</strong> (${(totalStudents > 0 ? (totalGirls / totalStudents * 100) : 0).toFixed(1)}%)</div>
            <div><strong>GarÃ§ons :</strong> <strong style="font-weight: 700; color: #1f2937;">${totalBoys}</strong> (${(totalStudents > 0 ? (totalBoys / totalStudents * 100) : 0).toFixed(1)}%)</div>
            <div><strong>Groupes :</strong> <strong style="font-weight: 700; color: #1f2937;">${currentReg.groups.length}</strong></div>
          </div>
        </div>

        <!-- Scores acadÃ©miques -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border-radius: 8px;
          border-left: 4px solid #f59e0b;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 12px;">
            <i class="fas fa-chart-line"></i> Scores acadÃ©miques
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>Moy FranÃ§ais :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgScoreF}</strong> / 4</div>
            <div><strong>Moy Maths :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgScoreM}</strong> / 4</div>
          </div>
        </div>

        <!-- CritÃ¨res comportementaux -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
          border-radius: 8px;
          border-left: 4px solid #8b5cf6;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #6b21a8; margin-bottom: 12px;">
            <i class="fas fa-clipboard-check"></i> CritÃ¨res comportementaux
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>COM :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgCOM}</strong> / 4</div>
            <div><strong>TRA :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgTRA}</strong> / 4</div>
            <div><strong>PART :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgPART}</strong> / 4</div>
            <div><strong>ABS :</strong> <strong style="font-weight: 700; color: #1f2937;">${avgABS}</strong> / 4</div>
          </div>
        </div>

      </div>
    `;
  }

  /**
   * Met Ã  jour le panneau latÃ©ral (distribution)
   */
  function updateSidebarPanel() {
    const content = document.getElementById('sidebar-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      content.innerHTML = '<p style="color: #1f2937; font-size: 13px;">Aucune donnÃ©e</p>';
      return;
    }

    const totalStudents = currentReg.groups.reduce((sum, g) => sum + g.students.length, 0);
    const totalGirls = currentReg.groups.reduce((sum, g) => sum + g.students.filter(s => s.sexe === 'F').length, 0);
    const totalBoys = totalStudents - totalGirls;

    // Distribution des scores pour chaque groupe
    const groupDistributions = currentReg.groups.map(group => {
      const scoreF = group.students.length > 0
        ? group.students.reduce((sum, s) => sum + (parseFloat(s.scoreF) || 0), 0) / group.students.length
        : 0;
      const scoreM = group.students.length > 0
        ? group.students.reduce((sum, s) => sum + (parseFloat(s.scoreM) || 0), 0) / group.students.length
        : 0;

      return {
        name: group.name,
        scoreF: scoreF.toFixed(2),
        scoreM: scoreM.toFixed(2),
        girls: group.students.filter(s => s.sexe === 'F').length,
        boys: group.students.filter(s => s.sexe === 'M').length
      };
    });

    content.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 20px;">

        <!-- ParitÃ© -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-balance-scale"></i> ParitÃ© F/M
          </h4>
          <div style="
            padding: 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
          ">
            ${totalGirls}F / ${totalBoys}M
            <div style="font-size: 12px; font-weight: 600; margin-top: 4px;">
              (${(totalStudents > 0 ? (totalGirls / totalStudents * 100) : 0).toFixed(1)}% / ${(totalStudents > 0 ? (totalBoys / totalStudents * 100) : 0).toFixed(1)}%)
            </div>
          </div>
        </div>

        <!-- Distribution FranÃ§ais -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-book"></i> Distribution FranÃ§ais
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${groupDistributions.map(dist => {
              const score = parseFloat(dist.scoreF);
              const percentage = (score / 4) * 100;
              const color = score >= 3 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';

              return `
                <div>
                  <div style="font-size: 12px; margin-bottom: 5px; color: #374151; font-weight: 600;">
                    ${dist.name}: <strong style="color: ${color};">${dist.scoreF}</strong>
                  </div>
                  <div style="
                    width: 100%;
                    height: 12px;
                    background: #e5e7eb;
                    border-radius: 6px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                  ">
                    <div style="
                      width: ${percentage}%;
                      height: 100%;
                      background: ${color};
                      transition: width 0.3s;
                      box-shadow: 0 2px 4px ${color}40;
                    "></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Distribution Maths -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-calculator"></i> Distribution Maths
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${groupDistributions.map(dist => {
              const score = parseFloat(dist.scoreM);
              const percentage = (score / 4) * 100;
              const color = score >= 3 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';

              return `
                <div>
                  <div style="font-size: 12px; margin-bottom: 5px; color: #374151; font-weight: 600;">
                    ${dist.name}: <strong style="color: ${color};">${dist.scoreM}</strong>
                  </div>
                  <div style="
                    width: 100%;
                    height: 12px;
                    background: #e5e7eb;
                    border-radius: 6px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                  ">
                    <div style="
                      width: ${percentage}%;
                      height: 100%;
                      background: ${color};
                      transition: width 0.3s;
                      box-shadow: 0 2px 4px ${color}40;
                    "></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Moyennes critÃ¨res -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-chart-bar"></i> Moyennes des critÃ¨res
          </h4>
          <div style="
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.8;
          ">
            ${currentReg.groups.map(group => {
              const avgCOM = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.com) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgTRA = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.tra) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgPART = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.part) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgABS = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.abs) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';

              return `
                <div style="margin-bottom: 8px;">
                  <div style="font-weight: 600; color: #6366f1; margin-bottom: 4px;">
                    ${group.name}
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: #374151;">
                    <div>COM: ${avgCOM}</div>
                    <div>TRA: ${avgTRA}</div>
                    <div>PART: ${avgPART}</div>
                    <div>ABS: ${avgABS}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

      </div>
    `;
  }

  /**
   * Met Ã  jour le bandeau de comparaison des stats
   */
  function updateStatsComparison() {
    const content = document.getElementById('stats-comparison-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg || currentReg.groups.length === 0) {
      content.innerHTML = '<p style="color: #1f2937; font-size: 13px;">Aucune donnÃ©e</p>';
      return;
    }

    // Calculer les stats pour chaque groupe
    const groupStats = currentReg.groups.map(group => {
      const total = group.students.length;
      const girls = group.students.filter(s => s.sexe === 'F').length;
      const boys = total - girls;
      const parityRatio = total > 0 ? (girls / total * 100).toFixed(0) : 0;

      const avgScoreF = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreF) || 0), 0) / total).toFixed(2)
        : '0.00';
      const avgScoreM = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreM) || 0), 0) / total).toFixed(2)
        : '0.00';
      const avgCOM = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.com) || 0), 0) / total).toFixed(1)
        : '0.0';
      const avgTRA = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.tra) || 0), 0) / total).toFixed(1)
        : '0.0';

      return {
        name: group.name,
        total,
        girls,
        boys,
        parityRatio,
        avgScoreF,
        avgScoreM,
        avgCOM,
        avgTRA
      };
    });

    content.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        ${groupStats.map((stats, index) => {
          // Couleur de la paritÃ© (vert si 40-60%, orange si 30-70%, rouge sinon)
          const parityColor = (stats.parityRatio >= 40 && stats.parityRatio <= 60) ? '#10b981'
            : (stats.parityRatio >= 30 && stats.parityRatio <= 70) ? '#f59e0b'
            : '#ef4444';

          return `
            <div style="
              background: white;
              border: 2px solid #d1d5db;
              border-radius: 10px;
              padding: 14px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.2s;
            " onmouseover="this.style.borderColor='#6d28d9'; this.style.boxShadow='0 4px 12px rgba(109, 40, 217, 0.15)'" onmouseout="this.style.borderColor='#d1d5db'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div style="font-size: 15px; font-weight: 700; color: #6d28d9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.3px;">
                ${stats.name}
              </div>

              <!-- ParitÃ© -->
              <div style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
                padding: 6px;
                background: ${parityColor}15;
                border-left: 3px solid ${parityColor};
                border-radius: 4px;
              ">
                <i class="fas fa-balance-scale" style="color: ${parityColor};"></i>
                <span style="font-size: 13px; font-weight: 600; color: #374151;">
                  ${stats.girls}F / ${stats.boys}M
                </span>
                <span style="
                  margin-left: auto;
                  padding: 2px 6px;
                  background: ${parityColor};
                  color: white;
                  border-radius: 4px;
                  font-size: 11px;
                  font-weight: 600;
                ">
                  ${stats.parityRatio}%
                </span>
              </div>

              <!-- Scores -->
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <div style="
                  flex: 1;
                  padding: 8px;
                  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                  border-radius: 6px;
                  text-align: center;
                  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                ">
                  <div style="font-size: 10px; color: #dbeafe; font-weight: 600; letter-spacing: 0.5px;">FRANÃ‡AIS</div>
                  <div style="font-size: 16px; font-weight: 700; color: white; margin-top: 2px;">${stats.avgScoreF}</div>
                </div>
                <div style="
                  flex: 1;
                  padding: 8px;
                  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                  border-radius: 6px;
                  text-align: center;
                  box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                ">
                  <div style="font-size: 10px; color: #fef3c7; font-weight: 600; letter-spacing: 0.5px;">MATHS</div>
                  <div style="font-size: 16px; font-weight: 700; color: white; margin-top: 2px;">${stats.avgScoreM}</div>
                </div>
              </div>

              <!-- CritÃ¨res comportementaux -->
              <div style="
                display: flex;
                justify-content: space-around;
                padding: 6px;
                background: #f9fafb;
                border-radius: 4px;
                font-size: 11px;
                color: #374151;
              ">
                <div><strong>COM</strong> <strong style="font-weight: 700; color: #374151;">${stats.avgCOM}</strong></div>
                <div><strong>TRA</strong> <strong style="font-weight: 700; color: #374151;">${stats.avgTRA}</strong></div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  /**
   * Trie les Ã©lÃ¨ves d'un groupe selon un critÃ¨re
   */
  function sortGroupStudents(groupIndex, sortBy, direction = null) {
    const currentRegroupement = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    const group = currentRegroupement.groups[groupIndex];

    if (!group || !group.students) return;

    // DÃ©terminer la direction (si null, on utilise celle du state)
    const sortDir = direction || state.swapDashboard.sortState[sortBy] || 'desc';
    const multiplier = sortDir === 'asc' ? 1 : -1;

    group.students.sort((a, b) => {
      let result = 0;
      switch (sortBy) {
        case 'parity':
          // F avant M en asc, M avant F en desc
          if (a.sexe === 'F' && b.sexe === 'M') result = -1;
          else if (a.sexe === 'M' && b.sexe === 'F') result = 1;
          else result = 0;
          break;
        case 'scoreF':
          result = (a.scoreF || 0) - (b.scoreF || 0);
          break;
        case 'scoreM':
          result = (a.scoreM || 0) - (b.scoreM || 0);
          break;
        case 'com':
          result = (a.scores?.COM || 0) - (b.scores?.COM || 0);
          break;
        default:
          result = 0;
      }
      return result * multiplier;
    });

    // Re-render le regroupement
    renderCurrentRegroupement();
  }

  /**
   * Trie tous les groupes selon un critÃ¨re (avec toggle asc/desc)
   */
  function sortAllGroups(sortBy) {
    const currentRegroupement = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

    if (!currentRegroupement || !currentRegroupement.groups) return;

    // Toggle la direction : si le critÃ¨re est dÃ©jÃ  triÃ© en desc, passer en asc, sinon desc
    const currentDir = state.swapDashboard.sortState[sortBy] || 'desc';
    const newDir = currentDir === 'desc' ? 'asc' : 'desc';
    state.swapDashboard.sortState[sortBy] = newDir;

    // Trier tous les groupes avec la nouvelle direction
    currentRegroupement.groups.forEach((group, index) => {
      sortGroupStudents(index, sortBy, newDir);
    });

    // Mettre Ã  jour visuellement les boutons de tri
    updateSortButtons(sortBy, newDir);
  }

  /**
   * Met Ã  jour l'apparence des boutons de tri
   */
  function updateSortButtons(activeSortBy, direction) {
    const buttons = {
      'parity': document.getElementById('btn-sort-parity'),
      'scoreF': document.getElementById('btn-sort-scoreF'),
      'scoreM': document.getElementById('btn-sort-scoreM'),
      'com': document.getElementById('btn-sort-com')
    };

    // RÃ©initialiser tous les boutons
    Object.entries(buttons).forEach(([sortBy, btn]) => {
      if (!btn) return;

      if (sortBy === activeSortBy) {
        // Bouton actif : fond blanc + icÃ´ne de direction
        btn.style.background = 'rgba(255, 255, 255, 0.95)';
        btn.style.color = '#6366f1';
        btn.style.fontWeight = '700';
        btn.style.borderColor = 'rgba(255, 255, 255, 0.9)';

        // Ajouter icÃ´ne de direction
        const icon = direction === 'asc' ? 'â†‘' : 'â†“';
        const text = btn.textContent.replace(/[â†‘â†“]/g, '').trim();
        btn.textContent = `${text} ${icon}`;
      } else {
        // Bouton inactif
        btn.style.background = 'rgba(255, 255, 255, 0.15)';
        btn.style.color = 'white';
        btn.style.fontWeight = '600';
        btn.style.borderColor = 'rgba(255, 255, 255, 0.3)';

        // Retirer icÃ´ne
        const text = btn.textContent.replace(/[â†‘â†“]/g, '').trim();
        btn.textContent = text;
      }
    });
  }

  /**
   * Exporte les groupes en PDF (via impression navigateur)
   */
  function exportToPDF() {
    const currentRegroupement = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

    if (!currentRegroupement) {
      GroupsNotifications.warning('Export impossible', 'Aucun regroupement Ã  exporter');
      return;
    }

    // CrÃ©er une fenÃªtre d'impression avec le contenu formatÃ©
    const printWindow = window.open('', '_blank');
    const content = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Groupes - ${currentRegroupement.name}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          h1 { color: #333; }
          .group { margin-bottom: 30px; page-break-inside: avoid; }
          .group-header { background: #4A90E2; color: white; padding: 10px; font-weight: bold; }
          .student { padding: 8px; border-bottom: 1px solid #ddd; }
          .student:nth-child(even) { background: #f9f9f9; }
          table { width: 100%; border-collapse: collapse; }
          th, td { text-align: left; padding: 8px; }
        </style>
      </head>
      <body>
        <h1>${currentRegroupement.name}</h1>
        <p><strong>Classes:</strong> ${currentRegroupement.classes && Array.isArray(currentRegroupement.classes) ? currentRegroupement.classes.join(', ') : 'Non spÃ©cifiÃ©'}</p>
        <p><strong>Mode:</strong> ${state.groupsGeneration.mode === 'heterogeneous' ? 'HÃ©tÃ©rogÃ¨ne' : 'HomogÃ¨ne'}</p>
        <p><strong>ScÃ©nario:</strong> ${state.groupsGeneration.scenario}</p>
        <hr>
        ${currentRegroupement.groups.map((group, idx) => `
          <div class="group">
            <div class="group-header">Groupe ${idx + 1} (${group.students.length} Ã©lÃ¨ves)</div>
            <table>
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>PrÃ©nom</th>
                  <th>Classe</th>
                  <th>Source</th>
                  <th>Sexe</th>
                  <th>Score F</th>
                  <th>Score M</th>
                  <th>COM</th>
                  <th>TRA</th>
                  <th>PART</th>
                  <th>ABS</th>
                </tr>
              </thead>
              <tbody>
                ${group.students.map(s => `
                  <tr>
                    <td>${s.lastName || s.nom || ''}</td>
                    <td>${s.firstName || s.prenom || ''}</td>
                    <td>${s.class || s.classe || ''}</td>
                    <td>${s.SOURCE || s.source || s.class || ''}</td>
                    <td>${s.sexe || ''}</td>
                    <td>${s.scoreF?.toFixed(1) || '-'}</td>
                    <td>${s.scoreM?.toFixed(1) || '-'}</td>
                    <td>${s.com?.toFixed(1) || s.scores?.COM?.toFixed(1) || '-'}</td>
                    <td>${s.tra?.toFixed(1) || s.scores?.TRA?.toFixed(1) || '-'}</td>
                    <td>${s.part?.toFixed(1) || s.scores?.PART?.toFixed(1) || '-'}</td>
                    <td>${s.abs?.toFixed(1) || s.scores?.ABS?.toFixed(1) || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `).join('')}
      </body>
      </html>
    `;

    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();

    // Lancer l'impression aprÃ¨s le chargement
    setTimeout(() => {
      printWindow.print();
    }, 250);
  }

  /**
   * Exporte les groupes en CSV
   */
  function exportToCSV() {
    const currentRegroupement = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

    if (!currentRegroupement) {
      GroupsNotifications.warning('Export impossible', 'Aucun regroupement Ã  exporter');
      return;
    }

    // CrÃ©er le CSV
    let csv = 'Groupe,Nom,PrÃ©nom,Classe,Source,Sexe,Score F,Score M,COM,TRA,PART,ABS,LV2,Options\n';

    currentRegroupement.groups.forEach((group, groupIdx) => {
      group.students.forEach(student => {
        const row = [
          `Groupe ${groupIdx + 1}`,
          student.lastName || student.nom || '',
          student.firstName || student.prenom || '',
          student.class || student.classe || '',
          student.SOURCE || student.source || student.class || '',
          student.sexe || '',
          student.scoreF?.toFixed(2) || '0',
          student.scoreM?.toFixed(2) || '0',
          student.com?.toFixed(2) || student.scores?.COM?.toFixed(2) || '0',
          student.tra?.toFixed(2) || student.scores?.TRA?.toFixed(2) || '0',
          student.part?.toFixed(2) || student.scores?.PART?.toFixed(2) || '0',
          student.abs?.toFixed(2) || student.scores?.ABS?.toFixed(2) || '0',
          student.lv2 || '',
          Array.isArray(student.options) ? student.options.join(';') : ''
        ];
        csv += row.map(field => `"${field}"`).join(',') + '\n';
      });
    });

    // CrÃ©er le fichier et dÃ©clencher le tÃ©lÃ©chargement
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `groupes_${currentRegroupement.name.replace(/\s+/g, '_')}_${Date.now()}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  /**
   * Mode "Focus Ã©lÃ¨ve" - Modal de comparaison
   */
  let focusedStudents = []; // [student1, student2]

  function openStudentFocusModal(student, groupName) {
    // Ajouter l'Ã©lÃ¨ve Ã  la sÃ©lection
    const existing = focusedStudents.findIndex(s => s.id === student.id);
    if (existing >= 0) {
      // DÃ©jÃ  sÃ©lectionnÃ©, le retirer
      focusedStudents.splice(existing, 1);
    } else {
      focusedStudents.push({ ...student, groupName });
      // Limiter Ã  2 Ã©lÃ¨ves
      if (focusedStudents.length > 2) {
        focusedStudents.shift(); // Retirer le premier
      }
    }

    // Si 2 Ã©lÃ¨ves sÃ©lectionnÃ©s, afficher la modal de comparaison
    if (focusedStudents.length === 2) {
      displayComparisonModal(focusedStudents[0], focusedStudents[1]);
    }
  }

  function displayComparisonModal(student1, student2) {
    // Supprimer l'ancienne modal si existe
    const oldModal = document.getElementById('student-comparison-modal');
    if (oldModal) oldModal.remove();

    const modal = document.createElement('div');
    modal.id = 'student-comparison-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10002;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    `;
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-labelledby', 'comparison-title');

    // Helper pour rendre un badge colorÃ© de critÃ¨re
    const renderCriteriaBadge = (label, value, color, icon) => {
      // DÃ©terminer l'intensitÃ© de la couleur selon la valeur (0-4)
      const opacity = Math.max(0.3, Math.min(1, value / 4));
      const bgColor = `${color}${Math.round(opacity * 20).toString(16).padStart(2, '0')}`;

      return `
        <div style="
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 8px 10px;
          background: ${bgColor};
          border-radius: 6px;
          border: 1px solid ${color}40;
        ">
          <span style="font-size: 14px;">${icon}</span>
          <div style="flex: 1;">
            <div style="font-size: 9px; font-weight: 600; color: ${color}; text-transform: uppercase; opacity: 0.8;">
              ${label}
            </div>
            <div style="font-size: 16px; font-weight: 800; color: ${color};">
              ${value.toFixed(1)}
            </div>
          </div>
        </div>
      `;
    };

    const renderStudentCard = (student, index) => {
      return `
        <div style="
          flex: 1;
          padding: 24px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        ">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="
              font-size: 48px;
              color: ${student.sexe === 'F' ? '#ec4899' : '#3b82f6'};
              margin-bottom: 8px;
            ">
              <i class="fas fa-user-circle"></i>
            </div>
            <h3 style="
              font-size: 18px;
              font-weight: 800;
              color: #1f2937;
              margin: 0 0 8px 0;
            ">${student.lastName} ${student.firstName}</h3>
            <div style="
              font-size: 12px;
              color: #6b7280;
              background: #f3f4f6;
              padding: 4px 12px;
              border-radius: 4px;
              display: inline-block;
            ">${student.groupName || 'Groupe'} â€¢ ${student.class || ''}${state.swapDashboard.showSourceClass && (student.SOURCE || student.source) ? ' â€¢ Source: ' + (student.SOURCE || student.source) : ''}</div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Scores acadÃ©miques -->
            <div style="
              padding: 12px;
              background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
              border-radius: 8px;
              border-left: 4px solid #a855f7;
            ">
              <div style="font-size: 12px; font-weight: 700; color: #7e22ce; margin-bottom: 8px;">
                ğŸ“š Scores acadÃ©miques
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                  <div style="font-size: 10px; color: #6b7280;">FranÃ§ais</div>
                  <div style="font-size: 20px; font-weight: 800; color: #7c3aed;">${(student.scoreF || 0).toFixed(1)}</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                  <div style="font-size: 10px; color: #6b7280;">Maths</div>
                  <div style="font-size: 20px; font-weight: 800; color: #4f46e5;">${(student.scoreM || 0).toFixed(1)}</div>
                </div>
              </div>
            </div>

            <!-- CritÃ¨res comportementaux -->
            <div style="
              padding: 12px;
              background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
              border-radius: 8px;
              border-left: 4px solid #3b82f6;
            ">
              <div style="font-size: 12px; font-weight: 700; color: #1e40af; margin-bottom: 8px;">
                ğŸ¯ Comportement
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                ${renderCriteriaBadge('COM', student.com || 0, '#10b981', 'ğŸ’¬')}
                ${renderCriteriaBadge('TRA', student.tra || 0, '#f59e0b', 'ğŸ“')}
                ${renderCriteriaBadge('PART', student.part || 0, '#8b5cf6', 'ğŸ™‹')}
                ${renderCriteriaBadge('ABS', student.abs || 0, '#ef4444', 'â°')}
              </div>
            </div>
          </div>
        </div>
      `;
    };

    modal.innerHTML = `
      <div style="
        max-width: 900px;
        width: 90%;
        padding: 32px;
        background: #f9fafb;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
      " role="document">
        <button id="close-comparison-modal" style="
          position: absolute;
          top: 16px;
          right: 16px;
          background: #ef4444;
          color: white;
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          cursor: pointer;
          font-size: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
          transition: all 0.2s;
        " aria-label="Fermer la comparaison">
          <i class="fas fa-times"></i>
        </button>

        <h2 id="comparison-title" style="
          font-size: 24px;
          font-weight: 800;
          color: #1f2937;
          margin: 0 0 24px 0;
          text-align: center;
        ">
          <i class="fas fa-balance-scale"></i> Comparaison d'Ã©lÃ¨ves
        </h2>

        <div style="display: flex; gap: 24px;">
          ${renderStudentCard(student1, 0)}
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
          ">
            <div style="
              width: 3px;
              height: 100%;
              background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
              border-radius: 2px;
            "></div>
          </div>
          ${renderStudentCard(student2, 1)}
        </div>

        <div style="
          margin-top: 24px;
          text-align: center;
          font-size: 12px;
          color: #6b7280;
        ">
          Cliquez sur d'autres Ã©lÃ¨ves pour changer la comparaison
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Event listener fermeture
    const closeBtn = modal.querySelector('#close-comparison-modal');
    closeBtn.addEventListener('click', () => {
      modal.remove();
      focusedStudents = [];
    });

    // Fermer en cliquant en dehors
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
        focusedStudents = [];
      }
    });
  }

  /**
   * Ouvre le modal des paramÃ¨tres de lisibilitÃ© depuis l'interface SWAP
   */
  function openSettingsModal() {
    // CrÃ©er le modal
    const modal = document.createElement('div');
    modal.id = 'settings-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10002;
      backdrop-filter: blur(4px);
    `;

    modal.innerHTML = `
      <div style="
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">
            <i class="fas fa-cog"></i> ParamÃ¨tres
          </h2>
          <button id="close-settings-modal" style="
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            transition: all 0.2s;
          " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- SECTION : Affichage -->
        <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="font-size: 13px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
            <i class="fas fa-desktop"></i> Affichage
          </h3>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" id="modal-toggle-header" ${state.swapDashboard.headerVisible ? 'checked' : ''} style="cursor: pointer; width: 18px; height: 18px;">
              <span style="font-weight: 500;">Afficher le header (navigation, stats, etc.)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" id="modal-toggle-compact-header" ${state.swapDashboard.groupHeaderCompact ? 'checked' : ''} style="cursor: pointer; width: 18px; height: 18px;">
              <span style="font-weight: 500;">Mode compact pour les en-tÃªtes de groupes</span>
            </label>
          </div>
        </div>

        <!-- SECTION : LisibilitÃ© -->
        <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="font-size: 13px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
            <i class="fas fa-eye"></i> LisibilitÃ©
          </h3>

        <!-- Checkboxes d'affichage -->
        <div style="margin-bottom: 24px;">
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" id="modal-toggle-scores-v4" checked style="cursor: pointer; width: 18px; height: 18px;">
              <span style="font-weight: 500;">Afficher les pastilles COM/TRA/PART/ABS</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" id="modal-toggle-fmscores-v4" checked style="cursor: pointer; width: 18px; height: 18px;">
              <span style="font-weight: 500;">Afficher les scores F:/M:</span>
            </label>
          </div>
        </div>

        <!-- Taille des cartes -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; display: block; letter-spacing: 0.5px;">Taille des cartes</label>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label class="modal-size-option-label" data-size="small" style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 14px;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
            " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
              <span style="font-size: 11px; font-weight: 600; color: #6b7280;">S</span>
              <span style="font-size: 10px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
              <input type="radio" name="modalCardSize" value="small" style="cursor: pointer; width: 18px; height: 18px;">
            </label>
            <label class="modal-size-option-label active" data-size="medium" style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 14px;
              border: 2px solid #6366f1;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: #eef2ff;
            ">
              <span style="font-size: 12px; font-weight: 600; color: #6b7280;">M</span>
              <span style="font-size: 12px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
              <input type="radio" name="modalCardSize" value="medium" checked style="cursor: pointer; width: 18px; height: 18px;">
            </label>
            <label class="modal-size-option-label" data-size="large" style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 14px;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
            " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
              <span style="font-size: 13px; font-weight: 600; color: #6b7280;">L</span>
              <span style="font-size: 14px; font-weight: 700; color: #1f2937;">DUPONT LÃ©a</span>
              <input type="radio" name="modalCardSize" value="large" style="cursor: pointer; width: 18px; height: 18px;">
            </label>
            <label class="modal-size-option-label" data-size="xlarge" style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 14px;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
            " onmouseover="this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
              <span style="font-size: 14px; font-weight: 600; color: #6b7280;">XL</span>
              <span style="font-size: 16px; font-weight: 800; color: #1f2937;">DUPONT LÃ©a</span>
              <input type="radio" name="modalCardSize" value="xlarge" style="cursor: pointer; width: 18px; height: 18px;">
            </label>
          </div>
        </div>

        <!-- Style -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; display: block; letter-spacing: 0.5px;">Style</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <label class="modal-style-option-label active" data-style="normal" style="
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 10px 14px;
              border: 2px solid #6366f1;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: #eef2ff;
            ">
              <input type="radio" name="modalCardStyle" value="normal" checked style="display: none;">
              <span style="font-size: 13px; font-weight: 600; color: #4f46e5;">Normal</span>
            </label>
            <label class="modal-style-option-label" data-style="bold" style="
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 10px 14px;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
            " onmouseover="if(!this.classList.contains('active')) this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
              <input type="radio" name="modalCardStyle" value="bold" style="display: none;">
              <span style="font-size: 13px; font-weight: 600;">Gras</span>
            </label>
            <label class="modal-style-option-label" data-style="highlight" style="
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 10px 14px;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
            " onmouseover="if(!this.classList.contains('active')) this.style.background='#f9fafb'" onmouseout="if(!this.classList.contains('active')) this.style.background='white'">
              <input type="radio" name="modalCardStyle" value="highlight" style="display: none;">
              <span style="font-size: 13px; font-weight: 600;">SurlignÃ©</span>
            </label>
          </div>
        </div>
        </div>

        <!-- SECTION : PondÃ©rations des critÃ¨res (JOYSTICK) -->
        <div id="joystick-section" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
          <h3 style="font-size: 13px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
            <i class="fas fa-sliders-h"></i> PondÃ©rations des critÃ¨res
          </h3>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">
            Ajustez l'importance de chaque critÃ¨re pour la gÃ©nÃ©ration des groupes. Ces pondÃ©rations seront utilisÃ©es lors de la prochaine gÃ©nÃ©ration.
          </p>
          <div id="joystick-container"></div>
        </div>

        <!-- SECTION : Actions (RÃ©gÃ©nÃ©ration + Historique) -->
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 13px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
            <i class="fas fa-bolt"></i> Actions
          </h3>

          <!-- Bouton RÃ©gÃ©nÃ©rer (activÃ©) -->
          <button id="btn-regenerate-modal" style="
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.2s;
            margin-bottom: 12px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
            <i class="fas fa-sync-alt"></i>
            <span>RÃ©gÃ©nÃ©rer avec pondÃ©rations actuelles</span>
          </button>

          <!-- Boutons UNDO/REDO -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button id="btn-undo-modal" disabled style="
              padding: 10px 12px;
              background: #f3f4f6;
              color: #6b7280;
              border: 2px solid #e5e7eb;
              border-radius: 6px;
              cursor: not-allowed;
              font-size: 13px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
              opacity: 0.5;
              transition: all 0.2s;
            ">
              <i class="fas fa-undo"></i>
              <span>Annuler</span>
            </button>

            <button id="btn-redo-modal" disabled style="
              padding: 10px 12px;
              background: #f3f4f6;
              color: #6b7280;
              border: 2px solid #e5e7eb;
              border-radius: 6px;
              cursor: not-allowed;
              font-size: 13px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
              opacity: 0.5;
              transition: all 0.2s;
            ">
              <i class="fas fa-redo"></i>
              <span>RÃ©tablir</span>
            </button>
          </div>

          <!-- Info historique -->
          <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0; text-align: center;">
            <i class="fas fa-info-circle"></i> L'historique conserve les 10 derniÃ¨res gÃ©nÃ©rations
          </p>
        </div>

        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <p style="font-size: 12px; color: #6b7280; margin: 0;">
            <i class="fas fa-info-circle"></i> Les prÃ©fÃ©rences sont sauvegardÃ©es automatiquement
          </p>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Initialiser les contrÃ´les du modal
    initModalSettingsControls(modal);

    // Fermer le modal en cliquant sur le fond
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });

    // Fermer avec le bouton X
    modal.querySelector('#close-settings-modal').addEventListener('click', () => {
      modal.remove();
    });
  }

  /**
   * Initialise tous les contrÃ´les du modal de paramÃ¨tres
   */
  function initModalSettingsControls(modal) {
    // === AFFICHAGE ===
    const toggleHeaderCheckbox = modal.querySelector('#modal-toggle-header');
    if (toggleHeaderCheckbox) {
      toggleHeaderCheckbox.addEventListener('change', (e) => {
        state.swapDashboard.headerVisible = e.target.checked;
        const header = document.getElementById('swap-dashboard-header');
        if (header) {
          header.style.display = e.target.checked ? 'flex' : 'none';
        }
        // Mettre Ã  jour l'icÃ´ne du bouton toggle
        const toggleBtn = document.getElementById('btn-toggle-header');
        if (toggleBtn) {
          toggleBtn.innerHTML = e.target.checked
            ? '<i class="fas fa-chevron-up"></i>'
            : '<i class="fas fa-chevron-down"></i>';
        }
      });
    }

    const toggleCompactHeaderCheckbox = modal.querySelector('#modal-toggle-compact-header');
    if (toggleCompactHeaderCheckbox) {
      toggleCompactHeaderCheckbox.addEventListener('change', (e) => {
        state.swapDashboard.groupHeaderCompact = e.target.checked;
        // Re-render les groupes pour appliquer le mode compact
        renderCurrentRegroupement();
      });
    }

    // === JOYSTICK (PONDÃ‰RATIONS) ===
    const joystickContainer = modal.querySelector('#joystick-container');
    if (joystickContainer) {
      // RÃ©cupÃ©rer les pondÃ©rations actuelles ou utiliser les valeurs par dÃ©faut
      const currentWeights = getActiveCriteriaWeights();

      // CrÃ©er le joystick
      const joystick = JoystickController.create(currentWeights, (newWeights) => {
        const sanitized = sanitizeCriteriaWeights(newWeights);
        state.groupsGeneration.criteriaWeights = sanitized;
        state.groupsGeneration.criteriaWeightsSource = 'joystick';
        state.groupsGeneration.criteriaWeightsUpdatedAt = new Date().toISOString();

        console.log('âœ… PondÃ©rations mises Ã  jour:', sanitized);
        GroupsNotifications.info('PondÃ©rations modifiÃ©es', 'Les nouvelles pondÃ©rations seront utilisÃ©es lors de la prochaine gÃ©nÃ©ration.');
      });

      joystickContainer.appendChild(joystick);
    }

    // === LISIBILITÃ‰ ===
    // Charger les prÃ©fÃ©rences sauvegardÃ©es
    const savedPrefs = JSON.parse(localStorage.getItem('groups-readability-prefs') || '{}');
    const prefs = {
      showPastilles: savedPrefs.showPastilles !== false,
      showFMScores: savedPrefs.showFMScores !== false,
      cardSize: savedPrefs.cardSize || 'medium',
      cardStyle: savedPrefs.cardStyle || 'normal'
    };

    // Checkboxes
    const togglePastilles = modal.querySelector('#modal-toggle-scores-v4');
    const toggleFMScores = modal.querySelector('#modal-toggle-fmscores-v4');

    togglePastilles.checked = prefs.showPastilles;
    toggleFMScores.checked = prefs.showFMScores;

    togglePastilles.addEventListener('change', (e) => {
      prefs.showPastilles = e.target.checked;
      applyPastillesVisibility(prefs.showPastilles);
      localStorage.setItem('groups-readability-prefs', JSON.stringify(prefs));
    });

    toggleFMScores.addEventListener('change', (e) => {
      prefs.showFMScores = e.target.checked;
      applyFMScoresVisibility(prefs.showFMScores);
      localStorage.setItem('groups-readability-prefs', JSON.stringify(prefs));
    });

    // Taille
    const sizeLabels = modal.querySelectorAll('.modal-size-option-label');
    sizeLabels.forEach(label => {
      const size = label.dataset.size;
      const radio = label.querySelector('input[type="radio"]');

      if (size === prefs.cardSize) {
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        radio.checked = true;
      }

      label.addEventListener('click', () => {
        sizeLabels.forEach(l => {
          l.classList.remove('active');
          l.style.border = '1px solid #e5e7eb';
          l.style.background = 'white';
        });
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        radio.checked = true;
        prefs.cardSize = size;
        applyCardSize(size);
        localStorage.setItem('groups-readability-prefs', JSON.stringify(prefs));
      });
    });

    // Style
    const styleLabels = modal.querySelectorAll('.modal-style-option-label');
    styleLabels.forEach(label => {
      const style = label.dataset.style;
      const radio = label.querySelector('input[type="radio"]');

      if (style === prefs.cardStyle) {
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        const span = label.querySelector('span');
        if (span) span.style.color = '#4f46e5';
        radio.checked = true;
      }

      label.addEventListener('click', () => {
        styleLabels.forEach(l => {
          l.classList.remove('active');
          l.style.border = '1px solid #e5e7eb';
          l.style.background = 'white';
          const span = l.querySelector('span');
          if (span) span.style.color = '';
        });
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        const span = label.querySelector('span');
        if (span) span.style.color = '#4f46e5';
        radio.checked = true;
        prefs.cardStyle = style;
        applyCardStyle(style);
        localStorage.setItem('groups-readability-prefs', JSON.stringify(prefs));
      });
    });

    // === ACTIONS (RÃ©gÃ©nÃ©ration + Historique) ===

    // Bouton RÃ©gÃ©nÃ©rer
    const regenerateBtn = modal.querySelector('#btn-regenerate-modal');
    if (regenerateBtn) {
      regenerateBtn.addEventListener('click', async () => {
        console.log('ğŸ”„ Bouton RÃ©gÃ©nÃ©rer cliquÃ©');
        await regenerateCurrentRegroupement();
      });
    }

    // Bouton UNDO
    const undoBtn = modal.querySelector('#btn-undo-modal');
    if (undoBtn) {
      undoBtn.addEventListener('click', () => {
        console.log('â†¶ Bouton UNDO cliquÃ©');
        undoRegeneration();
      });
    }

    // Bouton REDO
    const redoBtn = modal.querySelector('#btn-redo-modal');
    if (redoBtn) {
      redoBtn.addEventListener('click', () => {
        console.log('â†· Bouton REDO cliquÃ©');
        redoRegeneration();
      });
    }

    // Initialiser l'Ã©tat des boutons UNDO/REDO
    updateHistoryButtons();
  }

  /**
   * Attache les Ã©vÃ©nements au dashboard
   */
  function attachDashboardEvents() {
    // Fermer
    const closeBtn = document.getElementById('close-dashboard');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        document.getElementById('swap-dashboard').remove();
      });
    }

    // Toggle header
    const toggleHeaderBtn = document.getElementById('btn-toggle-header');
    if (toggleHeaderBtn) {
      toggleHeaderBtn.addEventListener('click', toggleHeader);
    }

    // Bouton ParamÃ¨tres
    const openSettingsBtn = document.getElementById('btn-open-settings');
    if (openSettingsBtn) {
      openSettingsBtn.addEventListener('click', openSettingsModal);
    }

    // Bouton Statistiques
    const openStatsBtn = document.getElementById('btn-open-stats');
    if (openStatsBtn) {
      openStatsBtn.addEventListener('click', toggleStatsPanel);
    }

    // Menu Export (dropdown)
    const exportMenuBtn = document.getElementById('btn-export-menu');
    const exportDropdown = document.getElementById('export-dropdown');
    if (exportMenuBtn && exportDropdown) {
      exportMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = exportDropdown.style.display === 'block';
        exportDropdown.style.display = isVisible ? 'none' : 'block';
      });

      // Fermer le dropdown en cliquant ailleurs
      document.addEventListener('click', (e) => {
        if (!exportMenuBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
          exportDropdown.style.display = 'none';
        }
      });
    }

    // Navigation regroupements
    const prevBtn = document.getElementById('btn-prev-regroupement');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => navigateRegroupement(-1));
    }

    const nextBtn = document.getElementById('btn-next-regroupement');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => navigateRegroupement(1));
    }

    // Toggle stats panel
    const statsBtn = document.getElementById('btn-toggle-stats');
    if (statsBtn) {
      statsBtn.addEventListener('click', toggleStatsPanel);
    }

    // Toggle sidebar
    const sidebarBtn = document.getElementById('btn-toggle-sidebar');
    if (sidebarBtn) {
      sidebarBtn.addEventListener('click', toggleSidebar);
    }

    // Toggle bandeau comparaison
    const comparisonBtn = document.getElementById('btn-toggle-comparison');
    if (comparisonBtn) {
      comparisonBtn.addEventListener('click', toggleComparisonBanner);
    }

    // Boutons sauvegardes
    document.getElementById('btn-load')?.addEventListener('click', loadGroups);
    document.getElementById('btn-save-temp')?.addEventListener('click', () => saveGroups(true));
    document.getElementById('btn-finalize')?.addEventListener('click', () => {
      if (confirm('Finaliser ces groupes ?\n\nLes onglets dÃ©finitifs seront crÃ©Ã©s (ex: 6Â°GrpB1, 6Â°GrpLV2...).\nLes onglets temporaires (TEMP) seront supprimÃ©s.')) {
        saveGroups(false);
      }
    });

    // Boutons exports (dans le dropdown)
    document.getElementById('btn-export-pdf')?.addEventListener('click', () => {
      exportToPDF();
      if (exportDropdown) exportDropdown.style.display = 'none';
    });
    document.getElementById('btn-export-csv')?.addEventListener('click', () => {
      exportToCSV();
      if (exportDropdown) exportDropdown.style.display = 'none';
    });

    // Boutons de tri
    document.getElementById('btn-sort-parity')?.addEventListener('click', () => sortAllGroups('parity'));
    document.getElementById('btn-sort-scoreF')?.addEventListener('click', () => sortAllGroups('scoreF'));
    document.getElementById('btn-sort-scoreM')?.addEventListener('click', () => sortAllGroups('scoreM'));
    document.getElementById('btn-sort-com')?.addEventListener('click', () => sortAllGroups('com'));

    // Toggle affichage classe SOURCE
    document.getElementById('toggle-show-source')?.addEventListener('change', (e) => {
      state.swapDashboard.showSourceClass = e.target.checked;
      renderCurrentRegroupement();
      console.log(`ğŸ‘ï¸ Affichage classe SOURCE: ${state.swapDashboard.showSourceClass ? 'activÃ©' : 'dÃ©sactivÃ©'}`);
    });
  }

  /**
   * Navigue entre les regroupements
   */
  function navigateRegroupement(direction) {
    const newIndex = state.swapDashboard.currentRegroupementIndex + direction;

    if (newIndex < 0 || newIndex >= state.swapDashboard.allRegroupements.length) {
      return; // Hors limites
    }

    state.swapDashboard.currentRegroupementIndex = newIndex;

    // Re-rendre tout
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();

    // Mettre Ã  jour les boutons de navigation
    const prevBtn = document.getElementById('btn-prev-regroupement');
    const nextBtn = document.getElementById('btn-next-regroupement');

    if (prevBtn) {
      prevBtn.disabled = newIndex === 0;
      prevBtn.style.opacity = newIndex === 0 ? '0.5' : '1';
      prevBtn.style.cursor = newIndex === 0 ? 'not-allowed' : 'pointer';
    }

    if (nextBtn) {
      nextBtn.disabled = newIndex === state.swapDashboard.allRegroupements.length - 1;
      nextBtn.style.opacity = newIndex === state.swapDashboard.allRegroupements.length - 1 ? '0.5' : '1';
      nextBtn.style.cursor = newIndex === state.swapDashboard.allRegroupements.length - 1 ? 'not-allowed' : 'pointer';
    }

    console.log(`ğŸ”„ Navigation: regroupement ${newIndex + 1} / ${state.swapDashboard.allRegroupements.length}`);
  }

  /**
   * Toggle du panneau statistiques
   */
  function toggleStatsPanel() {
    state.swapDashboard.statsVisible = !state.swapDashboard.statsVisible;

    const panel = document.getElementById('stats-panel');
    const btn = document.getElementById('btn-toggle-stats');

    if (panel) {
      panel.style.left = state.swapDashboard.statsVisible ? '0' : '-350px';
    }

    if (btn) {
      btn.style.background = state.swapDashboard.statsVisible
        ? '#3b82f6'
        : 'rgba(255, 255, 255, 0.2)';
    }
  }

  /**
   * Toggle du panneau latÃ©ral
   */
  function toggleSidebar() {
    state.swapDashboard.sidebarCollapsed = !state.swapDashboard.sidebarCollapsed;

    const panel = document.getElementById('sidebar-panel');
    const content = document.getElementById('sidebar-content');
    const btn = document.getElementById('btn-toggle-sidebar');

    if (panel) {
      panel.style.width = state.swapDashboard.sidebarCollapsed ? '60px' : '320px';
      panel.style.padding = state.swapDashboard.sidebarCollapsed ? '16px 8px' : '24px';
    }

    if (content) {
      content.style.display = state.swapDashboard.sidebarCollapsed ? 'none' : 'block';
    }

    if (btn) {
      btn.innerHTML = `<i class="fas fa-chevron-${state.swapDashboard.sidebarCollapsed ? 'left' : 'right'}"></i>`;
    }
  }

  /**
   * Toggle du bandeau de comparaison
   */
  function toggleComparisonBanner() {
    state.swapDashboard.comparisonVisible = !state.swapDashboard.comparisonVisible;

    const content = document.getElementById('stats-comparison-content');
    const btn = document.getElementById('btn-toggle-comparison');

    if (!content || !btn) return;

    if (state.swapDashboard.comparisonVisible) {
      // DÃ©plier
      content.style.display = 'block';
      btn.innerHTML = '<i class="fas fa-chevron-up"></i> RÃ©duire';
    } else {
      // RÃ©duire
      content.style.display = 'none';
      btn.innerHTML = '<i class="fas fa-chevron-down"></i> Afficher';
    }
  }

  /**
   * Toggle du header SWAP dashboard
   */
  function toggleHeader() {
    state.swapDashboard.headerVisible = !state.swapDashboard.headerVisible;

    const header = document.getElementById('swap-dashboard-header');
    const btn = document.getElementById('btn-toggle-header');

    if (header) {
      header.style.display = state.swapDashboard.headerVisible ? 'flex' : 'none';
    }

    if (btn) {
      btn.innerHTML = state.swapDashboard.headerVisible
        ? '<i class="fas fa-chevron-up"></i>'
        : '<i class="fas fa-chevron-down"></i>';
    }
  }

  /**
   * Affiche une erreur
   */
  function displayError(error) {
    GroupsNotifications.error('Erreur', error.message);
    addToTimeline(`Erreur : ${error.message}`, 'error');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTRÃ”LES DE LISIBILITÃ‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Initialiser les contrÃ´les de lisibilitÃ© (appelÃ© aprÃ¨s rendu)
   */
  function initLisibilityControls() {
    // Charger les prÃ©fÃ©rences sauvegardÃ©es
    const savedPrefs = JSON.parse(localStorage.getItem('groups-readability-prefs') || '{}');
    const prefs = {
      showPastilles: savedPrefs.showPastilles !== false, // true par dÃ©faut
      showFMScores: savedPrefs.showFMScores !== false,   // true par dÃ©faut
      cardSize: savedPrefs.cardSize || 'medium',
      cardStyle: savedPrefs.cardStyle || 'normal'
    };

    // Fonction pour sauvegarder les prÃ©fÃ©rences
    function savePreferences() {
      localStorage.setItem('groups-readability-prefs', JSON.stringify(prefs));
    }

    // Fonction pour appliquer toutes les prÃ©fÃ©rences
    function applyAllPreferences() {
      applyCardSize(prefs.cardSize);
      applyCardStyle(prefs.cardStyle);
      applyPastillesVisibility(prefs.showPastilles);
      applyFMScoresVisibility(prefs.showFMScores);
    }

    // Checkbox afficher/masquer pastilles COM/TRA/PART/ABS
    const toggleScoresCheckbox = document.getElementById('toggle-scores-v4');
    if (toggleScoresCheckbox) {
      toggleScoresCheckbox.checked = prefs.showPastilles;
      toggleScoresCheckbox.addEventListener('change', (e) => {
        prefs.showPastilles = e.target.checked;
        applyPastillesVisibility(prefs.showPastilles);
        savePreferences();
      });
    }

    // Checkbox afficher/masquer scores F:/M:
    const toggleFMScoresCheckbox = document.getElementById('toggle-fmscores-v4');
    if (toggleFMScoresCheckbox) {
      toggleFMScoresCheckbox.checked = prefs.showFMScores;
      toggleFMScoresCheckbox.addEventListener('change', (e) => {
        prefs.showFMScores = e.target.checked;
        applyFMScoresVisibility(prefs.showFMScores);
        savePreferences();
      });
    }

    // Radio buttons taille des cartes
    const sizeLabels = document.querySelectorAll('.size-option-label');
    sizeLabels.forEach(label => {
      const radio = label.querySelector('input[type="radio"]');
      const size = label.dataset.size;

      // Appliquer l'Ã©tat initial
      if (size === prefs.cardSize) {
        radio.checked = true;
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
      }

      label.addEventListener('click', () => {
        // DÃ©sactiver tous les labels
        sizeLabels.forEach(l => {
          l.classList.remove('active');
          l.style.border = '1px solid #e5e7eb';
          l.style.background = 'white';
        });

        // Activer le label cliquÃ©
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        radio.checked = true;

        // Appliquer la taille
        prefs.cardSize = size;
        applyCardSize(size);
        savePreferences();
      });
    });

    // Radio buttons style
    const styleLabels = document.querySelectorAll('.style-option-label');
    styleLabels.forEach(label => {
      const radio = label.querySelector('input[type="radio"]');
      const style = label.dataset.style;

      // Appliquer l'Ã©tat initial
      if (style === prefs.cardStyle) {
        radio.checked = true;
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        const span = label.querySelector('span');
        if (span) span.style.color = '#4f46e5';
      }

      label.addEventListener('click', () => {
        // DÃ©sactiver tous les labels
        styleLabels.forEach(l => {
          l.classList.remove('active');
          l.style.border = '1px solid #e5e7eb';
          l.style.background = 'white';
          const span = l.querySelector('span');
          if (span) span.style.color = '';
        });

        // Activer le label cliquÃ©
        label.classList.add('active');
        label.style.border = '2px solid #6366f1';
        label.style.background = '#eef2ff';
        const span = label.querySelector('span');
        if (span) span.style.color = '#4f46e5';
        radio.checked = true;

        // Appliquer le style
        prefs.cardStyle = style;
        applyCardStyle(style);
        savePreferences();
      });
    });

    // Bouton zoom global
    const btnZoom = document.getElementById('btn-zoom-v4');
    if (btnZoom) {
      let zoomActive = false;
      btnZoom.addEventListener('click', () => {
        zoomActive = !zoomActive;
        document.body.classList.toggle('zoom-cards-v4');

        // Mettre Ã  jour le bouton
        const icon = btnZoom.querySelector('i');
        const text = btnZoom.querySelector('span');
        if (zoomActive) {
          icon.className = 'fas fa-search-minus';
          text.textContent = 'DÃ©sactiver zoom';
          btnZoom.style.background = '#eef2ff';
          btnZoom.style.borderColor = '#6366f1';
        } else {
          icon.className = 'fas fa-search-plus';
          text.textContent = 'Mode zoom';
          btnZoom.style.background = '#f3f4f6';
          btnZoom.style.borderColor = '#d1d5db';
        }
      });
    }

    // Appliquer les prÃ©fÃ©rences au chargement
    applyAllPreferences();
  }

  /**
   * Applique la visibilitÃ© des pastilles COM/TRA/PART/ABS
   */
  function applyPastillesVisibility(show) {
    const scoreElements = document.querySelectorAll('.scores');
    scoreElements.forEach(el => {
      el.style.display = show ? 'flex' : 'none';
    });
  }

  /**
   * Applique la visibilitÃ© des scores F:/M:
   */
  function applyFMScoresVisibility(show) {
    const fmScoreElements = document.querySelectorAll('.fm-scores');
    fmScoreElements.forEach(el => {
      el.style.display = show ? 'inline' : 'none';
    });
  }

  /**
   * Applique la taille des cartes
   */
  function applyCardSize(size) {
    const allCards = document.querySelectorAll('.swap-student-card');
    allCards.forEach(card => {
      card.classList.remove('card-size-small', 'card-size-medium', 'card-size-large', 'card-size-xlarge');
      card.classList.add(`card-size-${size}`);
    });
  }

  /**
   * Applique le style des cartes
   */
  function applyCardStyle(style) {
    const allCards = document.querySelectorAll('.swap-student-card');
    allCards.forEach(card => {
      card.classList.remove('card-style-normal', 'card-style-bold', 'card-style-highlight');
      card.classList.add(`card-style-${style}`);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTRÃ”LES DES PARAMÃˆTRES (VOLET A)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Initialise les panneaux dÃ©pliants et le joystick du volet A (ParamÃ¨tres)
   */
  function initParametersControls() {
    console.log('ğŸ›ï¸ Initialisation des contrÃ´les des paramÃ¨tres...');

    // ========== PANNEAU DÃ‰PLIANT : PONDÃ‰RATIONS ==========
    const weightingHeader = document.getElementById('panel-weighting-header');
    const weightingContent = document.getElementById('panel-weighting-content');
    const weightingChevron = document.getElementById('panel-weighting-chevron');
    let weightingExpanded = true; // Ouvert par dÃ©faut

    if (weightingHeader && weightingContent && weightingChevron) {
      weightingHeader.addEventListener('click', () => {
        weightingExpanded = !weightingExpanded;

        if (weightingExpanded) {
          weightingContent.style.display = 'block';
          weightingChevron.style.transform = 'rotate(0deg)';
        } else {
          weightingContent.style.display = 'none';
          weightingChevron.style.transform = 'rotate(-90deg)';
        }
      });

      // Initialiser le joystick dans le volet A
      const joystickContainer = document.getElementById('joystick-container-volet-a');
      if (joystickContainer) {
        const currentWeights = state.groupsGeneration.criteriaWeights || { com: 1, tra: 1, part: 1, abs: 1 };

        const joystick = JoystickController.create(currentWeights, (newWeights) => {
          // Sauvegarder les nouvelles pondÃ©rations dans le state
          if (!state.groupsGeneration.criteriaWeights) {
            state.groupsGeneration.criteriaWeights = {};
          }
          state.groupsGeneration.criteriaWeights = { ...newWeights };

          console.log('âœ… PondÃ©rations mises Ã  jour (volet A):', newWeights);
          GroupsNotifications.info('PondÃ©rations modifiÃ©es', 'Les nouvelles pondÃ©rations seront utilisÃ©es lors de la prochaine gÃ©nÃ©ration.');
        });

        joystickContainer.appendChild(joystick);
        console.log('âœ… Joystick initialisÃ© dans le volet A');
      }
    }

    // ========== PANNEAU DÃ‰PLIANT : LISIBILITÃ‰ ==========
    const readabilityHeader = document.getElementById('panel-readability-header');
    const readabilityContent = document.getElementById('panel-readability-content');
    const readabilityChevron = document.getElementById('panel-readability-chevron');
    let readabilityExpanded = true; // Ouvert par dÃ©faut

    if (readabilityHeader && readabilityContent && readabilityChevron) {
      readabilityHeader.addEventListener('click', () => {
        readabilityExpanded = !readabilityExpanded;

        if (readabilityExpanded) {
          readabilityContent.style.display = 'block';
          readabilityChevron.style.transform = 'rotate(0deg)';
        } else {
          readabilityContent.style.display = 'none';
          readabilityChevron.style.transform = 'rotate(-90deg)';
        }
      });
    }

    console.log('âœ… ContrÃ´les des paramÃ¨tres initialisÃ©s');
  }

  // API publique
  return {
    renderInitialStructure,
    displayResults,
    displayError,
    initLisibilityControls,
    initParametersControls,
    state
  };
})();

// Export pour utilisation dans le module
if (typeof window !== 'undefined') {
  window.GroupsInterfaceV4 = GroupsInterfaceV4;
  console.log('âœ… GroupsInterfaceV4 chargÃ©');
}

})(); // Fin du DOM Environment Guard IIFE
</script>
